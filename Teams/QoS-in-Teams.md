---
title: "Microsoft Teams でのサービスの品質 (QoS)"
author: rmw2890
ms.author: MyAdvisor
manager: Serdars
ms.date: 02/16/2018
ms.topic: article
ms.service: msteams
description: "Microsoft Teams でのサービスの品質 (QoS) のために組織のネットワークを準備する"
MS.collection: Strat_MT_TeamsAdmin
ms.openlocfilehash: 61bebd64c7d1478c16e114631b696dee2bf59625
ms.sourcegitcommit: 85105cb4e42ae8eb6e7e76eaf6d4dd5b9568cf41
ms.translationtype: HT
ms.contentlocale: ja-JP
ms.lasthandoff: 02/19/2018
---
<a name="quality-of-service-qos-in-microsoft-teams"></a>Microsoft Teams でのサービスの品質 (QoS)
==========================================
このガイドでは、Teams でのサービスの品質 (QoS) のために組織のネットワークを準備する手順について説明します。


サービスの品質 (QoS) は、ネットワーク トラフィックの特定の種類を優先順位付けすることができるメカニズムです。 Teams などのリアルタイム通信サービスのトラフィックを優先順位付けすることは、ビジネス グレードのユーザー エクスペリエンスを実現するために重要です。 QoS が本当に効果を生じるようにするには、パス内に QoS をサポートできない部分があると、通話全体の品質が低下する可能性があるため、エンドツーエンド (クラウドへの PC、ネットワーク スイッチ、およびルーター) で QoS に対応した接続が構成されている必要があります。


![組織のネットワークと Office 365 サービスとの間の関係を示すダイアグラムのスクリーンショット。](media/Qos-in-Teams-Image1.png)

 

多くの場合、相互接続のネットワークは、管理下にないネットワークで、インターネット接続になります。 エンドツーエンドの QoS に対処するために利用できる 1 つのオプションは [ExpressRoute](https://azure.microsoft.com/documentation/articles/expressroute-introduction/) です。 QoS を自分たちによる制御が届くネットワークの部分に、すなわちオンプレミス ネットワークに実装することを推奨します。 これにより、展開全体にわたってリアルタイムの通信のワークロードの品質が向上し、既存の展開内のチョーク ポイントを軽減します。 

## <a name="objectives"></a>目的 

このガイドは、Teams のリアルタイム通信トラフィック、すなわち音声やビデオに対する優先順位を設定する方法に焦点をあてて説明します。 その他の種類のトラフィックもニーズに基づいて優先順位を設定することができます。

トラフィックの優先順位を設定する方法は複数ありますが、DSCP (Differentiated Services Code Point) のマーキングを使用する方法が最も一般的です。 このマーキングはポート範囲に基づいて適用されますが、グループ ポリシー オブジェクトを介しても適用されます。 このドキュメントでは、これらの両方について取り上げます。

グループ ポリシー オブジェクト (GPO) を介して DSCP マーキングを制御することにより、ドメイン参加のコンピューターが正しい設定を受け取り、それらの設定が管理者のみによって管理できるようになります。 

QoS が機能するのは、呼び出し先と呼び出し元を接続するすべてのリンクに実装した場合のみであることを理解することが重要です。 内部ネットワークで QoS を使用しているときにユーザーがリモートの場所からサインインする場合、管理された内部ネットワーク内でのみ優先順位付けをすることができます。 リモートの場所でも VPN を実装することによって管理された接続の受信ができますが、VPN 経由でリアルタイム通信のトラフィックを実行することは推奨されません。

> [!NOTE]
> 最大のユーザー エクスペリエンスを実現するために、リモート ユーザーに接続された VPN に対して分割トンネリングを実装することを推奨します 詳細については、「[Deploy-Guidance-VPN Split Tunnel (展開ガイダンス - VPN 分割トンネル)](https://myadvisor.fasttrack.microsoft.com/CloudVoice/Downloads?SelectedIDs=5_1_0_9 )」をご覧ください。

大陸間にまたがる管理されたリンクがあるグローバル組織では、QoS は帯域幅がローカル ネットワーク (LAN) と比較して制限的であるため、強く推奨されます。

## <a name="quality-of-service"></a>サービスの品質

ネットワーク上のアプリケーションに対して保証されたレベルのサービスを提供するために、基本となるネットワーク デバイスに異なる種類のトラフィックを分類する手段が存在する必要があります。 例として、音声に対して優れた処理がされることが求められている場合には、ルーターは音声トラフィックと通常の Web 閲覧トラフィックを区別できる必要があります。 

DiffServ (Differentiated Services) は、IPv4/IPv6 パケットのヘッダーのサービスの種類 (ToS) フィールドに基づく優先順位で、どのトラフィックがネットワーク デバイスによって処理されるかについてのフレームワークを提供します。 DiffServ フィールドのうち最も重要な 6 ビットは、DSCP (Differentiated Services Code Point) として知られています。 このフレームワークを使用すると、トラフィックが特定の種類のトラフィックの (音声) として分類され、マーキング (101110、または十進数で 46) されるようになり、それらのマーキングをネットワーク デバイスが処理することで、トラフィックはそれに従った優先順位 (この例では完全優先転送) が設定されます。

ネットワーク トラフィックがルーターに入ると、トラフィックはキューに配置されますが、設定されている QoS がない場合は、存在するキューは基本的に 1 つだけで、データは先入れ先出しで処理されます。このため、(遅延による影響を強く受けやすい) 音声トラフィックは、オンライン ストリーミング サービスからのトラフィックの背後でスタック状態になる可能性があります。 QoS を実装するときに、異なる輻輳管理機能 (Cisco のプライオリティ キューイング (PQ) およびクラスベースの重み付け均等化キューイング (CBWFQ) など) と輻輳回避機能 (重み付けランダム早期検出 (WRED) など) で、複数のキューを定義することができます。

![Teams の QoS キューを示す図のスクリーンショット。](media/Qos-in-Teams-Image2.png)

図 1: 視覚化された QoS キュー

これらの要素が配備されると、基本となる管理されたネットワークが、どのようにトラフィックを分類、マーキング、優先順位付けすればよいか理解できるようになるため、予測できる品質のサービスが提供できるようになります。 Teams の観点から、最も重要な構成項目は、パケットの分類とマーキングです。ただし、エンドツーエンドの QoS を正常に機能するようにするための基本となるネットワーク構成と、アプリケーションの構成を整合させるために、慎重な計画が必要になります。

## <a name="qos-scenarios"></a>QoS シナリオ

Teams のために QoS を実装する場合の、次の 4 つの開始シナリオについて説明します。

1.  Teams を展開済みまたは展開中で、ポート ベースのタグ付けを介した QoS の実装を計画しています。 ポート ベースのタグ付けは、すべてのプラットフォームにわたり一貫して機能するため最も信頼性の高い方法であるとともに、実装するのが最も簡単です。 

2.  Teams を展開済みまたは展開中で、グループ ポリシー オブジェクトのタグ付けを介した QoS の実装を計画しています。 これは、シナリオ 1 と組み合わせて使用される場合があります。 このシナリオは完全に有効であり、以下で説明されていますが、ドメイン参加の Windows クライアントに対してのみ機能することを理解することが重要です。 ドメイン参加のクライアントではないデバイスはすべて、QoS\DSCP のタグ付けに対して有効になりません。 

3.  Skype for Business Online を QoS のタグ付けとともに展開済みで、現在は Teams を展開中です。 この状況に該当する場合は、Teams は既存の構成を優先して、Skype for Business クライアントのものと同じポート範囲とタグ付けを使用します。 追加の構成は必要ありません。 
    > [!NOTE]
    > グループ ポリシーを介したアプリケーション名 QoS のタグ付けを使用している場合、“Teams.exe” をアプリケーション名として追加する必要があります。
4.  Teams を展開済みまたは展開中で、カスタム ポート範囲を備えたポート ベースのタグ付けを介して QoS を実装しようと考えています。

## <a name="recommended-differentiated-services-code-point-dscp-markings"></a>推奨される DSCP (Differentiated Services Code Point) のマーキング

最初の手順は、DSCP 値での、一意の重複しないポート範囲を利用したトラフィック フローの分類 (音声やビデオなど) です。 ここで割り当てられた DSCP 値により、(ネットワーク構成に基づいて) ネットワークを通過するトラフィックの優先順位が決められます。 各ワークロードは、独自の DSCP 値を取得します。一部の顧客において、同じ値を音声やビデオに設定している可能性がありますが、その場合に設定されるネットワーク内の優先順位は同じになります。 

どの DSCP 値を使用するかは、ワークロードの優先順位付けがどのようになっているかに依存します。 たとえば、ビジネスの要件により、アプリケーション共有をビデオと同じレベルの優先順位で取り扱うよう指示される可能性があります (さらにこれに関しては、ビデオと同じ DSCP 値でマーキングされます)。 その他の環境には、既存の QoS 戦略が配備済みである可能性があります。 

以下の表 1 には、Teams を ExpressRoute で利用する場合に必須となる DSCP マーキングが示されています。 これは自分の環境で何を使用するべきかがわからない顧客にとって便利な開始地点となります。 詳細については、「[ExpressRoute QoS の要件](https://docs.microsoft.com/azure/expressroute/expressroute-qos)」をご覧ください。


| クライアントの送信元ポート|プロトコル|メディアのカテゴリ|共通の DSCP 値|DSCP クラス|
|---------|---------|---------|---------|---------|
| 50,000 ～ 50,019|TCP/UDP|音声|46|完全優先転送 (EF)|
| 50,020 ～ 50,039|TCP/UDP|ビデオ|34|相対的優先転送 (AF41)|
| 50,040 ～ 50,059|TCP/UDP|アプリケーション/デスクトップ共有とファイル転送|18|クラス セレクター (CS3)|

表 1: DSCP マーキング

表 1 の情報を使用するときに理解する必要があるいくつかの注意事項を次に示します。

- ファイル共有とアプリケーション共有は、同じ送信元ポート範囲を使用しています。そのためポート ベースのタグ付けを使用するときには同じ DSCP マーキングを使用することになります。 これにより、*両方の*モダリティ (対話型または既定) にどの優先順位が該当するものか判別される必要があります。
    
- 将来的に ExpressRoute を実装する計画がある場合で、QoS がまだ実装されていない場合に推奨されるのは、上記の指示に従って DSCP 値が送信者と受信者で同じであるようにすることです。 
    
## <a name="source-ports-used-by-teams"></a>Teams によって使用されるソース ポート

Teams では、QoS は異なるワークロードで使用される送信元ポートに基づいて構成される必要があります。 サーバー側とクライアント側の両方のポート範囲はこの時点では構成可能ではありません。 

QoS を展開するには、関連付けられている QoS DSCP マーキングとともに、表 2 に示されているクライアントの送信元ポート範囲を使用します。

| クライアントの送信元ポート|プロトコル|メディアのカテゴリ|共通の DSCP 値|DSCP クラス|
|---------|---------|---------|---------|---------|
| 50,000 ～ 50,019|TCP/UDP|音声|46|完全優先転送 (EF)|
| 50,020 ～ 50,039|TCP/UDP|ビデオ|34|相対的優先転送 (AF41)|
| 50,040 ～ 50,059|TCP/UDP|アプリケーション/デスクトップ共有とファイル転送|18|クラス セレクター (CS3)|

表 2: クライアントの送信元ポートの範囲

> [!NOTE]
> 既に Skype for Business Online で送信元ポートの範囲に基づいて QoS を構成済みの場合、同じ構成が Teams に適用され、追加で変更を行う必要はありません。 Skype for Business Server (オンプレミス) を展開済みの場合は、QoS ポリシーを再設計する必要があります。

## <a name="setting-differentiated-services-code-point-dscp-markings"></a>DSCP (Differentiated Services Code Point) のマーキングの設定

トラフィックを分類するために適切な DSCP マーキングを設定するための手段は複数あります。

- エンドポイントでの DSCP マーキング: これはエンドポイント自体が適切なマーキングを提供するので、一般的に優先して使用されるオプションです。 現在、このオプションは GPO を使用することによって実行されますが、ドメイン参加の Windows クライアントでのみ可能です。 Mac OSX またはモバイル クライアントでは、トラフィックを DSCP 値でマーキングするメカニズムは利用できません。

- ルーターで ACL を使用するポート ベース: これは Windows と Mac の異種環境でよく見られる一般的なオプションです。 このシナリオでは、各モダリティで定義された送信元ポートの範囲に基づいて、ネットワーク チームがトラフィックを (通常はワイド エリア ネットワーク (WAN) 上の) イングレス/エグレス ルーターでマーキングします。 このオプションは異なるプラットフォームにわたって機能しますが、マーキングを行うのは WAN エッジにおいてのみで、クライアント マシンに到達するまでの経路全体ではなく、管理オーバーヘッドが発生します。
    
- クライアントでの DSCP マーキングと、ルーターでのポートベースの ACL の組み合わせ。
    
可能な場合は、これらの両方の組み合わせで、クライアントの大多数を捕らえるために GPO を使用すること、およびモバイル クライアント、Mac その他のクライアントが確実に (部分的な) QoS 処理を施されるようにするためにポート ベースの DSCP タグ付けも使用することを推奨します。

Teams クライアントでの事前設定された送信元ポート範囲に対する DSCP 値の設定は、グループ ポリシー内のポリシーベースの QoS を使用して行うことができます。 次の表で使用するポート範囲は、各ワークロードのポリシーを作成するための表で指定されたポート範囲です。

| クライアントのトラフィックの種類|ポート範囲の開始|ポート範囲の終了|DSCP 値|
|---------|---------|---------|--------|
| 音声|50000|50019|46|
| ビデオ|50020|50039|34|
| アプリケーション共有|50040|50059|18|
| ファイル転送|50040|50059|18|

表 3: トラフィックの種類ごとのポート範囲

注: Teams によって設定されたポート範囲は変更や改変をすることはできません。 最新の情報については、https://support.microsoft.com/ kb/2409256 で確認してください。

ポート範囲が決定したら、次の手順はグループ ポリシー オブジェクト (GPO) 内でポリシー ベースの QoS 設定を構成することです。 それらの手順の詳細については、[TechNet](https://technet.microsoft.com/library/jj205371(v=ocs.15).aspx) をご覧ください。 

作成した新しいポリシーは、グループ ポリシーがクライアント コンピューター上で更新されるまで有効になりません。 グループ ポリシーは定期的に自動更新されますが、グループ ポリシーを更新する必要がある各コンピューター上で次のコマンドを実行すると、即座に強制的に更新することができます。

        gpudate.exe /force

このコマンドは、管理者の資格情報のもとで実行されているコマンド ウィンドウから実行できます。 管理者の資格情報のもとでコマンド ウィンドウを開くには、[**スタート**] メニューをクリックし、[**コマンド プロンプト**] を右クリックして、[**管理者として実行**] をクリックします。

## <a name="verifying-the-dscp-markings-in-gpo"></a>GPO での DSCP マーキングの確認

GPO からの値が設定されていることを確認するには、次の手順を実行してください。

1.  gpresult を使用して、GPO からの設定がローカル PC で受け取られていることを確認します。 gpresult /R >gp.txt により、レポートが生成されて、gp.txt というテキスト ファイルに送信されます。

    ![gpresult コマンドを実行する管理者コマンド プロンプトのスクリーンショット。](media/Qos-in-Teams-Image3.png)

    図 2: Applied Group Policy Objects (適用されたグループ ポリシー オブジェクト) の確認
    > [!NOTE]
    > または、gpresult /H gp.html を実行して、同じデータをよりユーザー フレンドリな HTML レポートに生成することもできます。 
2.  生成されたファイルで Applied Group Policy Objects の見出しを探して、適用されたポリシーのリストに以前作成した GPO の名前があることを確認します。 

3.  レジストリ エディタを開いて、次に移動します。

    HKEY_LOCAL_MACHINE\Software\Policies\Microsoft\Windows\QoS\

    以下の表 3 に示されているレジストリ値を確認します。
    
    | 名前 | 種類 | データ|
    |---------|---------|---------
    | Application Name|REG_SZ|Teams.exe|
    | DSCP Value|REG_SZ|46|
    | Local IP|REG_SZ|*|
    | Local IP Prefix Length|REG_SZ|*|
    | Local Port|REG_SZ|50000-50019|
    | プロトコル|REG_SZ|*|
    | Remote IP|REG_SZ|*|
    | Remote Ip Prefix|REG_SZ|*|
    | Remote Port|REG_SZ|*|
    | Throttle Rate|REG_SZ|-1|
    
    表 3: QoS の Windows レジストリ値

4.  現在使用しているクライアントに対して Application Name が正しいことを確認し、DSCP Value と Local Port が GPO の設定を反映していることを確認します。

## <a name="validating-qos-analyzing-teams-traffic-on-the-network"></a>QoS の確認: ネットワーク上の Teams トラフィックの分析

GPO によって設定された DSCP 値は、QoS が効力を生じるようにするために、呼び出し先から呼び出し元に提示される必要があります。 Teams クライアントによって生成されたトラフィックを見ることによって、ネットワークを横断するときに DSCP が変更されていないか、またはストリップ化されていないかを確認することができます。 

望ましいのは、ネットワークのエグレス ポイントでトラフィックをキャプチャすることです。 ネットワーク上のトラフィックのキャプチャを支援するために、ポート ミラーリングをスイッチまたはルーターで使用できます。 

### <a name="looking-at-network-traffic-using-network-monitor"></a>ネットワーク モニターを使用してネットワーク トラフィックを見る

ネットワーク モニターはネットワーク トラフィックを分析するために Microsoft からダウンロードできるツールです。 [ネットワーク モニター 3.4](https://www.microsoft.com/download/4865) をダウンロードします。

ネットワーク モニターを実行している PC をポート ミラーリングが構成済みのポートに接続し、パケットのキャプチャを開始します。 Skype for Business クライアントを使用して通話を発信します。 通話を切る前に必ずメディアが確立されている状態にします。 通話を発信した PC の送信元 IP に一致する、キャプチャが作成した表示フィルターを停止し、DSCP 値 46 (16 進数で 0xb8) を検索条件として定義することによってフィルターを絞り込みます。

Source == "192.168.137.201" AND IPv4.DifferentiatedServicesField == 0xb8 

![適用するフィルターを示している、ネットワーク モニターの表示フィルター ダイアログ ボックスのスクリーンショット。](media/Qos-in-Teams-Image4.png)


[**Apply**] をクリックして、フィルターをアクティブ化します。 [**Frame Summary**] ウィンドウで、最初の UDP パケットを選択して [Frame Details] を表示します。

![DSCP 設定を強調表示している、ネットワーク モニターの [Frame Details] ダイアログ ボックスのスクリーンショット。](media/Qos-in-Teams-Image5.png)

IPv4 を展開して、DSCP 行の最後の値を見ます。 この例では、DSCP 値は 46 に設定されています。使用される送信元ポートが 50019 で、ワークロードが音声ということがわかりますので、この値は正しいことになります。 

GPO によってマーキングされている各ワークロードについて確認を繰り返します。 

> [!NOTE]
> マーキングがピアツーピアのトラフィックに対しても受け入れられることを確認します。 これは、2 つのクライアントにネットワーク モニターをインストールして、それら 2 つのクライアントの間で通話することによって実行できます。 クライアント間のメディアのトラフィック フローを、上記と同じ方法で確認します。

### <a name="sample-filters-to-use-for-network-monitor-or-wireshark"></a>ネットワーク モニターまたは Wireshark のために使用するフィルターの例

|使用方法  |フィルターの例  |
|---------|---------|
|音声 (注: 多重化はオフにする必要があります)     |   udp.port==3479 AND Ipv4.DifferentiatedServicesField.DSCP==46      |
|ビデオ     | udp.port==3480 AND Ipv4.DifferentiatedServicesField.DSCP==34        |
|画面共有     |  udp.port==3481 AND Ipv4.DifferentiatedServicesField.DSCP==18       |

### <a name="filter-media-traffic-from-microsoft-relays-requires-azure-expressroutehttpsazuremicrosoftcomservicesexpressroute"></a>フィルター: Microsoft リレーからのメディアのトラフィック ([Azure ExpressRoute](https://azure.microsoft.com/services/expressroute/) が必要です)

ip.src は {52.114.188.0/22 52.114.220.0/22 52.114.124.0/22 52.114.60.0/22} 、および (udp.srcport が {3479 3480 3481} または (udp.srcport ge 50000 と udp.srcport lt 60000))

### <a name="filter-media-traffic-to-microsoft-relays"></a>フィルター: Microsoft リレーへのメディアのトラフィック

ip.dst は {52.114.188.0/22 52.114.220.0/22 52.114.124.0/22 52.114.60.0/22} 、および (udp.dstport が {3479 3480 3481} または (udp.dstport ge 50000 と udp.dstport lt 60000))


Microsoft リレーからのトラフィック、および Microsoft リレーへのトラフィックを確認する必要があります。 次のセクションで示されるように、Wireshark の IP レイヤー上で DSCP マーキングをチェックすることができます。

### <a name="expected-dscp-markings"></a>必要とされる DSCP マーキング

オーディオ ストリーム: 46

ビデオ ストリーム: 34

データ ストリーム: 18

### <a name="filter-dscp-condition-to-network"></a>フィルター: ネットワークに対する DSCP 条件

ip.dsfield.dscp は {46 34 18}



### <a name="looking-at-network-traffic-using-wireshark"></a>Wireshark を使用したネットワーク トラフィックの確認

Wireshark、https://www.wireshark.org/、は強力なツールで、より詳細な分析のために、ネットワーク データをフィルターして記録することができます。 Wireshark を実行している PC をポート ミラーリングが構成済みのポートに接続し、パケットのキャプチャを開始します。 Teams クライアントを使用して通話を発信します。 通話を切る前に必ずメディアが確立されている状態にします。

パケット トレースを停止して、Teams クライアントがインストールされている PC の送信元 IP (例: *ip.src_host == 192.168.137.201*) のみを表示し、音声に対して指定されている範囲 50,000 ～ 50,019 から送信元ポートを使用するパッケージを検索するフィルターを作成します。

![フィルターが設定された Wireshark のスクリーンショット。](media/Qos-in-Teams-Image6.png)
 

パッケージをマーキングして、パケットの詳細ペインでインターネット プロトコル バージョン 4 (IPV4) のヘッダーを展開します。

![Differentiated Services Codepoint 設定が強調表示された Wireshark のスクリーンショット。](media/Qos-in-Teams-Image7.png)
 

*Differentiated Services Codepoint* の値が特定のワークロードの値 (この場合は音声の 46 (バイナリで 101110) という値) と一致することを確認します。

GPO によってマーキングされている各ワークロードについて確認を繰り返します。

> [!NOTE]
> マーキングがピアツーピアのトラフィックで受け入れられることを確認します。 これは、2 つのクライアントに WireShark またはネットワーク モニターをインストールして、それら 2 つのクライアントの間で通話することによって実行できます。 クライアント間のメディアのトラフィック フローを、上記と同じ方法で確認します。

## <a name="summary"></a>概要

サービスの品質は、Teams でビジネス クラスのエクスペリエンスを提供するための 1 つの重要な鍵となります。 ただし、QoS が効力を発揮するのは適切に管理されているネットワーク上のみであることを常に認識していることが重要です。 このようにすることで、展開チームがネットワーキング チームと緊密に連携して、確実に適切な情報がネットワーク レイヤーで渡され、理想的にはエンド ツー エンドで管理されるようにします。

