---
title: Microsoft Teams でサービスの品質 (QoS) を実施する
author: lanachin
ms.author: v-lanac
manager: Serdars
ms.date: 12/17/2018
ms.topic: article
ms.service: msteams
ms.reviewer: rowille
description: Microsoft Teams でのサービスの品質 (QoS) のために組織のネットワークを準備する
localization_priority: Normal
search.appverid: MET150
f1keywords: ms.teamsadmincenter.meetingsettings.qos
MS.collection:
- Teams_ITAdmin_PracticalGuidance
- M365-collaboration
appliesto:
- Microsoft Teams
ms.openlocfilehash: 0a3331537bf2966bbff70922611346cdc3603ae3
ms.sourcegitcommit: 208321bb45f7fb228757b9958a13f7e0bca91687
ms.translationtype: MT
ms.contentlocale: ja-JP
ms.lasthandoff: 06/25/2019
ms.locfileid: "35222039"
---
# <a name="implement-quality-of-service-qos-in-microsoft-teams"></a>Microsoft Teams でサービスの品質 (QoS) を実装する

この記事では、Microsoft Teams のサービス品質 (QoS) のために組織のネットワークを準備する方法について説明します。 大規模なユーザーグループをサポートしていて、次のいずれかの問題が発生している場合は、おそらく QoS を実装する必要があります。 ユーザー数の少ない小規模企業は、QoS を必要としない場合もありますが、役に立ちます。

QoS は、ネットワークの遅延に敏感なトラフィック (音声やビデオストリームなど) を使用して、機密度の低いトラフィック (新しいアプリのダウンロードなど) を実行することによって、(ダウンロードがあまり重要ではない) トラフィックを事前に行うことができます。 QoS は、リアルタイムストリーム内のすべてのパケット (Windows グループポリシーオブジェクトと、ポートベースのアクセス制御リストと呼ばれるルーティング機能を使用します) を識別してマークします。これにより、ネットワークで音声、ビデオ、画面の共有を行うことができます。ネットワーク帯域幅の専用部分。

QoS の形式がないと、音声とビデオで次の品質の問題が発生する可能性があります。

- ジッター–さまざまな料金で受信するメディアパケット。通話に単語または音節が含まれていない可能性があります。
- パケット損失–パケットが破棄されたため、音声品質が低下し、音声認識が困難になることもあります。
- 遅延ラウンドトリップ時間 (RTT) –時間がかかるメディアパケットによって、会話の2つの当事者間の間に顕著な遅延が発生し、他のユーザーが互いに話すことができます。

これらの問題に対処するための最も複雑な方法は、内部とインターネットの両方でデータ接続のサイズを大きくすることです。 多くの場合、QoS はコストがかかるため、新しいリソースを追加する代わりに、リソースをより効果的に管理する手段となります。 品質の問題を完全に解決するには、実装で QoS を使い、必要な場合にのみ接続を追加します。

Qos を有効にするには、qos の優先順位をサポートしていないパスの任意の部分によってパフォーマンスが低下する可能性があるため、一貫した QoS 設定をエンドツーエンドで適用する必要があります (これには、すべてのユーザーの Pc、ネットワークスイッチ、ルーターが含まれます)。通話、ビデオ、画面共有の品質。

_図1組織のネットワークと Office 365 サービスの間の関係_

![ネットワークとサービス間の関係を示す図](media/Qos-in-Teams-Image1.png "組織のネットワークと Office 365 サービスの間の関係: オンプレミスのネットワークとデバイスは、相互接続ネットワークに接続されます。これは、Office 365 クラウドの音声と電話会議サービスに接続します。")

ほとんどの場合、企業をクラウドに接続するネットワークは管理されていないネットワークとなり、QoS オプションを確実に設定することはできません。 エンドツーエンドの QoS に対応する選択肢の1つは[Azure ExpressRoute](https://azure.microsoft.com/documentation/articles/expressroute-introduction/)ですが、オンプレミスネットワークに qos を実装することをお勧めします。 これにより、展開中のリアルタイム通信の負荷が増大し、また、チョークのポイントが軽減されます。

## <a name="verify-your-network-is-ready"></a>ネットワークの準備ができていることを確認する

QoS の実装を検討している場合は、帯域幅要件とその他の[ネットワーク要件](prepare-network.md)を既に決定しておく必要があります。 
  
  ネットワーク全体でのトラフィック渋滞は、メディアの品質に大きく影響します。 帯域幅の不足は、パフォーマンスの低下を招き、ユーザーエクスペリエンスが低下します。 チームの導入と使用量が増加するにつれて、レポート、[通話分析、通話品質ダッシュボード](difference-between-call-analytics-and-call-quality-dashboard.md)を使用して問題を特定し、QoS と選択的な帯域幅の追加機能を使って調整を行います。

### <a name="vpn-considerations"></a>VPN に関する考慮事項

QoS は、呼び出し元間のすべてのリンクに実装されている場合にのみ動作します。 内部ネットワークで QoS を使用していて、ユーザーが遠隔地からサインインしている場合は、内部の管理されたネットワーク内でのみ優先順位を付けることができます。 リモートの場所は仮想プライベートネットワーク (VPN) を実装することによって管理された接続を受け取ることができますが、VPN の本質的にはパケットのオーバーヘッドが追加され、リアルタイムトラフィックで遅延が発生します。 VPN 経由のリアルタイム通信トラフィックを実行しないようにすることをお勧めします。

世界中の管理されたリンクを含むグローバル組織では、これらのリンクの帯域幅が LAN と比較して制限されているため、QoS を強くお勧めします。

## <a name="introduction-to-qos-queues"></a>QoS キューの概要

QoS を提供するには、ネットワークデバイスがトラフィックを分類するための手段を持っている必要があります。また、音声やビデオを他のネットワークトラフィックと区別できなければなりません。

ネットワークトラフィックがルーターに入ったら、トラフィックはキューに入れられます。 QoS ポリシーが構成されていない場合は、1つのキューしかありません。すべてのデータは、同じ優先度で最初のデータとして扱われます。 つまり、ボイストラフィック (遅延に非常に敏感) は、わずか数秒の遅延が問題となるトラフィックが遅れている可能性があります。

QoS を実装するときは、いくつかの輻輳管理機能 (Cisco の優先キューイング、クラスベースの加重公平なキューイング、 [Cbゅ q](https://www.cisco.com/en/US/docs/ios/12_0t/12_0t5/feature/guide/cbwfq.html#wp17641)など)、および輻輳回避機能 (加重ランダムなど) を使って複数のキューを定義します。[赤](https://en.wikipedia.org/wiki/Weighted_random_early_detection)で検出。

_図2QoS キューの例_

![QoS キューと帯域幅区分の図](media/Qos-in-Teams-Image2.png "利用可能な帯域幅の合計は、複数のキュー (オーディオ、ビデオ、その他のトラフィック) で分割されます。これには、さまざまな優先順位が割り当てられています。")

簡単な例としては、QoS によってデータネットワーク内に仮想 "相乗りレーン" が作成されるため、データの種類によっては遅延が発生しないことがあります。 これらのレーンを作成した後は、組織のユーザーに対してビジネスレベルのエクスペリエンスを提供しながら、相対的なサイズを調整して、より効率的に接続の帯域幅を管理することができます。

## <a name="select-a-qos-implementation-method"></a>QoS の実装方法を選択する

ネットワークのルーターでアクセス制御リスト (Acl) を使用して、ポートベースのタグを使って QoS を実装することができます。 ポートベースのタグ付けは、Windows と Mac の混合環境で動作し、実装が最も簡単な方法であるため、最も信頼できる方法です。 モバイルクライアントでは、DSCP 値を使ってトラフィックをマークするメカニズムは用意されていないため、この方法が必要になります。  

この方法を使用すると、ネットワークのルーターは受信パケットを調査し、特定のポートまたはポートの範囲を使ってパケットが到着した場合は、特定のメディアの種類として識別し、それをその種類のキューに入れて、事前に定義された[DSCP](https://tools.ietf.org/html/rfc2474)マークを IP に追加します。他のデバイスがそのトラフィックの種類を認識し、キューで優先順位を付けることができるようにするためのパケットヘッダー。

これは、すべてのプラットフォームで機能しますが、WAN edge でトラフィックをマークするだけで、管理のオーバーヘッドが生じます。 この方法を実装する手順については、ルーター製造元から提供されているドキュメントを参照してください。

* * *

また、グループポリシーオブジェクト (GPO) を使用して、クライアントデバイスが特定の種類のトラフィック (音声など) であることを示す DSCP マーカーを IP パケットヘッダーに挿入することで、QoS を実装することもできます。 ルーターなどのネットワークデバイスでは、これを認識して、トラフィックを個別の優先度の高いキューに配置するように構成することができます。

このシナリオは完全に有効ですが、ドメインに参加している Windows クライアントに対してのみ機能します。 ドメインに参加していないデバイスでは、DSCP タグ付けは有効になりません。 Mac OS などのクライアントでは、ハードコーディングされたタグがあり、常にトラフィックがタグ付けされます。

正側では、GPO を使用して DSCP マーキングを制御することで、ドメインに参加しているすべてのコンピューターが同じ設定を受け取り、管理者だけがそれらを管理できるようになります。 GPO を使うことができるクライアントは、元のデバイスでタグ付けされ、設定されたネットワークデバイスでは、DSCP コードによってリアルタイムストリームを認識し、適切な優先順位を付けることができます。

* * *

可能であれば、エンドポイントとポートベースの Acl での DSCP マーキングをルーターで組み合わせることをお勧めします。 グループポリシーオブジェクトを使用してほとんどのクライアントをキャッチし、さらにポートベースの DSCP タグを使用することで、モバイル、Mac、その他のクライアントでも QoS 処理を行うことができます (少なくとも部分的に)。

[DSCP マーキング] は、likened が配信されるまでの時間と、迅速な配信のために最適な並べ替えを行うことができるようにする郵送の頻度を示す切手にすることができます。 リアルタイムメディアストリームに優先順位を設定するようにネットワークを構成すると、紛失したパケットや遅延したパケットが大幅に減少します。

ネットワーク内のすべてのデバイスが同じ分類、マーキング、優先順位を使用している場合は、各トラフィックの種類で使用されるキューに割り当てられているポート範囲のサイズを変更することによって、遅延、破棄されたパケット、ジッタを削減または除去することができます。 Teams の観点から見ると、最も重要な構成手順は、パケットの分類とマーク付けですが、エンドツーエンドの QoS を成功させるには、基になるネットワーク構成にアプリケーションの構成を慎重に合わせる必要があります。 QoS が完全に実装されたら、継続的な管理は、組織のニーズと実際の使用状況に基づいて、各トラフィックの種類に割り当てられたポート範囲を調整することになります。

## <a name="choose-initial-port-ranges-for-each-media-type"></a>各メディアの種類の初期ポート範囲を選ぶ

DSCP 値は、対応して構成されたネットワークに、パケットまたはストリームを割り当てるための優先順位を示します。 DSCP マークがクライアントとネットワーク自体のどちらで割り当てられているかは、ACL 設定に基づいて判断されます。 各メディアワークロードは、固有の固有の DSCP 値を取得します (他のサービスによっては、ワークロードで DSCP マーキング、チームを共有することはできません)。また、各メディアの種類に対して定義され、個別のポート範囲を使うことができます。 その他の環境には既存の QoS 戦略がある場合があります。これは、ネットワークワークロードの優先順位を決定するのに役立ちます。

さまざまなリアルタイムストリーミングワークロードのポート範囲の相対サイズによって、そのワークロード専用の使用可能な帯域幅の合計の比率が設定されます。 以前のお客様に戻るには、"Air Mail" スタンプ付きの文字が、最も近い空港から1時間以内に実行されることがあります。また、"一括メール" マークとマークされた小さいパッケージでは、1日のうち、一連のトラックで陸を通過するまで待機することができます。

次の表は、ExpressRoute を備えた Teams の必須の DSCP マーキングと、ワークロードキューの関連ポートを示しています。 これらの範囲は、ユーザーが自分の環境で使用する内容がわからない場合に、適切な出発点となる可能性があります。 詳細については、「[ExpressRoute QoS の要件](https://docs.microsoft.com/azure/expressroute/expressroute-qos)」をご覧ください。

_推奨される初期ポート範囲_

|メディアトラフィックの種類| クライアントのソースポートの範囲 |プロトコル|DSCP 値|DSCP クラス|
|:--- |:--- |:--- |:--- |:--- |
|オーディオ| 50000–50019|TCP/UDP|46|完全優先転送 (EF)|
|ビデオ| 50020–50039|TCP/UDP|34|相対的優先転送 (AF41)|
|アプリケーション/画面共有| 50040–50059|TCP/UDP|才|確実に転送 (AF21)|
||||||

これらの設定を使用する場合は、次の点に注意してください。

- 今後、ExpressRoute の実装を計画していて、QoS を実装していない場合は、このガイダンスに従うことをお勧めします。これにより、DSCP 値が送信者と受信者と同じになるようにすることをお勧めします。
- モバイルクライアントやチームデバイスを含むすべてのクライアントは、これらのポート範囲を使用します。また、これらのソースポート範囲を使用する、実装するすべての DSCP ポリシーが影響を受けます。 動的なポートを引き続き使用するクライアントは、ブラウザーベースのクライアント (つまり、参加者がブラウザーを使って会議に参加できるクライアント) だけです。
- Mac クライアントでは、同じポート範囲を使用しますが、オーディオ (EF) とビデオ (AF41) にはハードコーディングされた値も使用されます。 これらの値は構成できません。
- ユーザーエクスペリエンスを向上させるために、後でポート範囲を調整する必要がある場合は、ポート範囲を重ねて、互いに隣り合っている必要があります。

## <a name="migrate-qos-to-teams"></a>QoS を Teams に移行する

QoS タグとポート範囲など、以前に Skype for Business Online を展開した後に Teams を展開している場合、チームは既存の構成を尊重し、Skype for Business クライアントと同じポート範囲とタグ付けを使用します。 ほとんどの場合、追加の構成は必要ありません。

> [!NOTE]
> グループポリシーによってアプリケーション名の QoS タグ付けを使用している場合は、アプリケーション名として Teams を追加する必要があります。

## <a name="qos-implementation-steps"></a>QoS の実装手順

高レベルでは、QoS を実装するには次の手順が必要です。

1. [ネットワークの準備ができていることを確認する](#verify-your-network-is-ready)
2. [QoS の実装方法を選択する](#select-a-qos-implementation-method)
3. [各メディアの種類の初期ポート範囲を選ぶ](#choose-initial-port-ranges-for-each-media-type)
4. QoS 設定を実装します。
   1. GPO を使って[クライアントデバイスのポート範囲とマークを設定](QoS-in-Teams-clients.md)するクライアント
   2. ルーター (製造元のマニュアルを参照)、または他のネットワークデバイスを参照してください。 これには、ポートベースの Acl が含まれている場合や、QoS キューと DSCP マーキングのいずれかを定義している場合があります。

      > [!IMPORTANT]
      > これらの QoS ポリシーは、クライアントソースポートと、発信元と送信先の IP アドレスを "any" として実装することをお勧めします。 これにより、内部ネットワーク上の受信および送信メディアの両方のトラフィックがキャッチされます。  

   3. [Teams 管理センター](meeting-settings-in-teams.md#set-how-you-want-to-handle-real-time-media-traffic-for-teams-meetings)の場合
5. ネットワーク上のチームトラフィックを分析して[、QoS の実装を検証し](#validate-the-qos-implementation)ます。

QoS を実装する準備ができたら、次のガイドラインを念頭に置いてください。

- Office 365 への最短のパスが最適です。
- ポートを閉じると音質が低下します。
- プロキシなどの障害物はお勧めできません。
- ホップ数を制限します。
  - クライアントとネットワークエッジ-3 ~ 5 ホップ。
  - ISP から Microsoft ネットワークエッジ–3ホップ
  - Microsoft ネットワークエッジから最終的な送信先への関連性がない

ファイアウォールのポートを構成する方法については、「 [Office 365 の URL と IP 範囲](office-365-urls-ip-address-ranges.md)」をご覧ください。

## <a name="managing-source-ports-in-the-teams-admin-center"></a>Teams 管理センターでソースポートを管理する

Teams では、さまざまなワークロードによって使用される QoS ソースポートを、必要に応じて動的に管理し、調整する必要があります。 「[各メディアの種類の初期ポート範囲を選択](#choose-initial-port-ranges-for-each-media-type)する」の表を参照すると、ポート範囲は調整できますが、DSCP マーキングは構成できません。 これらの設定を実装した後は、特定のメディアの種類に必要なポートの数が増加するか、少なくなることがあります。 [通話分析と通話品質ダッシュボード](difference-between-call-analytics-and-call-quality-dashboard.md)を使用して、Teams が実装された後、定期的に、必要に応じてポート範囲を調整することを決定します。

> [!NOTE]
> Skype for Business Online のソースポート範囲と DSCP マーキングに基づいて QoS を既に構成している場合は、同じ構成が Teams に適用され、マッピングに対するクライアントやネットワークの変更は必要ありませんが、範囲を設定する必要があります。 [Teams 管理センターで](meeting-settings-in-teams.md#set-how-you-want-to-handle-real-time-media-traffic-for-teams-meetings)、Skype For Business Online 用に構成されていたものと一致するように使用します。

以前にオンプレミスの Skype for Business Server を展開したことがある場合は、QoS ポリシーを再調査し、必要に応じて調整して、チームの質の高いユーザーエクスペリエンスを提供できるように、必要に応じて調整する必要があります。

## <a name="validate-the-qos-implementation"></a>QoS の実装を検証する

QoS を有効にするには、グループポリシーオブジェクトによって設定された DSCP 値が、通話の両端に存在している必要があります。 チームクライアントによって生成されたトラフィックを分析することで、チームの負荷トラフィックがネットワーク経由で移動したときに、DSCP 値が変更されていないこと、または除去されているかどうかを確認できます。

可能であれば、ネットワークの出口ポイントでトラフィックをキャプチャします。 スイッチまたはルータでポートミラーリングを使用して、この問題を解決することができます。

### <a name="use-network-monitor-to-verify-dscp-values"></a>ネットワークモニターを使用して DSCP 値を確認する

ネットワークモニターは、 [Microsoft からダウンロード](https://www.microsoft.com/download/4865)してネットワークトラフィックを分析するためのツールです。

1. ネットワークモニターを実行している PC で、ポートのミラーリング用に構成されているポートに接続し、パケットのキャプチャを開始します。

2. Teams クライアントを使用して電話をかけます。 通話を切る前にメディアが確立されていることを確認します。

3. キャプチャを停止します。

4. [**表示フィルター** ] フィールドで、通話を行った PC のソース IP アドレスを使用し、次の例に示すように、検索条件として DSCP 値 46 (Hex 0x2e) を定義してフィルターを絞り込みます。

    Source = = "192.168.137.201" AND DifferentiatedServicesField = = 0x2E

    ![[フィルターの表示] ダイアログボックスの [スクリーンショット] フィルター](media/Qos-in-Teams-Image4.png "ネットワークモニターの [フィルターの表示] ダイアログボックス。適用するフィルターが表示されています。")

5. [**適用**] を選択してフィルターを有効にします。

6. [**フレームの概要**] ウィンドウで、最初の UDP パケットを選択します。

7. [**フレームの詳細**] ウィンドウで、[IPv4] リスト項目を展開し、 **DSCP**で始まる行の末尾の値をメモします。

    ![[フレームの詳細] ダイアログボックスの DSCP 設定を示すスクリーンショット。][(media/Qos-in-Teams-Image5.png "ネットワークモニター] の [フレームの詳細] ダイアログボックスで、DSCP 設定が強調表示されています。")

この例では、DSCP 値は46に設定されています。 使用されるソースポートは50019であるため、これはボイスワークロードであることを示します。

GPO によってマーキングされている各ワークロードについて確認を繰り返します。

## <a name="more-information"></a>詳細情報

[ビデオ : ネットワーク計画](https://aka.ms/teams-networking)

[Microsoft Teams 用に組織のネットワークを準備する](prepare-network.md)

[ExpressRoute の QoS 要件](https://docs.microsoft.com/azure/expressroute/expressroute-qos)
