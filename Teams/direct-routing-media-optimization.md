---
title: ダイレクト ルーティング用のローカル メディアの最適化
author: CarolynRowe
ms.author: crowe
manager: serdars
ms.date: 04/07/2020
ms.topic: article
ms.service: msteams
audience: admin
ms.collection:
- M365-voice
ms.reviewer: filippse
search.appverid: MET150
f1.keywords:
- NOCSH
description: ダイレクト ルーティング用のローカル メディアの最適化
appliesto:
- Microsoft Teams
ms.openlocfilehash: 73c52cbfc632c61b281ec156ebfe8439a8900f06
ms.sourcegitcommit: 9f1f5cd828c24676c20df727b2c67daf56ff884c
ms.translationtype: MT
ms.contentlocale: ja-JP
ms.lasthandoff: 01/28/2022
ms.locfileid: "62248678"
---
# <a name="plan-for-local-media-optimization-for-direct-routing"></a>ダイレクト ルーティング用のローカル メディアの最適化を計画する

公衆交換電話網 (PSTN) 音声は、音声品質に大きな期待を持つビジネス クリティカルなアプリケーションと見なされます。 ダイレクト ルーティングを使用すると、メディア トラフィック フローを制御して、世界中のさまざまな企業向けの多数のネットワーク トポロジとローカル テレフォニーの設定に対応できます。 

ダイレクト ルーティングのローカル メディア最適化では、次の方法で音声品質を管理できます。

-   Teams クライアントと顧客のセッション ボーダー コントローラー (SBC) 間でのメディア トラフィックのフローを制御します。
-   企業ネットワーク サブネットの境界内でメディアをローカルに保持する。
-   TEAMS クライアントと SBC の間でメディア ストリームを許可する場合でも、SBC はプライベート IP を持つ企業ファイアウォールの内側にあり、Microsoft からは直接表示されません。

ローカル メディアの最適化では、次の 2 つのシナリオがサポートされます。

- メインセッション開始プロトコル (SIP) トランクに接続された一元化された SBC を介してすべてのローカル トランクを一元化し、会社のすべてのローカル ブランチ オフィスにテレフォニー サービスを提供します。

-   SBC の仮想ネットワーク トポロジを構築します。ローカル ブランチ オフィス内の SBC は、外部 IP アドレスを介してシステムに対して表示され、Microsoft 電話通信する一元化されたプロキシ SBC に接続されます。 仮想ネットワーク トポロジでは、ダウンストリーム SBC は内部 IP を介して通信しており、電話システムに直接表示されません。

この記事では、機能の機能と、お客様のシナリオとソリューションについて説明します。 構成の詳細については、「 [ローカル メディアの最適化の構成」を](direct-routing-media-optimization-configure.md)参照してください。 

  > [!NOTE]
  > イントラネットの境界内でメディアをローカルに保持する場合は、ローカル メディアの最適化をお勧めします。 メディア バイパスが既にあり、SBC のパブリック IP アドレスのみを使用している場合は、ローカル メディア最適化に移動することは必須ではありません。 メディア バイパスは引き続き使用できます。 詳細については、「 [メディア バイパスの計画」を](direct-routing-plan-media-bypass.md)参照してください。

どの SBC ベンダーがローカル メディアの最適化をサポートするかについては、「 [ダイレクト ルーティング用に認定されたセッション ボーダー コントローラー](direct-routing-border-controllers.md)」を参照してください。


## <a name="supported-customer-scenarios"></a>サポートされている顧客のシナリオ

この説明では、Contoso が次のように世界中で複数の企業を経営しているとします。 (ヨーロッパと APAC リージョンは例としてのみ使用されることに注意してください。 会社には、同様の要件を持つ複数の異なるリージョンが含まれている場合があります)。
 
- **ヨーロッパでは**、Contoso は約 30 か国にオフィスを持っています。 各オフィスには、独自のプライベート ブランチ Exchange (PBX) があります。 

  Contoso は、30 のヨーロッパのオフィスすべてについて、アムステルダムという 1 つの場所にトランクを一元化するオプションを提供されました。 Contoso はアムステルダムに SBC を展開し、一元的な場所で通話を実行するのに十分な帯域幅を提供し、中央の SIP トランクを一元的な場所に接続し、アムステルダムからすべてのヨーロッパの場所にサービスを提供し始めました。 

- **APAC リージョンでは**、Contoso はさまざまな国に複数のオフィスを持っています。 

  多くの国では、会社は依然としてローカルブランチ オフィスに時間分割多重 (TDM) トランクを持っています。 TDM トランクの一元化は APAC リージョンのオプションではないため、SIP への切り替えは不可能です。 APAC リージョン全体に 50 を超える Contoso ブランチ オフィスがあり、数百のゲートウェイ (SBC) があるとします。 このシナリオでは、パブリック IP アドレスやローカル インターネットブレークアウトがないため、すべてのゲートウェイを Direct Routing インターフェイスにペアリングすることはできません。 さらに、一部の国では、ローカルの PSTN ネットワーク接続がないと満たすことができない規制要件が課されています。

Contoso はビジネス要件に基づいて、ダイレクト ルーティング用のローカル メディア最適化を使用して 2 つのソリューションを実装しました。

- **ヨーロッパでは**、すべてのトランクが一元化され、ユーザーの場所に基づいて中央 SBC とユーザー間のメディア フローが行われます。 

  - ユーザーが企業ネットワークのローカル サブネットに接続されている (つまり、ユーザーが内部である) 場合、メディアは中央 SBC の内部 IP とユーザーのTeams クライアントの間を流れます。 
  
  - ユーザーが企業ネットワークの境界外にある場合 (たとえば、ユーザーがパブリック ワイヤレス インターネット接続を使用している場合)、ユーザーは外部と見なされます。 この場合、メディアは中央 SBC の外部 IP とTeams クライアントの間を流れます。

- **APAC リージョンでは**、一元化されたプロキシ SBC が Microsoft Direct Routing にペアリングされ、ダイレクト ルーティング インターフェイスとローカル ブランチ オフィスのダウンストリーム SBC の間でメディアが転送されます。 

  ローカル ブランチ オフィスのダウンストリーム SBC は、APAC のダイレクト ルーティングには直接表示されませんが、Set-CSOnlinePSTNGateway コマンドレットを使用して、Microsoft 電話 System 内に仮想ネットワーク トポロジを作成することでペアになります。 可能な場合、メディアは常にローカルのままです。 外部ユーザーは、Teams クライアントとプロキシ SBC のパブリック IP の間を流れるメディアを持っています。


## <a name="central-sbc-with-centralized-trunks"></a>中央 SBC と一元化されたトランク

一元化された SIP トランクが接続された 1 つの中央 SBC を介して PSTN サービスがすべてのローカル ブランチ オフィスに提供されるソリューションを構築するために、Contoso テナント管理者は 1 つの SBC (centralsbc.contoso.com) をサービスとペアリングします。SBC には一元的な SIP トランクが接続されています。 

- ユーザーが会社の内部ネットワークに入っている場合、SBC はメディア用に SBC の内部 IP を提供します。 

- ユーザーが企業ネットワークの外部にいる場合、SBC は SBC の外部 (パブリック) IP を提供します。

> [!NOTE]
> 例、テーブル、または図内のすべての値は、説明のみを目的として表示されます。

表 1. SBC のネットワーク パラメーターの例 


| 場所 | SBC FQDN | 内部サブネット | 外部 NAT (信頼された IP) | SBC 外部 IP アドレス | SBC 内部 IP アドレス |
|:------------|:-------|:-------|:-------|:-------|:-------|
| アムステルダム | centralsbc.contoso.com | 192.168.5.0/24 | 172.16.76.73 | 172.16.76.71 | 192.168.5.5 |
| ドイツ | 未デプロイ | 192.168.6.0/24 | 172.16.76.74 | 未デプロイ |  未デプロイ |
| フランス | 未デプロイ | 192.168.7.0/24 | 172.16.76.75 | 未デプロイ |  未デプロイ |


### <a name="internal-user"></a>内部ユーザー

次の図は、ユーザーがユーザーのホーム ブランチ オフィスまたはサイト内の企業ネットワークに接続されている場合のトラフィック フローを示しています。 

オンプレミスでは、ユーザーはドイツのローカルブランチ オフィスに割り当てられます。 ユーザーは、Teams経由でダイレクト ルーティング電話を発信します。

- ユーザーのTeams クライアントは REST API を介して直接電話システムと通信しますが、呼び出し中に生成されたメディアは中央 SBC の内部 IP アドレスに流れます。 

- SBC は、フローを電話システムと接続された PSTN ネットワークにリダイレクトします。 

- 中央 SBC は、外部 IP アドレスを介してのみ電話システムに表示されます。 

図 1. ユーザーが一元化された SBC と接続された一元化された SIP トランクを持つ "ホーム" サイトにいる場合のトラフィック フロー

![トラフィック フローのローカル メディアの最適化を示す図。](media/direct-routing-media-op-1.png "ユーザーが一元的な SIP トランクを使用して一元化された SBC を使用して &quot;自宅&quot; サイトにいる場合のトラフィック フロー")


### <a name="external-user"></a>外部ユーザー

次の図は、ユーザーがオンプレミスではなく、企業ネットワークに接続されていない (つまり、ユーザーのデバイスがモバイル デバイスまたはパブリック Wi-Fi を介してインターネットに接続されている) 場合のトラフィック フローを示しています。 ユーザーは、Teamsを介してダイレクト ルーティング電話を発信します。

- ユーザーのTeams クライアントは REST API を介して直接電話システムと通信しますが、この場合、呼び出し中に生成されたメディアは中央 SBC の外部 IP アドレスに流れます。 

- SBC は、フローを電話システムと接続された PSTN ネットワークにリダイレクトします。 

- 中央 SBC は、外部 IP アドレスを介してのみ電話システムに表示されます。 

この場合、ユーザーがドイツのブランチ オフィスにローカルであるか、他のブランチ オフィスにローカルであるかに関係なく、動作は似ています。 ユーザーは企業ネットワークの境界外にあるため、ユーザーは外部と見なされます。

図 2. ユーザーが一元化された SBC と接続された一元化された SIP トランクを使用して外部である場合のトラフィック フロー

![図は、トラフィック フローのローカル メディアの最適化を示しています。](media/direct-routing-media-op-2.png "一元化された SIP トランクが接続された集中型 SBC の場合に、ユーザーが外部である場合のトラフィック フロー")

## <a name="proxy-sbc-with-connected-downstream-sbcs"></a>接続されたダウンストリーム SBC を持つプロキシ SBC

TDM トランクの一元化がオプションではない APAC リージョンのすべてのローカル ブランチ オフィスで PSTN サービスが提供されるソリューションを構築するために、Contoso 管理者は、プロキシ SBC とも呼ばれる 1 つの SBC (proxysbc.contoso.com) をダイレクト ルーティング サービスとペアリングします。 

その後、Contoso 管理者は、プロキシ SBC proxysbc.contoso.com を介して到達できることを示すダウンストリーム SBC を追加します。 ダウンストリーム SBC にはパブリック IP がありませんが、音声ルートに割り当てることができます。 次の表は、ネットワーク パラメーターと構成の例を示しています。

ユーザーがダウンストリーム SBC があるローカル ブランチ オフィスにいる場合、メディア トラフィックはユーザーとローカル ダウンストリーム SBC の間を直接流れます。 ユーザーがオフィスの外部 (パブリック インターネット上) にある場合、メディアはユーザーからプロキシ SBC のパブリック IP に流れ、それを関連するダウンストリーム SBC にプロキシします。

表 2. SBC ネットワーク情報の例

| 場所 | SBC FQDN | 内部サブネット | 外部 NAT (信頼された IP) | SBC 外部 IP アドレス  | SBC 内部 IP アドレス |
|:------------|:-------|:-------|:-------|:-------|:-------|
| ベトナム | VNsbc.contoso.com | 192.168.1.0/24 | 172.16.240.110 | なし |  192.168.1.5 |
| インドネシア  | IDsbc.contoso.com | 192.168.2.0/24 | 172.16.240.120 | なし |  192.168.2.5 |
| シンガポール | proxysbc.contoso.com |   192.168.3.0/24 | 172.16.240.130 | 172.16.240.133 | 192.168.3.5 |



### <a name="internal-user"></a>内部ユーザー 

次の図は、ユーザーが APAC リージョンのオフィス内にいる場合のシナリオの高度なトラフィック フローを示しています。 ユーザーは、ベトナムのローカルブランチ オフィスに割り当てられ、オンプレミスで、Teams経由で直接ルーティング電話を発信します。 

- ユーザーのTeams クライアントは REST API を介して直接電話システムと通信しますが、呼び出し中に生成されたメディアはローカル SBC の内部 IP アドレスに流れます。

- ローカル SBC は、フローをシンガポールのプロキシ SBC および接続されたローカル PSTN ネットワークにリダイレクトします。

-  プロキシ SBC は、外部 IP アドレスを介してのみ電話システムに表示され、ダウンストリーム SBC (この場合はベトナムのローカル SBC) から電話システムにフローをルーティングします。 

- ローカル ブランチ オフィスのダウンストリーム SBC は、電話システムに直接表示されませんが、ローカル メディア最適化の設定中に Contoso 管理者によって定義された仮想ネットワーク トポロジ内にマップされます。

> [!NOTE]
> 構成されたローカル メディア最適化モードによっては、ローカル ユーザーと非ローカル ユーザーでは動作が異なる場合があります。 

可能なモードと関連する動作の詳細については、「ローカル メディアの最適化を構成する」を参照してください。

図 3. ユーザーがプロキシ SBC と接続されたダウンストリーム SBC を使用して "ホーム" ネットワークにいる場合のトラフィック フロー 

![トラフィック フローのローカル メディア最適化を再び示す図。](media/direct-routing-media-op-3.png "ユーザーが &quot;ホーム&quot; ネットワークにいる場合に、接続されたダウンストリーム SBC を持つプロキシ SBC の場合のトラフィック フロー")

### <a name="external-user"></a>外部ユーザー

次の図は、ユーザーが企業ネットワーク境界の外にあるときのトラフィック フローを示しています。 ユーザーはオンプレミスではありません (企業ネットワークの境界内にありません)。 ユーザーは、Teams経由で直接ルーティング電話をベトナムの電話番号に発信します。 

- ユーザーのTeams クライアントは REST API を介して直接電話システムと通信しますが、呼び出し中に生成されたメディアは、まずシンガポールのプロキシ SBC の外部 IP アドレスに流れます。 

- 構成ポリシーと音声ポリシーに基づいて (詳細については、「 [ローカル メディアの最適化の構成](direct-routing-media-optimization-configure.md) 」を参照)、プロキシ SBC は、フローをベトナムのダウンストリーム SBC にリダイレクトします。 

- ベトナムのダウンストリーム SBC は、フローを接続されたローカル PSTN ネットワークにリダイレクトします。 

- プロキシ SBC は、外部 IP アドレスを介してのみ電話システムに表示されます。

-  ローカル ブランチ オフィスのダウンストリーム SBC は、直接電話システムには表示されませんが、ローカル メディア最適化の設定中に Contoso 管理者によって定義された仮想ネットワーク トポロジ内でマップされます。 この例では、ユーザーが企業ネットワークの境界外にあるため、ユーザーは外部と見なされます。 

図 4. ユーザーがプロキシ SBC と接続されたダウンストリーム SBC を使用して外部である場合のトラフィック フロー

![図は、トラフィック フローのローカル メディアの最適化を再び示しています。](media/direct-routing-media-op-4.png "ユーザーが外部である場合に、ダウンストリーム SBC が接続されたプロキシ SBC の場合のトラフィック フロー")

## <a name="local-media-optimization-modes"></a>ローカル メディアの最適化モード

ローカル メディアの最適化では、次の 2 つのモードがサポートされます。

- **モード 1: 常にバイパス** します。 この場合、ユーザーが内部の場合、内部ユーザーの実際の場所に関係なく、メディアはローカル ダウンストリーム SBC の内部 IP アドレスを通過します。たとえば、ダウンストリーム SBC が配置されているのと同じブランチ オフィス内や他のブランチ オフィス内などです。  

- **モード 2: ローカル ユーザーの場合のみ**。 このモードでは、メディアは、ダウンストリーム SBC と同じブランチ オフィスにある内部ユーザーによって生成された場合にのみ、ローカル ダウンストリーム SBC の内部 IP アドレスに直接フローします。 

ローカル メディア最適化モードを区別するには、テナント管理者は、Set-CSonlinePSTNGateway コマンドレットを使用して、SBC ごとに -BypassMode パラメーターを 'Always' または 'OnlyForLocalUsers' に設定する必要があります。 詳細については、「 [ローカル メディアの最適化の構成」を](direct-routing-media-optimization-configure.md)参照してください。  

> [!NOTE]
> ユーザーが内部である場合は、内部 IP アドレス経由でユーザーと SBC の間にメディア接続が **必要** です。 この場合、SBC はメディア接続用の内部 IP を提供するため、メディア用のパブリック トランスポート リレーへのフォールバックはありません。 

### <a name="mode-1-always-bypass"></a>モード 1: 常にバイパスする

ブランチ オフィス間の接続が良好な場合は、推奨モードは常にバイパスされます。
 
たとえば、アムステルダムに一元的な SIP トランクがあり、30 か国にサービスを提供し、30 サイトすべてのサイトとローカル ユーザー間の接続が良好であるとします。 ドイツには、ローカル SBC がデプロイされているブランチもあります。

ドイツの SBC は、"常にバイパス" モードで構成できます。 ユーザーは、場所に関係なく、SBC の内部 IP アドレスを介して SBC に直接接続します (たとえば、フランスからドイツまで、次の図を参照してください)。

次に、2 つのシナリオについて説明します。

- シナリオ 1。 ユーザーは、オンライン音声ルーティング ポリシーで定義されている SBC と同じ場所にいます。

- シナリオ 2. ユーザーとゲートウェイは異なるサイトに存在します。

#### <a name="scenario-1-the-user-is-in-the-same-location-as-the-sbc-defined-in-the-online-voice-routing-policy"></a>シナリオ 1。 ユーザーは、オンライン音声ルーティング ポリシーで定義されている SBC と同じ場所にいます

アムステルダムの SBC は、ドイツのローカル ダウンストリーム SBC のプロキシ SBC として構成されています。 ユーザーは、ローカル SBC の企業ネットワークと同じサブネット内のドイツにいます。 両方の SBC (プロキシとダウンストリーム) は、Always Bypass モード用に構成されます。 オンライン音声ルーティング ポリシーでは、ドイツ内の呼び出し (市外局番 +49) の場合は、ドイツのローカル SBC にルーティングする必要があることを指定します。 その他のすべての呼び出し(ドイツの SBC が失敗した場合)、ドイツでの呼び出しはアムステルダムのプロキシ SBC にルーティングする必要があります。 次の表は、構成の例をまとめたものです。 

表 3. シナリオ 1 の構成例

| ユーザーの物理的な場所 | ユーザーが番号を呼び出す | オンライン音声ルーティング ポリシー | SBC 用に構成されたモード | メディア Flow | 
|:------------|:-------|:-------|:-------|:-------|
| ドイツ | +49 1 437 2800 | 優先度 1: ^\+49(\d{8})$ -DEsbc.contoso.com<br>優先度 2: .* - proxysbc.contoso.com| DEsbc.contoso.com – 常にバイパス <br>proxysbc.contoso.com – 常にバイパス | Teams ユーザー <–> DEsbc.contoso.com |

次の図は、ドイツの内部ユーザーがドイツの番号にTeamsを介して直接ルーティング電話を発信する、高度なトラフィック フローを示しています。 

- ユーザーのTeams クライアントは、REST API を介して直接電話システムと通信します。 

- 呼び出し中に生成されたメディアは、ローカル SBC の内部 IP アドレスに流れます。 

- ローカル SBC は、フローをアムステルダムのプロキシ SBC と接続されたローカル PSTN ネットワークにリダイレクトします。 

- プロキシ SBC は、外部 IP アドレスを介してのみ電話システムに表示され、ダウンストリーム SBC (この場合はドイツのローカル SBC) から電話システムにフローをルーティングします。 

- ローカル ブランチ オフィスのダウンストリーム SBC は、電話システムに直接表示されませんが、ローカル メディア最適化の設定中に Contoso 管理者によって定義された仮想ネットワーク トポロジ内にマップされます。


図 5.  "Always Bypass" モードでユーザーが "ホーム" サイトに入っているトラフィック フロー

![トラフィック フローのローカル メディアの最適化を示す図。](media/direct-routing-media-op-5.png "&quot;Always Bypass&quot; モードでユーザーが &quot;ホーム&quot; サイトに入っているトラフィック フロー")


#### <a name="scenario-2-the-user-and-gateways-are-in-different-sites"></a>シナリオ 2: ユーザーとゲートウェイが異なるサイトに存在する

アムステルダムの SBC は、ドイツのローカル ダウンストリーム SBC のプロキシ SBC として構成されています。 両方の SBC (プロキシとダウンストリーム) は、Always Bypass モード用に構成されます。 ローカルブランチ オフィスにあるフランスの内部ユーザーは、ドイツへの直接ルーティング呼び出しを行っています。 オンライン音声ルーティング ポリシーでは、ドイツへの呼び出し (市外局番 +49) をドイツのローカル SBC にルーティングするように指定します。 その他のすべての呼び出し (ドイツの SBC が失敗した場合) は、ドイツのすべての呼び出しをアムステルダムのプロキシ SBC にルーティングする必要があります。 次の表は、構成の例をまとめたものです。 

表 4. シナリオ 2 の構成例

| ユーザーの物理的な場所 | ユーザーが番号を呼び出す | オンライン音声ルーティング ポリシー | SBC 用に構成されたモード | メディア Flow | 
|:------------|:-------|:-------|:-------|:-------|
| フランス | +49 1 437 2800 | 優先度 1: ^\+49(\d{8})$ -DEsbc.contoso.com <br>優先度 2: .* - proxysbc.contoso.com |  DEsbc.contoso.com – 常にバイパス proxysbc.contoso.com – 常にバイパス | Teams ユーザー < – > DEsbc.contoso.com  |

次の図は、フランスに所在するドイツの内部ユーザーがドイツの番号にTeamsを介して直接ルーティング電話を発信したときの高度なトラフィック フローを示しています。 

- ユーザーのTeams クライアントは、REST API を介して直接電話システムと通信します。

- 通話中に生成されたメディアは、ドイツの内部 IP アドレス内の SBC に直接流れます。 

- ドイツの SBC は、フローをアムステルダムのプロキシ SBC と接続されているローカル PSTN ネットワークにリダイレクトします。 

図 6.  "Always Bypass" モードで、ユーザーが "ホーム" サイトではなく内部ネットワーク内にあるトラフィック フロー

![図は、トラフィック フローのローカル メディアの最適化を示しています。](media/direct-routing-media-op-6.png "&quot;Always Bypass&quot; モードで、ユーザーが &quot;ホーム&quot; サイトではなく内部ネットワーク内にあるトラフィック フロー")

### <a name="mode-2-only-for-local-users"></a>モード 2: ローカル ユーザーの場合のみ

ローカル ブランチ オフィス間の接続が良好で、各ローカル ブランチ オフィスと地域オフィスの間に良好な接続がある場合、推奨モードは "ローカル ユーザー専用" です。

たとえば、APAC リージョンでは、Contoso が異なる国に複数のオフィスを持っているとします。 多くの国では、多くのローカルブランチ オフィスにはまだ TDM トランクがあるため、SIP への切り替えは不可能です。 TDM トランクの一元化は、APAC リージョンのオプションではありません。 さらに、APAC リージョンには、数百のゲートウェイ (SBC) を備えた Contoso ブランチ オフィスが 50 を超えています。 

CONTOSO 管理者は、TDM トランクの一元化がオプションではない APAC リージョンのすべてのローカル ブランチ オフィスで PSTN サービスが提供されるソリューションを構築するために、Contoso 管理者は、プロキシ SBC としてシンガポールの 1 つのリージョン SBC をダイレクト ルーティング サービスとペアリングします。 ローカル ブランチ オフィス間の直接接続は良好ではありませんが、各ローカル ブランチ オフィスとシンガポールの地域 SBC の間には良好な接続があります。 リージョン SBC の場合、管理者は "Always Bypass" モードを選択し、ローカル ダウンストリーム SBC では管理者が [ローカル ユーザー専用] モードを選択します。

次に、2 つのシナリオについて説明します。

- シナリオ 1。 ユーザーは、オンライン音声ルーティング ポリシーで定義されている SBC と同じ場所にいます

- シナリオ 2. ユーザーとゲートウェイが異なるサイトに存在する

#### <a name="scenario-1-the-user-is-in-the-same-location-as-the-sbc-defined-in-online-voice-routing-policy"></a>シナリオ 1。 ユーザーがオンライン音声ルーティング ポリシーで定義されている SBC と同じ場所にある

シンガポールの SBC が、ベトナムとインドネシアのローカル ダウンストリーム SBC のプロキシ SBC として構成されているとします。 ユーザーは、ローカル SBC と同じ場所にベトナムにいます。 オンライン音声ルーティング ポリシーでは、ベトナムでの呼び出し (市外局番 +84) をベトナムのローカル SBC にルーティングすることを指定します。 その他のすべての呼び出し(および、ベトナムの SBC が失敗した場合は、ベトナムでの呼び出しはシンガポールのプロキシ SBC にルーティングする必要があります)。 次の表は、構成の例をまとめたものです。 

表 5. [ローカル ユーザーのみ] モードの構成例シナリオ 1

| ユーザーの物理的な場所 | ユーザーが番号を呼び出す | オンライン音声ルーティング ポリシー | SBC 用に構成されたモード | メディア Flow | 
|:------------|:-------|:-------|:-------|:-------|
| ベトナム | +84 4 3926 3000 | 優先度 1: ^\+84(\d{9})$ -VNsbc.contoso.com <br>優先度 2: .* - proxysbc.contoso.com | VNsbc.contoso.com – ローカル ユーザーの場合のみ <br> proxysbc.contoso.com – 常にバイパス | Teams ユーザー <–> VNsbc.contoso.com |

次の図では、ベトナムのローカル ブランチ オフィスに割り当てられたユーザーがオンプレミスで、Teams経由でダイレクト ルーティング電話を発信しています。 

- ユーザーのTeams クライアントは、REST API を介して直接電話システムと通信します。 

- 呼び出し中に生成されたメディアは、ローカル SBC の内部 IP アドレスに流れます。 

- ローカル SBC は、フローをシンガポールのプロキシ SBC および接続されたローカル PSTN ネットワークにリダイレクトします。 

- プロキシ SBC は、外部 IP アドレスを介してのみ電話システムに表示され、ダウンストリーム SBC (この場合はベトナムのローカル SBC) から電話システムにフローをルーティングします。 

- ローカル ブランチ オフィスのダウンストリーム SBC は、直接電話システムには表示されませんが、仮想ネットワーク トポロジ内でマップされます。

図 7. "ローカル ユーザー専用" モードでユーザーが "ホーム" サイトに入るトラフィック フロー

![トラフィック フローのローカル メディアの最適化を示す別の図。](media/direct-routing-media-op-7.png "&quot;ローカル ユーザー専用&quot; モードのトラフィック フローとユーザーが &quot;ホーム&quot; サイトにある")


#### <a name="scenario-2-the-user-and-gateways-are-in-different-sites"></a>シナリオ 2. ユーザーとゲートウェイが異なるサイトに存在する

シンガポールの SBC が、ベトナムとインドネシアのローカル ダウンストリーム SBC のプロキシ SBC として構成されているとします。 ローカルブランチ オフィスにあるインドネシアの内部ユーザーは、ベトナムへのダイレクト ルーティング呼び出しを行っています。 Online Voice ルーティング ポリシーでは、ベトナムへの呼び出し (市外局番 +84) をベトナムのローカル SBC にルーティングするように指定します。 その他のすべての呼び出し-、および、ベトナムの SBC が失敗した場合は、ベトナムへの呼び出しをシンガポールのプロキシ SBC にルーティングする必要があります。 シンガポールのプロキシ SBC は [Always Bypass] モードに設定され、ベトナムのローカル SBC は [ローカル ユーザーのみ] モードに設定されています。 次の表は、構成の例をまとめたものです。 

表 6. ユーザー構成

| ユーザーの物理的な場所 | ユーザーが番号を呼び出す | オンライン音声ルーティング ポリシー | SBC 用に構成されたモード | メディア Flow | 
|:------------|:-------|:-------|:-------|:-------|
| インドネシア | +84 4 3926 3000 | 優先度 1: ^\+84(\d{9})$ -VNsbc.contoso.com <br> 優先度 2: .* - proxysbc.contoso.com |VNsbc.contoso.com – ローカル ユーザーの場合のみ <br> proxysbc.contoso.com – 常にバイパス | Teams ユーザー <–> proxysbc.contoso.com <–> VNsbc.contoso.com |


次の図では、内部ユーザーは、インドネシアのブランチ オフィスのオンプレミスで、Teams経由でベトナムの番号に直接ルーティング電話を発信しています。 

- ユーザーのTeams クライアントは、REST API を介して直接電話システムと通信します。

- 呼び出し中に生成されたメディアは、最初に SBC の内部 IP アドレスをプロキシにフローします。 

- シンガポールのプロキシ SBC は、フローをベトナムのダウンストリーム SBC の内部 IP アドレスにリダイレクトし、電話システムします。 

- ベトナムのダウンストリーム SBC は、接続されたローカル PSTN ネットワークにフローをルーティングします。 

- プロキシ SBC は、外部 IP アドレスを介してのみ電話システムに表示されます。

- ローカル ブランチ オフィスのダウンストリーム SBC は、直接電話システムには表示されませんが、仮想ネットワーク トポロジ内でマップされます。

図 8.  "ローカル ユーザー専用" モードのトラフィック フロー。ユーザーは "ホーム" サイトではなく、内部ネットワーク内にある

![別の図は、トラフィック フローのローカル メディアの最適化を示しています。](media/direct-routing-media-op-8.png "&quot;ローカル ユーザー専用&quot; モードのトラフィック フローでは、ユーザーは &quot;ホーム&quot; サイトではなく内部ネットワーク内に")

## <a name="known-issues"></a>既知の問題

ローカル メディアの最適化に現在存在する既知の問題の一覧を次に示します。 Microsoft では、これらの問題への対処に取り組んでいます。

| 問題 | 回避 策 |
| :--- | :--- |
| Teamsクライアントは、Teams クライアントパブリック IP が顧客の信頼済み IP リストと一致する場合、**内部** として識別されません。 | ローカル メディアの最適化では、Teams クライアント サブネットがテナント構成[のネットワーク サブネット](/powershell/module/skype/new-cstenantnetworksubnet)と一致する必要があります|
| 呼び出しエスカレーションの結果、Teams クライアントが内部として識別されると、呼び出しが削除されます。| ダイレクト ルーティング SBC でローカル メディアの最適化を無効にします。|
| 内部顧客間で 1 から 1 への通話エスカレーションを外部顧客/リソースのマルチパーティ通話に呼び出すと、通話が削除されます | 修正プログラムの進行中の作業。 または、ダイレクト ルーティング SBC でローカル メディアの最適化を無効にします。|
| ユーザー Teams通話を保留にします。 PSTN 側で音楽が再生され、ローカル メディアの最適化が機能しています。 Teams ユーザーが呼び出しを再開します。 PSTN への呼び出しは再開されますが、ローカル メディアの最適化は機能せず、通話は Central (プロキシ) SBC 経由で続行されます | ユーザーが保留音を開始する呼び出し (MoH) をパークすると、MoH が保留になったユーザーに到達するメディア コントローラーとメディア プロセッサ (AVMCU ミキサーとして機能) を呼び出すために、コール コントローラーによって 1:1 からマルチパーティの呼び出しにエスカレートされます。 呼び出しが再開された後の 1 対 1 の呼び出しへのエスカレーション解除は、設計どおりに行われません。 ダイレクト ルーティング SBC でローカル メディアの最適化を無効にします。|
|呼び出しが数秒間確立されている間、ユーザーは無音を聞く可能性があります。| ローカル メディア最適化アーキテクチャの複雑さのために、これは場合によっては発生する可能性があります。|
|音声アプリ (自動応答、通話キューなど) は機能しません。| LMO では、クラウドに存在し、外部接続が必要であるため、Voice Apps はサポートされません。 現時点では回避策はありません。|
