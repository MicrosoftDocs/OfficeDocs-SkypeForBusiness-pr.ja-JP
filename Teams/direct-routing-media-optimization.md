---
title: ダイレクト ルーティングのためのローカル メディアの最適化
author: CarolynRowe
ms.author: crowe
manager: serdars
ms.date: 04/07/2020
ms.topic: article
ms.service: msteams
audience: admin
ms.collection:
- M365-voice
ms.reviewer: filippse
search.appverid: MET150
f1.keywords:
- NOCSH
description: ダイレクト ルーティングのためのローカル メディアの最適化
appliesto:
- Microsoft Teams
ms.openlocfilehash: ce9d25e84c67f5ae8b3b4fec51535d53f7b0044f
ms.sourcegitcommit: 8f26bf0ff88f1f6881de32914be00d5f0cc7396a
ms.translationtype: MT
ms.contentlocale: ja-JP
ms.lasthandoff: 01/09/2023
ms.locfileid: "69740812"
---
# <a name="plan-for-local-media-optimization-for-direct-routing"></a>ダイレクト ルーティングのローカル メディア最適化を計画する

公衆交換電話網 (PSTN) 音声は、音声品質に大きな期待を持つビジネス クリティカルなアプリケーションと見なされます。 ダイレクト ルーティングを使用すると、メディア トラフィック フローを制御して、世界中のさまざまな企業の多数のネットワーク トポロジとローカル テレフォニー設定に対応できます。

ダイレクト ルーティングのローカル メディア最適化を使用すると、次の方法で音声品質を管理できます。

- Teams クライアントと顧客セッション ボーダー コントローラー (SBC) 間のメディア トラフィックフローの制御。
- 企業ネットワーク サブネットの境界内でメディアをローカルに保つ。
- SBC がプライベート IP を持つ企業ファイアウォールの内側にあり、Microsoft に直接表示されない場合でも、Teams クライアントと SBC 間のメディア ストリームを許可します。

ローカル メディアの最適化では、次の 2 つのシナリオがサポートされています。

- 主要なセッション開始プロトコル (SIP) トランクに接続された一元化された SBC を介して、すべてのローカル トランクを一元化し、会社のすべてのローカル ブランチ オフィスにテレフォニー サービスを提供します。

- SBC の仮想ネットワーク トポロジを構築する -- ローカル ブランチ オフィスの SBC は、外部 IP アドレスを介して Microsoft Phone System に表示され、通信する一元化されたプロキシ SBC に接続されます。 仮想ネットワーク トポロジでは、ダウンストリーム SBC は内部 IP を介して通信しており、電話システムには直接表示されません。

この記事では、機能と顧客のシナリオとソリューションについて説明します。 構成の詳細については、「 [ローカル メディアの最適化の構成](direct-routing-media-optimization-configure.md)」を参照してください。

  > [!NOTE]
  > イントラネットの境界内でメディアをローカルに保持する場合は、ローカル メディアの最適化をお勧めします。 既にメディア バイパスがあり、SBC のパブリック IP アドレスのみを使用している場合は、ローカル メディアの最適化に移行することは必須ではありません。 メディア バイパスは引き続き使用できます。 詳細については、「 [メディア バイパスの計画](direct-routing-plan-media-bypass.md)」を参照してください。

SBC ベンダーがローカル メディアの最適化をサポートする方法については、「 [直接ルーティング用に認定されたセッション ボーダー コントローラー](direct-routing-border-controllers.md)」を参照してください。

## <a name="supported-customer-scenarios"></a>サポートされている顧客シナリオ

この説明では、Contoso が次のように世界中で複数のビジネスを実行しているとします。 (ヨーロッパおよび APAC リージョンは例としてのみ使用されることに注意してください。 ある会社には、似た要件を持つ複数の異なるリージョンがある場合があります)。

- **ヨーロッパでは**、Contoso は約 30 か国にオフィスを持っています。 各オフィスには、独自の Private Branch Exchange (PBX) があります。

  Contoso は、30 のヨーロッパのオフィスすべてに対して、トランクを 1 つの場所 (アムステルダム) に一元化するオプションを提供されました。 Contoso はアムステルダムに SBC を展開し、集中型の場所を経由して通話を実行するのに十分な帯域幅を提供し、中央 SIP トランクを一元化された場所に接続し、アムステルダムからヨーロッパのすべての場所にサービスを提供し始めました。

- **APAC リージョンでは**、Contoso は異なる国に複数のオフィスを持っています。

  多くの国では、同社は引き続きローカルブランチオフィスに時間分割多重(TDM)トランクを持っています。 TDM トランクの集中化は APAC リージョンのオプションではないため、SIP への切り替えは不可能です。 APAC リージョン全体に 50 を超える Contoso ブランチ オフィスがあり、数百のゲートウェイ (SBC) があるとします。 このシナリオでは、パブリック IP アドレスやローカル インターネット ブレークアウトがないため、すべてのゲートウェイを Direct Routing インターフェイスとペアリングすることはできません。 さらに、一部の国では、ローカル PSTN ネットワーク接続がないと満たすことができない規制要件が課されます。

Contoso は、ビジネス要件に基づいて、直接ルーティング用のローカル メディア最適化を使用して次の 2 つのソリューションを実装しました。

- **ヨーロッパでは**、すべてのトランクが一元化され、ユーザーの場所に基づいて中央 SBC とユーザーの間でメディア フローが行われます。

  - ユーザーが企業ネットワークのローカル サブネット (つまり、ユーザーが内部) に接続されている場合、メディアは中央 SBC の内部 IP とユーザーの Teams クライアントの間を流れます。

  - たとえば、ユーザーがパブリック ワイヤレス インターネット接続を使用している場合など、ユーザーが企業ネットワークの境界外にある場合、ユーザーは外部と見なされます。 この場合、メディアは中央 SBC の外部 IP と Teams クライアントの間を流れます。

- **APAC リージョンでは**、集中型プロキシ SBC が Microsoft Direct Routing とペアになり、ダイレクト ルーティング インターフェイスとローカル ブランチ オフィスのダウンストリーム SBC の間でメディアを転送します。

  ローカル ブランチ オフィスのダウンストリーム SBC は、APAC のダイレクト ルーティングには直接表示されませんが、Set-CSOnlinePSTNGateway コマンドレットを使用して Microsoft Phone System 内に仮想ネットワーク トポロジを作成することでペアリングされます。 メディアは可能な限り常にローカルのままです。 外部ユーザーは、Teams クライアントとプロキシ SBC のパブリック IP の間を流れるメディアを持っています。

## <a name="central-sbc-with-centralized-trunks"></a>集中型トランクを備えた中央 SBC

PSTN サービスが、接続された一元化された SIP トランクを持つ 1 つの中央 SBC を介してすべてのローカル ブランチ オフィスに提供されるソリューションを構築するために、Contoso テナント管理者は、1 つの SBC (centralsbc.contoso.com) をサービスとペアリングします。SBC には、一元化された SIP トランクが接続されています。

- ユーザーが会社の内部ネットワークにいる場合、SBC はメディア用の SBC の内部 IP を提供します。

- ユーザーが企業ネットワークの外部にいる場合、SBC は SBC の外部 (パブリック) IP を提供します。

> [!NOTE]
> 例、テーブル、またはダイアグラム内のすべての値は、図の目的でのみ表示されます。

表 1. SBC のネットワーク パラメーターの例

| 場所 | SBC FQDN | 内部サブネット | 外部 NAT (信頼された IP) | SBC 外部 IP アドレス | SBC 内部 IP アドレス |
|:------------|:-------|:-------|:-------|:-------|:-------|
| アムステルダム | centralsbc.contoso.com | 192.168.5.0/24 | 172.16.76.73 | 172.16.76.71 | 192.168.5.5 |
| ドイツ | デプロイされていない | 192.168.6.0/24 | 172.16.76.74 | デプロイされていない |  デプロイされていない |
| フランス | デプロイされていない | 192.168.7.0/24 | 172.16.76.75 | デプロイされていない |  デプロイされていない |

### <a name="internal-user"></a>内部ユーザー

次の図は、ユーザーがユーザーのホーム ブランチ オフィスまたはサイト内の企業ネットワークに接続されている場合のトラフィック フローを示しています。

オンプレミスでは、ユーザーはドイツのローカル ブランチ オフィスに割り当てられます。 ユーザーは、Teams を介してダイレクト ルーティング電話を発信します。

- ユーザーの Teams クライアントは REST API を介して電話システムと直接通信しますが、呼び出し中に生成されたメディアは中央の SBC の内部 IP アドレスに流れます。

- SBC は、フローを電話システムと接続された PSTN ネットワークにリダイレクトします。

- 中央の SBC は、外部 IP アドレスを介してのみ電話システムに表示されます。

図 1. ユーザーが一元化された SBC と接続された一元化された SIP トランクを備えた "ホーム" サイトにいる場合のトラフィック フロー

![トラフィック フローのローカル メディアの最適化を示す図。](media/direct-routing-media-op-1.png "接続された一元化された SIP トランクを使用して一元化された SBC を使用してユーザーが &quot;ホーム&quot; サイトにいる場合のトラフィック フロー")


### <a name="external-user"></a>外部ユーザー

次の図は、ユーザーがオンプレミスではなく、企業ネットワークに接続されていない場合のトラフィック フローを示しています (つまり、ユーザーのデバイスはモバイル デバイスまたはパブリック Wi-Fi 経由でインターネットに接続されています)。 ユーザーは、Teams を介してダイレクト ルーティング電話を発信します。

- ユーザーの Teams クライアントは REST API を介して電話システムと直接通信しますが、この場合、通話中に生成されたメディアは中央の SBC の外部 IP アドレスに流れます。

- SBC は、フローを電話システムと接続された PSTN ネットワークにリダイレクトします。

- 中央の SBC は、外部 IP アドレスを介してのみ電話システムに表示されます。

この場合の動作は、ユーザーがドイツのブランチ オフィスにローカルであるか、他のブランチ オフィスにローカルであるかに関係なく似ています。 ユーザーは企業ネットワークの境界外にあるため、ユーザーは外部と見なされます。

図 2. ユーザーが一元化された SBC と接続された一元化された SIP トランクを使用して外部にある場合のトラフィック フロー

![図は、トラフィック フローのローカル メディアの最適化を示しています。](media/direct-routing-media-op-2.png "接続された一元化された SIP トランクを使用して一元化された SBC の場合、ユーザーが外部にいる場合のトラフィック フロー")

## <a name="proxy-sbc-with-connected-downstream-sbcs"></a>接続されたダウンストリーム SBC を使用した SBC のプロキシ

TDM トランクの集中化がオプションではない APAC リージョンのすべてのローカル ブランチ オフィスで PSTN サービスが提供されるソリューションを構築するために、Contoso 管理者は、プロキシ SBC とも呼ばれる 1 つの SBC (proxysbc.contoso.com) をダイレクト ルーティング サービスとペアリングします。

その後、Contoso 管理者は、プロキシ SBC proxysbc.contoso.com を介して到達できることを示すダウンストリーム SBC をいくつか追加します。 ダウンストリーム SBC にはパブリック IP がありませんが、音声ルートに割り当てることができます。 次の表は、ネットワーク パラメーターと構成の例を示しています。

ダウンストリーム SBC が配置されているローカル ブランチ オフィスにユーザーがいる場合、メディア トラフィックはユーザーとローカル ダウンストリーム SBC の間で直接流れます。 ユーザーがオフィスの外部 (パブリック インターネット上) にある場合、メディアはユーザーからプロキシ SBC のパブリック IP に流れ、関連するダウンストリーム SBC にプロキシします。

表 2. SBC ネットワーク情報の例

| 場所 | SBC FQDN | 内部サブネット | 外部 NAT (信頼された IP) | SBC 外部 IP アドレス  | SBC 内部 IP アドレス |
|:------------|:-------|:-------|:-------|:-------|:-------|
| ベトナム | VNsbc.contoso.com | 192.168.1.0/24 | 172.16.240.110 | なし |  192.168.1.5 |
| インドネシア  | IDsbc.contoso.com | 192.168.2.0/24 | 172.16.240.120 | なし |  192.168.2.5 |
| シンガポール | proxysbc.contoso.com |   192.168.3.0/24 | 172.16.240.130 | 172.16.240.133 | 192.168.3.5 |



### <a name="internal-user"></a>内部ユーザー

次の図は、ユーザーが APAC リージョンのオフィス内にいる場合のシナリオの高レベルのトラフィック フローを示しています。
ベトナムのローカルブランチオフィスに割り当てられ、オンプレミスのユーザーは、Teams を介してダイレクト ルーティング電話を発信します。

- ユーザーの Teams クライアントは REST API を介して電話システムと直接通信しますが、呼び出し中に生成されたメディアはローカル SBC の内部 IP アドレスに流れます。

- ローカル SBC は、フローをシンガポールのプロキシ SBC と接続されたローカル PSTN ネットワークにリダイレクトします。

-  プロキシ SBC は、外部 IP アドレスを介してのみ電話システムに表示され、ダウンストリーム SBC (この場合はベトナムのローカル SBC) から電話システムにフローをルーティングします。

- ローカル ブランチ オフィスのダウンストリーム SBC は電話システムに直接表示されませんが、ローカル メディアの最適化の設定中に Contoso 管理者によって定義された仮想ネットワーク トポロジ内にマップされます。

> [!NOTE]
> 構成されているローカル メディア最適化モードに応じて、ローカル ユーザーとローカル以外のユーザーの動作が異なる場合があります。

使用可能なモードと関連する動作の詳細については、「ローカル メディアの最適化の構成」を参照してください。

図 3. ユーザーがプロキシ SBC と接続されたダウンストリーム SBC を備えた "ホーム" ネットワーク内にある場合のトラフィック フロー

![トラフィック フローのローカル メディアの最適化を再度示す図。](media/direct-routing-media-op-3.png "Traffic flow in case of proxy SBC with connected downstream SBCs when user is in the \"home\" network")

### <a name="external-user"></a>外部ユーザー

次の図は、ユーザーが企業ネットワークの境界外にある場合のトラフィック フローを示しています。 ユーザーはオンプレミスではありません (企業ネットワークの境界内にありません)。 ユーザーは、Teams を介してベトナムの電話番号に直接ルーティング電話を発信します。

- ユーザーの Teams クライアントは REST API を介して電話システムと直接通信しますが、呼び出し中に生成されたメディアは、最初にシンガポールのプロキシ SBC の外部 IP アドレスに流れます。

- 構成と音声ポリシー (詳細については、「 [ローカル メディアの最適化の構成](direct-routing-media-optimization-configure.md) 」を参照) に基づいて、プロキシ SBC はフローをベトナムのダウンストリーム SBC にリダイレクトします。

- ベトナムのダウンストリーム SBC は、接続されたローカル PSTN ネットワークにフローをリダイレクトします。

- プロキシ SBC は、外部 IP アドレスを介してのみ電話システムに表示されます。

-  ローカル ブランチ オフィスのダウンストリーム SBC は電話システムに直接表示されませんが、ローカル メディアの最適化の設定中に Contoso 管理者によって定義された仮想ネットワーク トポロジ内にマップされます。 この例では、ユーザーが企業ネットワークの境界外にあるため、ユーザーは外部と見なされます。

図 4. ユーザーがプロキシ SBC と接続されたダウンストリーム SBC を使用して外部にある場合のトラフィック フロー

![もう一度、トラフィック フローのローカル メディアの最適化を示す図。](media/direct-routing-media-op-4.png "ユーザーが外部にいる場合に接続されたダウンストリーム SBC を使用したプロキシ SBC の場合のトラフィック フロー")

## <a name="local-media-optimization-modes"></a>ローカル メディア最適化モード

ローカル メディアの最適化では、次の 2 つのモードがサポートされています。

- **モード 1: 常にバイパス** します。 この場合、ユーザーが内部にいる場合、メディアは内部ユーザーの実際の場所に関係なく、ローカル ダウンストリーム SBC の内部 IP アドレスを通過します。たとえば、ダウンストリーム SBC が配置されているのと同じブランチ オフィス内や他のブランチ オフィス内などです。

- **モード 2: ローカル ユーザーのみ**。 このモードでは、メディアは、ダウンストリーム SBC と同じブランチ オフィスにある内部ユーザーによって生成された場合にのみ、ローカルダウンストリーム SBC の内部 IP アドレスに直接流されます。

ローカル メディア最適化モードを区別するには、テナント管理者は、Set-CSonlinePSTNGateway コマンドレットを使用して、SBC ごとに -BypassMode パラメーターを 'Always' または 'OnlyForLocalUsers' に設定する必要があります。 詳細については、「 [ローカル メディアの最適化の構成](direct-routing-media-optimization-configure.md)」を参照してください。

> [!NOTE]
> ユーザーが内部の場合は、内部 IP アドレス経由でユーザーと SBC 間のメディア接続が **必要** です。 この場合、SBC はメディア接続用の内部 IP を提供するため、メディアのパブリック トランスポート リレーへのフォールバックはありません。

### <a name="mode-1-always-bypass"></a>モード 1: 常にバイパス

ブランチ オフィス間の接続が良好な場合、推奨モードは常にバイパスです。

たとえば、30 か国にサービスを提供し、30 のサイトとローカル ユーザーの間で良好な接続性を持つ、アムステルダムに一元化された SIP トランクがある会社があるとします。 ドイツには、ローカル SBC が展開されている支店もあります。

ドイツの SBC は、"常にバイパス" モードで構成できます。 ユーザーは、場所に関係なく、SBC の内部 IP アドレスを介して SBC に直接接続します (たとえば、フランスからドイツへ)。参照については、次の図を参照してください。

次の 2 つのシナリオについて説明します。

- シナリオ 1。 ユーザーは、オンライン音声ルーティング ポリシーで定義されている SBC と同じ場所にいます。

- シナリオ 2。 ユーザーとゲートウェイは異なるサイトにあります。

#### <a name="scenario-1-the-user-is-in-the-same-location-as-the-sbc-defined-in-the-online-voice-routing-policy"></a>シナリオ 1。 ユーザーは、オンライン音声ルーティング ポリシーで定義されている SBC と同じ場所にいます

アムステルダムの SBC は、ドイツのローカル ダウンストリーム SBC のプロキシ SBC として構成されています。 ユーザーは、ローカル SBC の企業ネットワークと同じサブネット内のドイツにいます。 両方の SBC (プロキシとダウンストリーム) は、Always Bypass モード用に構成されています。 オンライン音声ルーティング ポリシーでは、ドイツ内の呼び出し (市域コード +49) の場合は、ドイツのローカル SBC にルーティングすることを指定します。 その他のすべての呼び出し-およびドイツの SBC が失敗した場合は、ドイツの呼び出しをアムステルダムのプロキシ SBC にルーティングする必要があります。 次の表は、構成の例をまとめたものです。

表 3. シナリオ 1 の構成例

| ユーザーの物理的な場所 | ユーザーが番号を呼び出す | オンライン音声ルーティング ポリシー | SBC 用に構成されたモード | メディア フロー |
|:------------|:-------|:-------|:-------|:-------|
| ドイツ | +49 1 437 2800 | 優先度 1: ^\+49(\d{8})$ -DEsbc.contoso.com<br>優先度 2: .* - proxysbc.contoso.com| DEsbc.contoso.com – 常にバイパス <br>proxysbc.contoso.com – 常にバイパス | Teams ユーザー < – > DEsbc.contoso.com |

次の図は、ドイツの内部ユーザーが Teams を介してドイツの番号に直接ルーティング電話をかけるトラフィック フローの概要を示しています。

- ユーザーの Teams クライアントは、REST API を介して電話システムと直接通信します。

- 呼び出し中に生成されたメディアは、ローカル SBC の内部 IP アドレスに流れます。

- ローカル SBC は、フローをアムステルダムのプロキシ SBC と接続されたローカル PSTN ネットワークにリダイレクトします。

- プロキシ SBC は、外部 IP アドレスを介してのみ電話システムに表示され、ダウンストリーム SBC (この場合はドイツのローカル SBC) から電話システムにフローをルーティングします。

- ローカル ブランチ オフィスのダウンストリーム SBC は電話システムに直接表示されませんが、ローカル メディアの最適化の設定中に Contoso 管理者によって定義された仮想ネットワーク トポロジ内にマップされます。


図 5.  "Always Bypass" モードのトラフィック フローで、ユーザーが "ホーム" サイトにいます

![トラフィック フローのローカル メディアの最適化を示す図。](media/direct-routing-media-op-5.png "&quot;Always Bypass&quot; モードでユーザーが &quot;ホーム&quot; サイト内にあるトラフィック フロー")


#### <a name="scenario-2-the-user-and-gateways-are-in-different-sites"></a>シナリオ 2: ユーザーとゲートウェイが異なるサイトにある

アムステルダムの SBC は、ドイツのローカル ダウンストリーム SBC のプロキシ SBC として構成されています。 両方の SBC (プロキシとダウンストリーム) は、Always Bypass モード用に構成されています。 フランスの内部ユーザーは、ローカル ブランチ オフィスに配置され、ドイツへの直接ルーティング呼び出しを行っています。 オンライン音声ルーティング ポリシーでは、ドイツへの呼び出し (市域コード +49) をドイツのローカル SBC にルーティングするように指定します。 その他のすべての呼び出し -- ドイツの SBC が失敗した場合は、ドイツのすべての呼び出しをアムステルダムのプロキシ SBC にルーティングする必要があります。 次の表は、構成の例をまとめたものです。

表 4. シナリオ 2 の構成例

| ユーザーの物理的な場所 | ユーザーが番号を呼び出す | オンライン音声ルーティング ポリシー | SBC 用に構成されたモード | メディア フロー |
|:------------|:-------|:-------|:-------|:-------|
| フランス | +49 1 437 2800 | 優先度 1: ^\+49(\d{8})$ -DEsbc.contoso.com <br>優先度 2: .* - proxysbc.contoso.com |  DEsbc.contoso.com – 常にバイパス proxysbc.contoso.com – 常にバイパス | Teams ユーザー < – > DEsbc.contoso.com  |

次の図は、フランスにあるドイツの内部ユーザーが Teams を通じてドイツの番号に直接ルーティング電話をかける場合の、高レベルのトラフィック フローを示しています。

- ユーザーの Teams クライアントは、REST API を介して電話システムと直接通信します。

- 通話中に生成されたメディアは、ドイツの内部 IP アドレスの SBC に直接送信されます。

- ドイツの SBC は、フローをアムステルダムのプロキシ SBC と接続されたローカル PSTN ネットワークにリダイレクトします。

図 6.  "Always Bypass" モードのトラフィック フローで、ユーザーが "ホーム" サイトではなく内部ネットワーク内にある

![図は、トラフィック フローのローカル メディアの最適化を示しています。](media/direct-routing-media-op-6.png "&quot;Always Bypass&quot; モードでユーザーが &quot;ホーム&quot; サイトではなく内部ネットワーク内のトラフィック フロー")

### <a name="mode-2-only-for-local-users"></a>モード 2: ローカル ユーザーのみ

ローカルブランチオフィス間の接続が悪いが、各ローカルブランチオフィスと地域オフィス間の良好な接続がある場合、推奨モードは「ローカルユーザーのみ」です。

たとえば、APAC リージョンでは、Contoso が異なる国に複数のオフィスを持っているとします。 多くの国では、多くのローカル支店にまだ TDM トランクがあるため、SIP への切り替えは不可能です。 TDM トランクの集中化は、APAC リージョンではオプションではありません。 さらに、APAC リージョンには 50 を超える Contoso ブランチ オフィスがあり、数百のゲートウェイ (SBC) があります。

TDM トランクの集中化がオプションではない APAC リージョンのすべてのローカル ブランチ オフィスで PSTN サービスが提供されるソリューションを構築するために、Contoso 管理者はシンガポールの 1 つのリージョン SBC をプロキシ SBC として Direct Routing サービスとペアリングします。 現地支店間の直接接続は良好ではありませんが、シンガポールの各支店と地域のSBCとの間には良好なつながりがあります。 リージョン SBC の場合、管理者は "Always Bypass" モードを選択し、ローカル ダウンストリーム SBC の場合、管理者は [ローカル ユーザーのみ] モードを選択します。

次の 2 つのシナリオについて説明します。

- シナリオ 1。 ユーザーは、オンライン音声ルーティング ポリシーで定義されている SBC と同じ場所にいます

- シナリオ 2。 ユーザーとゲートウェイが異なるサイトに存在する

#### <a name="scenario-1-the-user-is-in-the-same-location-as-the-sbc-defined-in-online-voice-routing-policy"></a>シナリオ 1。 ユーザーは、オンライン音声ルーティング ポリシーで定義されている SBC と同じ場所にいます

シンガポールの SBC が、ベトナムとインドネシアのローカル ダウンストリーム SBC のプロキシ SBC として構成されているとします。 ユーザーは、ローカル SBC と同じ場所内でベトナムにいます。 オンライン音声ルーティング ポリシーでは、ベトナムの呼び出し (市域コード +84) をベトナムのローカル SBC にルーティングするように指定します。 その他のすべての呼び出し--と、ベトナムの SBC が失敗した場合、ベトナムの呼び出しは、シンガポールのプロキシ SBC にルーティングする必要があります。 次の表は、構成の例をまとめたものです。

表 5. "ローカル ユーザーのみ" モードの構成例 シナリオ 1

| ユーザーの物理的な場所 | ユーザーが番号を呼び出す | オンライン音声ルーティング ポリシー | SBC 用に構成されたモード | メディア フロー |
|:------------|:-------|:-------|:-------|:-------|
| ベトナム | +84 4 3926 3000 | 優先度 1: ^\+84(\d{9})$ -VNsbc.contoso.com <br>優先度 2: .* - proxysbc.contoso.com | VNsbc.contoso.com – ローカル ユーザーのみ <br> proxysbc.contoso.com – 常にバイパス | Teams ユーザー < – > VNsbc.contoso.com |

次の図では、ベトナムのローカル ブランチ オフィスに割り当てられたユーザーが、オンプレミスで Teams を介してダイレクト ルーティング電話を発信しています。

- ユーザーの Teams クライアントは、REST API を介して電話システムと直接通信します。

- 呼び出し中に生成されたメディアは、ローカル SBC の内部 IP アドレスに流れます。

- ローカル SBC は、フローをシンガポールのプロキシ SBC と接続されたローカル PSTN ネットワークにリダイレクトします。

- プロキシ SBC は、外部 IP アドレスを介してのみ電話システムに表示され、ダウンストリーム SBC (この場合はベトナムのローカル SBC) から電話システムにフローをルーティングします。

- ローカル ブランチ オフィスのダウンストリーム SBC は電話システムに直接表示されませんが、仮想ネットワーク トポロジ内でマップされます。

図 7. "ローカル ユーザーのみ" モードで、ユーザーが "ホーム" サイト内にあるトラフィック フロー

![トラフィック フローのローカル メディアの最適化を示す別の図。](media/direct-routing-media-op-7.png "&quot;ローカル ユーザーのみ&quot; モードでユーザーが &quot;ホーム&quot; サイト内にあるトラフィック フロー")


#### <a name="scenario-2-the-user-and-gateways-are-in-different-sites"></a>シナリオ 2。 ユーザーとゲートウェイが異なるサイトに存在する

シンガポールの SBC が、ベトナムとインドネシアのローカル ダウンストリーム SBC のプロキシ SBC として構成されているとします。 インドネシアの内部ユーザーは、ローカル支店に配置され、ベトナムへの直接ルーティング呼び出しを行っています。 オンライン音声ルーティング ポリシーでは、ベトナムへの呼び出し (市域コード +84) をベトナムのローカル SBC にルーティングするように指定します。 その他のすべての呼び出し-および、ベトナムの SBC が失敗した場合は、ベトナムへの呼び出しをシンガポールのプロキシ SBC にルーティングする必要があります。 シンガポールのプロキシ SBC は "常にバイパス" モードに設定され、ベトナムのローカル SBC は "ローカル ユーザーのみ" モードに設定されています。 次の表は、構成の例をまとめたものです。

表 6. ユーザー構成

| ユーザーの物理的な場所 | ユーザーが番号を呼び出す | オンライン音声ルーティング ポリシー | SBC 用に構成されたモード | メディア フロー |
|:------------|:-------|:-------|:-------|:-------|
| インドネシア | +84 4 3926 3000 | 優先度 1: ^\+84(\d{9})$ -VNsbc.contoso.com <br> 優先度 2: .* - proxysbc.contoso.com |VNsbc.contoso.com – ローカル ユーザーのみ <br> proxysbc.contoso.com – 常にバイパス | Teams ユーザー < –> proxysbc.contoso.com <–> VNsbc.contoso.com |


次の図では、内部ユーザーは、インドネシアの支店のオンプレミスで、Teams を介してベトナムの番号に直接ルーティング電話を発信します。

- ユーザーの Teams クライアントは、REST API を介して電話システムと直接通信します。

- 呼び出し中に生成されたメディアは、最初に SBC の内部 IP アドレスをプロキシします。

- シンガポールのプロキシ SBC は、フローをベトナムのダウンストリーム SBC の内部 IP アドレスと電話システムにリダイレクトします。

- ベトナムのダウンストリーム SBC は、接続されたローカル PSTN ネットワークにフローをルーティングします。

- プロキシ SBC は、外部 IP アドレスを介してのみ電話システムに表示されます。

- ローカル ブランチ オフィスのダウンストリーム SBC は電話システムに直接表示されませんが、仮想ネットワーク トポロジ内でマップされます。

図 8.  "ローカル ユーザーのみ" モードのトラフィック フローで、ユーザーが "ホーム" サイトではなく内部ネットワーク内にある

![別の図は、トラフィック フローのローカル メディアの最適化を示しています。](media/direct-routing-media-op-8.png "&quot;ローカル ユーザーのみ&quot; モードのトラフィック フローでは、ユーザーは &quot;ホーム&quot; サイトではなく内部ネットワーク内にあります")

## <a name="known-issues"></a>既知の問題

ローカル メディアの最適化に現在存在する既知の問題の一覧を次に示します。 Microsoft では、これらの問題への対処に取り組んでいます。

| 問題 | 回避 策 |
| :--- | :--- |
| Teams クライアントパブリック IP が顧客の信頼された IP リストと一致する場合、Teams クライアントは **内部** として識別されません。 | ローカル メディアの最適化では、Teams クライアント サブネットがテナントで構成された[ネットワーク サブネット](/powershell/module/skype/new-cstenantnetworksubnet)と一致している必要があります|
| Teams クライアントが内部として識別されると、通話のエスカレーションによって呼び出しが削除されます。| ダイレクト ルーティング SBC でローカル メディアの最適化を無効にします。|
| 内部顧客間の 1 から 1 への通話エスカレーションから、外部の顧客/リソースを使用したマルチパーティ呼び出しへの呼び出しの結果、呼び出しが削除されます | 修正プログラムの進行中の作業。 または、ダイレクト ルーティング SBC でローカル メディアの最適化を無効にします。|
| Teams ユーザーは通話を保留にします。 PSTN エンドで音楽が再生され、ローカル メディアの最適化が機能しています。 Teams ユーザーが通話を再開します。 PSTN への呼び出しは再開されますが、ローカル メディアの最適化は機能せず、通話は Central (Proxy) SBC 経由で続行されます | ユーザーが保留 (MoH) を開始するための呼び出しをパークすると、通話コントローラーによって 1:1 からマルチパーティ通話にエスカレートされ、メディア コントローラーとメディア プロセッサ (AVMCU ミキサーとして機能) が呼び出され、MoH が保留されたユーザーに到達します。 呼び出しが再開された後の 1 対 1 の呼び出しへのエスカレーション解除は、設計に従って行われません。 ダイレクト ルーティング SBC でローカル メディアの最適化を無効にします。|
|呼び出しが数秒確立されている間、ユーザーは無音と聞こえる場合があります。| ローカル メディア最適化アーキテクチャの複雑さが原因で、これは場合によっては発生する可能性があります。|
|音声アプリ (自動応答、通話キューなど) は機能しません。| ローカル メディアの最適化では、クラウドに存在し、外部接続が必要なため、Voice Apps はサポートされていません。 Location-Basedルーティングのシナリオについては、「 [音声アプリ (自動応答または通話キュー)」](location-based-routing-plan.md#inbound-calls-through-voice-apps-auto-attendant-or-call-queue)を参照してください。|
