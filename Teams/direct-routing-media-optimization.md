---
title: 直接ルーティングローカル メディアの最適化
author: CarolynRowe
ms.author: crowe
manager: serdars
ms.date: 04/07/2020
ms.topic: article
ms.service: msteams
audience: admin
ms.collection:
- M365-voice
ms.reviewer: filippse
search.appverid: MET150
f1.keywords:
- NOCSH
description: 直接ルーティング用のローカル メディアの最適化
appliesto:
- Microsoft Teams
ms.openlocfilehash: 886dd4d14d8393764f3c939991a8959ed4726aa3
ms.sourcegitcommit: b816ae9de91f3d01e795a69a00465a70003069b2
ms.translationtype: MT
ms.contentlocale: ja-JP
ms.lasthandoff: 12/16/2020
ms.locfileid: "49686463"
---
# <a name="local-media-optimization-for-direct-routing"></a>直接ルーティング用のローカル メディアの最適化

公衆交換電話網 (PSTN) 音声は、音声品質への期待が高いビジネスクリティカルなアプリケーションと見なされます。 ダイレクト ルーティングを使用すると、メディア トラフィック フローを制御して、世界中のさまざまな企業の多数のネットワーク トポロジやローカル テレフォニーセットアップに対応できます。 

直接ルーティング用のローカル メディアの最適化では、次の方法で音声品質を管理できます。

-   Teams クライアントと顧客セッション ボーダー コントローラー (SPC) 間のメディア トラフィックの流れ方法を制御します。
-   企業ネットワーク サブネットの境界内でメディアをローカルに維持する。
-   TEAMS クライアントと SPC 間のメディア ストリームを許可します。SPC がプライベート IP を使用する企業ファイアウォールの背後にいて、Microsoft に直接表示されない場合でも可能です。

ローカル メディア最適化では、次の 2 つのシナリオがサポートされます。

- メインのセッション開始プロトコル (SIP) トランクに接続された一元管理された SBC を介して、すべてのローカル トランクの集中管理を行い、会社のすべての支店にテレフォニー サービスを提供します。

-   ローカルブランチ オフィスの SBC が、外部 IP アドレスを介して Microsoft Phone System に対して表示され、通信できる一元プロキシ SBC に接続される、SBC の仮想ネットワーク トポロジを構築します。 仮想ネットワーク トポロジでは、下流の SPC は内部の IP を介して通信を行い、電話システムに直接表示されません。

この記事では、機能、および顧客のシナリオとソリューションについて説明します。 構成の詳細については、「ローカル メディアの [最適化を構成する」を参照してください](direct-routing-media-optimization-configure.md)。 

  > [!NOTE]
  > イントラネットの境界内でメディアをローカルに維持する場合は、ローカル メディアの最適化をお勧めします。 既にメディア バイパスを使用し、SPC のパブリック IP アドレスのみを使用している場合は、ローカル メディア最適化に移動する必要は必須ではありません。 メディア バイパスは引き続き使用できます。 詳細については、「プラン メディア バイパス [」を参照してください](direct-routing-plan-media-bypass.md)。


## <a name="supported-customer-scenarios"></a>サポートされるお客様のシナリオ

このディスカッションでは、Contoso が次のように世界中で複数の企業を経営している場合を想定します。 (ヨーロッパ地域と APAC 地域は例としてのみ使用されます。 会社は、同じような要件を持つ複数の異なる地域を持っている場合があります)。
 
- **ヨーロッパでは**、Contoso は約 30 か国にオフィスを持っています。 各オフィスには専用のプライベート ブランチ交換 (PBX) があります。 

  Contoso は、ヨーロッパの 30 か所のオフィスすべてについて、1 か所でトランクを一元管理するオプションを提供されました。 Contoso は、一元管理された場所を経由して通話を実行するのに十分な帯域幅を提供し、中央の SIP トランクを一元的な場所に接続して、オランダからすべてのヨーロッパの場所にサービスを提供し始めた、アムステルダムに SBC を展開しました。 

- **APAC 地域では、Contoso** は異なる国に複数のオフィスを持っています。 

  多くの国では、会社は引き続き現地の支店に時間部門多重化 (TDM) トランクを持っています。 TDM トランクの集中化は APAC 地域ではオプションではないので、SIP への切り替えはできません。 APAC 地域全体に、数百のゲートウェイ (SPC) がある 50 以上の Contoso 支店がある場合を想定します。 このシナリオでは、パブリック IP アドレスやローカルインターネット ブレークアウトが不足している場合、すべてのゲートウェイをダイレクト ルーティング インターフェイスにペアリングできません。 さらに、一部の国では、ローカル PSTN ネットワーク接続がないと実現できない規制要件が課されています。

Contoso は、ビジネス要件に基づいて、直接ルーティング用のローカル メディア最適化を使用して 2 つのソリューションを実装しました。

- **ヨーロッパでは**、すべてのトランクが一元管理され、ユーザーの場所に基づいて中央 SBC とユーザー間のメディア フローが行います。 

  - ユーザーが企業ネットワークのローカル サブネットに接続されている場合 (つまり、ユーザーは内部です)、中央 SBC の内部 IP とユーザーの Teams クライアントの間でメディアが流れます。 
  
  - ユーザーが企業ネットワークの境界を超える場合 (たとえば、ユーザーがパブリック ワイヤレス インターネット接続を使用している場合)、ユーザーは外部であると見なされます。 この場合、中央 SBC の外部 IP と Teams クライアントの間でメディアが流れます。

- **APAC 地域** では、一元プロキシ SBC は Microsoft ダイレクト ルーティングとペアリングされ、ローカルブランチ オフィスのダイレクト ルーティング インターフェイスと下流の SBC の間でメディアを転送します。 

  ローカルブランチ オフィスの下流の SPC は APAC のダイレクト ルーティングに直接表示されませんが、microsoft Phone System 内で仮想ネットワーク トポロジを作成するために Set-CSOnlinePSTNGateway コマンドレットを使用してペアリングされます。 メディアは、可能な場合は常にローカルのままです。 外部ユーザーは、Teams クライアントとプロキシ SBC のパブリック IP の間を流れるメディアを持っています。


## <a name="central-sbc-with-centralized-trunks"></a>中央のトランクを備えた中央 SBC

接続された一元的な SIP トランクを使用して、1 つの中央 SBC を介してすべてのローカルブランチ オフィスに PSTN サービスを提供するソリューションを構築するには、Contoso テナント管理者がサービスに 1 つの SBC (centralsbc.contoso.com) をペアにします。SBC には一元的な SIP トランクが接続されています。 

- ユーザーが会社の内部ネットワークに接続している場合、SBC はメディア用の SBC の内部 IP を提供します。 

- ユーザーが企業ネットワークの外部にある場合、SBC は SBC の外部 (パブリック) IP を提供します。

注: 例、テーブル、または図内のすべての値は、図の目的でのみ表示されます。

表 1. SPC のネットワーク パラメーターの例 

| 場所 | SBC FQDN | 内部サブネット | 外部 NAT (信頼済み IP) | SBC 外部 IP アドレス | SBC 内部 IP アドレス |
|:------------|:-------|:-------|:-------|:-------|:-------|
| アムステルダム | centralsbc.contoso.com | 192.168.5.0/24 | 172.16.76.73 | 172.16.76.71 | 192.168.5.5 |
| ドイツ | 展開されていない | 192.168.6.0/24 | 172.16.76.74 | 展開されていない |  展開されていない |
| フランス | 展開されていない | 192.168.7.0/24 | 172.16.76.75 | 展開されていない |  展開されていない ||||


### <a name="internal-user"></a>内部ユーザー

次の図は、ユーザーがユーザーのホーム ブランチ オフィスまたはサイトの企業ネットワークに接続されている場合のトラフィック フローを示しています。 

オンプレミスの場合、ユーザーはドイツの支店に割り当てられます。 ユーザーが Teams を介して直接ルーティング電話を行います。

- ユーザーの Teams クライアントは REST API を通じて電話システムと直接通信しますが、通話中に生成されるメディアは中央の SBC の内部 IP アドレスに流れます。 

- SBC は、フローを電話システムと接続された PSTN ネットワークにリダイレクトします。 

- 中央 SBC は、外部 IP アドレスのみを通じて電話システムに表示されます。 

図 1. 一元管理された SBC と接続された一元的な SIP トランクを使用してユーザーが "ホーム" サイトに入っている場合のトラフィック フロー

![トラフィック フローのローカル メディアの最適化を示す図](media/direct-routing-media-op-1.png "一元管理された SIP トランクを備えた一元管理された SBC を使用して、ユーザーが "自宅" サイトに入っている場合のトラフィック フロー")


### <a name="external-user"></a>外部ユーザー

次の図は、ユーザーがオンプレミスではなく、企業ネットワークに接続されていない場合 (つまり、ユーザーのデバイスがモバイル デバイスまたはパブリック Wi-Fi を介してインターネットに接続されている) 場合のトラフィック フローを示しています。 ユーザーが Teams を介して直接ルーティング電話を行います。

- ユーザーの Teams クライアントは REST API を通じて電話システムに直接通信しますが、この場合、通話中に生成されるメディアは中央の SBC の外部 IP アドレスに流れます。 

- SBC は、フローを電話システムと接続された PSTN ネットワークにリダイレクトします。 

- 中央 SBC は、外部 IP アドレスのみを通じて電話システムに表示されます。 

この場合、ユーザーがドイツの支店のローカルか、他の支店に対しても動作は似ています。 ユーザーが企業ネットワークの境界を超えた場合、ユーザーは外部と見なされます。

図 2. ユーザーが一元管理された SBC を使用し、接続された一元的な SIP トランクを使用して外部にある場合のトラフィック フロー

![トラフィック フローのローカル メディアの最適化を示す図](media/direct-routing-media-op-2.png "一元化された SIP トランクを備えた一元管理された SBC の場合に、ユーザーが外部である場合のトラフィック フロー")

## <a name="proxy-sbc-with-connected-downstream-sbcs"></a>下流の SBC に接続されたプロキシ SBC

TDM トランクの集中化がオプションではない APAC 地域のすべてのローカル支店で PSTN サービスが提供されるソリューションを構築するには、Contoso 管理者はプロキシ SBC とも呼ばれる 1 つの SBC (proxysbc.contoso.com) をダイレクト ルーティング サービスにペアにします。 

その後、Contoso 管理者は、プロキシ SBC 経由でアクセス可能であることを示すいくつかの下流の SBC を追加proxysbc.contoso.com。 ダウン ストリームの SPC にはパブリック IP は割り当てられていないが、音声ルートに割り当てることができます。 次の表は、ネットワーク パラメーターと構成の例を示しています。

ユーザーが、下流の SBC があるローカルブランチ オフィス内にある場合、メディア トラフィックはユーザーとローカルの下流 SBC 間で直接流れます。 ユーザーがオフィスの外部 (パブリック インターネット上) の場合、メディアはユーザーからプロキシ SBC のパブリック IP に流れ、そのメディアは関連する下流の SBC にプロキシします。

表 2. SBC ネットワーク情報の例

| 場所 | SBC FQDN | 内部サブネット | 外部 NAT (信頼済み IP) | SBC 外部 IP アドレス  | SBC 内部 IP アドレス |
|:------------|:-------|:-------|:-------|:-------|:-------|
| ベトナム | VNsbc.contoso.com | 192.168.1.0/24 | 172.16.240.110 | なし |  192.168.1.5 |
| インドネシア  | IDsbc.contoso.com | 192.168.2.0/24 | 172.16.240.120 | なし |  192.168.2.5 |
| シンガポール | proxysbc.contoso.com |   192.168.3.0/24 | 172.16.240.130 | 172.16.240.133 | 192.168.3.5 |



### <a name="internal-user"></a>内部ユーザー 

次の図は、ユーザーが APAC 地域のオフィス内にある場合のシナリオのハイレベル トラフィック フローを示しています。 ユーザーは、ベトナムの支店に割り当て済みで、オンプレミスのユーザーが Teams を介して直接ルーティング電話を行います。 

- ユーザーの Teams クライアントは REST API を通じて電話システムと直接通信しますが、通話中に生成されたメディアはローカル SBC の内部 IP アドレスに流れます。

- ローカル SBC は、シンガポールのプロキシ SBC と接続されているローカル PSTN ネットワークにフローをリダイレクトします。

-  プロキシ SBC は外部 IP アドレスのみを介して電話システムに表示され、下流の SBC (この場合はベトナムのローカル SBC) から電話システムにフローをルーティングします。 

- ローカル ブランチ オフィスの下流の SBC は電話システムに直接表示されませんが、ローカル メディア最適化のセットアップ中に Contoso 管理者によって定義される仮想ネットワーク トポロジ内にマッピングされます。

注: ローカル ユーザーとローカル以外のユーザーの動作は、構成されているローカル メディア最適化モードによって異なる場合があります。 

可能なモードと関連する動作の詳細については、「ローカル メディアの最適化を構成する」を参照してください。

図 3. ユーザーがプロキシ SBC を使用して "ホーム" ネットワーク内にいて、下流の SBC に接続されている場合のトラフィック フロー 

![トラフィック フローのローカル メディアの最適化を示す図](media/direct-routing-media-op-3.png "ユーザーが "ホーム" ネットワークに接続されている場合に、プロキシ SBC が下流の SBC に接続されている場合のトラフィック フロー")

### <a name="external-user"></a>外部ユーザー

次の図は、ユーザーが企業ネットワークの境界を超えた場合のトラフィック フローを示しています。 ユーザーはオンプレミスではありません (企業ネットワークの境界内ではありません)。 ユーザーは、Teams を介してベトナムの電話番号に直接ルーティング電話をかけします。 

- ユーザーの Teams クライアントは REST API を通じて電話システムと直接通信しますが、通話中に生成されるメディアは、最初にシンガポールのプロキシ SBC の外部 IP アドレスに流れます。 

- 構成と音声ポリシー (詳細については「[](direct-routing-media-optimization-configure.md)ローカル メディア最適化の構成」を参照) に基づいて、プロキシ SBC はベトナムの下流の SBC にフローをリダイレクトします。 

- ベトナムの下流の SBC は、接続されたローカル PSTN ネットワークにフローをリダイレクトします。 

- プロキシ SBC は、外部 IP アドレスのみを通じて電話システムに表示されます。

-  ローカル ブランチ オフィスの下流の SBC は電話システムに直接表示されませんが、ローカル メディア最適化のセットアップ中に Contoso 管理者によって定義される仮想ネットワーク トポロジ内にマッピングされます。 この例では、ユーザーが企業ネットワークの境界を超えたため、ユーザーは外部と見なされます。 

図 4. ユーザーがプロキシ SBC を使用して外部にいて、下流の SBC に接続されている場合のトラフィック フロー

![トラフィック フローのローカル メディアの最適化を示す図](media/direct-routing-media-op-4.png "ユーザーが外部である場合に、プロキシ SBC が下流の SBC に接続されている場合のトラフィック フロー")

## <a name="local-media-optimization-modes"></a>ローカル メディア最適化モード

ローカル メディア最適化では、次の 2 つのモードがサポートされます。

- **モード 1: 常にバイパスします**。 この場合、ユーザーが内部である場合、メディアは内部ユーザーの実際の場所に関係なく、ローカルの内部 SBC の内部 IP アドレスを通過します。たとえば、下流の SBC がある同じ支店内、または他の支店内などです。  

- **モード 2: ローカル ユーザーの場合のみ**。 このモードでは、メディアは、下流の SBC と同じブランチ オフィスにある内部ユーザーによって生成された場合にのみ、ローカルの下流 SBC の内部 IP アドレスに直接流れ込む。 

ローカル メディア最適化モードを区別するには、テナント管理者が Set-CSonlinePSTNGateway コマンドレットを使用して、すべての SBC の -BypassMode パラメーターを "Always" または "OnlyForLocalUsers" に設定する必要があります。 詳細については、「ローカル メディアの [最適化を構成する」を参照してください](direct-routing-media-optimization-configure.md)。  

 > [!NOTE]
  > ユーザーが内部の場合は、内部 IP アドレスを使用したユーザーと SBC の間のメディア接続が必要 **です**。 この場合、SBC はメディア接続用の内部 IP を提供する予定です。この場合、メディアのパブリック トランスポート リレーへのフォールバックはありません。 

### <a name="mode-1-always-bypass"></a>モード 1: 常にバイパス

支店間に良好な接続がある場合、推奨モードは常にバイパスです。
 
たとえば、30 か国にサービスを提供し、30 のサイトとローカル ユーザーの間で良好な接続性を持つ、一元的な SIP トランクを持つ会社が、アムステルダムにあるとします。 ドイツには、ローカルの SBC が展開されている支店があります。

ドイツの SBC は、"常にバイパス" モードで構成できます。 ユーザーは、場所に関係なく、SBC の内部 IP アドレス (フランスからドイツなど) を介して SBC に直接接続します (参照については、次の図を参照してください)。

次に、2 つのシナリオについて説明します。

- シナリオ 1。 ユーザーは、オンライン音声ルーティング ポリシーで定義されている SBC と同じ場所にいます。

- シナリオ 2。 ユーザーとゲートウェイは異なるサイトにいます。

#### <a name="scenario-1-the-user-is-in-the-same-location-as-the-sbc-defined-in-the-online-voice-routing-policy"></a>シナリオ 1。 ユーザーがオンライン音声ルーティング ポリシーで定義されている SBC と同じ場所にある

アムステルダムの SBC は、ドイツのローカル下流 SBC のプロキシ SBC に構成されています。 ユーザーは、ローカル SBC の企業ネットワークと同じサブネット内でドイツにいます。 SPC (プロキシと下流) の両方が、常にバイパス モード用に構成されます。 オンライン音声ルーティング ポリシーでは、ドイツ内での通話の場合 (市中コード +49) の場合は、ドイツのローカル SBC にルーティングする必要があります。 その他の通話はすべて、ドイツの SBC が失敗した場合に備え、ドイツでの通話は、アムステルダムのプロキシ SBC にルーティングする必要があります。 次の表に、構成例の概要を示します。 

表 3. シナリオ 1 の構成例

| ユーザーの物理的な場所 | ユーザーが番号を呼び出す | オンライン音声ルーティング ポリシー | SBC 用に構成されたモード | メディア フロー | 
|:------------|:-------|:-------|:-------|:-------|
| ドイツ | +49 1 437 2800 | 優先度 1: ^ \+ 49(\d {8} )$ -DEsbc.contoso.com<br>優先度 2: .* - proxysbc.contoso.com| DEsbc.contoso.com – 常にバイパス <br>proxysbc.contoso.com – 常にバイパス | Teams ユーザー < – > DEsbc.contoso.com |

次の図は、ドイツの内部ユーザーが Teams を介してドイツの番号に直接ルーティング電話を行う場合の、高レベルのトラフィック フローを示しています。 

- ユーザーの Teams クライアントは、REST API を通じて電話システムと直接通信します。 

- 通話中に生成されるメディアは、ローカル SBC の内部 IP アドレスに流れます。 

- ローカル SBC は、フローを、アムステルダムのプロキシ SBC と接続されたローカル PSTN ネットワークにリダイレクトします。 

- プロキシ SBC は外部 IP アドレスのみを介して電話システムに表示され、下流の SBC (この場合はドイツのローカル SBC) から電話システムにフローをルーティングします。 

- ローカル ブランチ オフィスの下流の SBC は電話システムに直接表示されませんが、ローカル メディア最適化のセットアップ中に Contoso 管理者によって定義される仮想ネットワーク トポロジ内にマッピングされます。


図 5.  "常にバイパス" モードでユーザーが "ホーム" サイトに入るトラフィック フロー

![トラフィック フローのローカル メディアの最適化を示す図](media/direct-routing-media-op-5.png ""常にバイパス" モードでユーザーが "ホーム" サイトに入るトラフィック フロー")


#### <a name="scenario-2-the-user-and-gateways-are-in-different-sites"></a>シナリオ 2: ユーザーとゲートウェイが異なるサイトにある

アムステルダムの SBC は、ドイツのローカル下流 SBC のプロキシ SBC に構成されています。 SPC (プロキシと下流) の両方が、常にバイパス モード用に構成されます。 フランスの内部ユーザーは、支店に位置し、ドイツへの直接ルーティング通話を行っています。 オンライン音声ルーティング ポリシーでは、ドイツへの呼び出し (市域コード +49) をドイツのローカル SBC にルーティングする必要があります。 ドイツの SBC が失敗した場合に備え、他のすべての通話は、ドイツのすべての通話を、アムステルダムのプロキシ SBC にルーティングする必要があります。 次の表に、構成例の概要を示します。 

表 4. シナリオ 2 の構成例

| ユーザーの物理的な場所 | ユーザーが番号を呼び出す | オンライン音声ルーティング ポリシー | SBC 用に構成されたモード | メディア フロー | 
|:------------|:-------|:-------|:-------|:-------|
| フランス | +49 1 437 2800 | 優先度 1: ^ \+ 49(\d {8} )$ -DEsbc.contoso.com <br>優先度 2: .* - proxysbc.contoso.com |  DEsbc.contoso.com – 常にバイパスproxysbc.contoso.com – 常にバイパス | Teams ユーザー < – > DEsbc.contoso.com  |

次の図は、フランスに位置するドイツの内部ユーザーが Teams を介してドイツの番号に直接ルーティング電話を行った場合の、高レベルのトラフィック フローを示しています。 

- ユーザーの Teams クライアントは、REST API を通じて電話システムと直接通信します。

- 通話中に生成されるメディアは、ドイツの内部 IP アドレスの SBC に直接流れます。 

- ドイツの SBC は、フローを、アムステルダムのプロキシ SBC と接続されているローカル PSTN ネットワークにリダイレクトします。 

図 6.  "常にバイパス" モードでユーザーが "ホーム" サイトではなく内部ネットワーク内にあるトラフィック フロー

![トラフィック フローのローカル メディアの最適化を示す図](media/direct-routing-media-op-6.png ""常にバイパス" モードでユーザーが "ホーム" サイトではなく内部ネットワーク内にあるトラフィック フロー")

### <a name="mode-2-only-for-local-users"></a>モード 2: ローカル ユーザーのみ

支店間の接続が悪く、支店と支社の間に良好な接続がある場合、推奨モードは "ローカル ユーザーのみ" です。

たとえば、APAC 地域では、Contoso が異なる国に複数のオフィスを持つ場合があります。 多くの国では、多くの支店に引き続き TDM トランクが存在する会社のため、SIP への切り替えはできません。 TDM トランクの集中化は、APAC 地域ではオプションではありません。 さらに、APAC 地域には 50 を超える Contoso 支店が分散し、数百のゲートウェイ (SPC) があります。 

TDM トランクの集中化がオプションではない APAC 地域のすべての支店で PSTN サービスが提供されるソリューションを構築するために、Contoso 管理者はシンガポールの 1 つの地域 SBC をプロキシ SBC と直接ルーティング サービスの間で組み合わせています。 支店間の直接接続は良くはないが、各支店とシンガポールの地域の SBC との間には良好な接続がある。 地域 SBC では、管理者が "常にバイパス" モードを選択し、ローカルの下流の SBC では、管理者が [ローカル ユーザーのみ] モードを選択します。

次に、2 つのシナリオについて説明します。

- シナリオ 1。 ユーザーがオンライン音声ルーティング ポリシーで定義されている SBC と同じ場所にある

- シナリオ 2。 ユーザーとゲートウェイが異なるサイトにある

#### <a name="scenario-1-the-user-is-in-the-same-location-as-the-sbc-defined-in-online-voice-routing-policy"></a>シナリオ 1。 ユーザーがオンライン音声ルーティング ポリシーで定義されている SBC と同じ場所にある

シンガポールの SBC が、ベトナムとインドネシアのローカル下流の SBC のプロキシ SBC に構成されていることを想定します。 ユーザーは、現地の SBC と同じ場所にベトナムにいます。 オンライン音声ルーティング ポリシーでは、ベトナムでの通話 (市域コード +84) をベトナムのローカル SBC にルーティングする必要があります。 その他の通話はすべて、ベトナムの SBC が失敗した場合は、ベトナムでの通話をシンガポールのプロキシ SBC にルーティングする必要があります。 次の表に、構成例の概要を示します。 

表 5. "ローカル ユーザーのみ" モードの構成例シナリオ 1

| ユーザーの物理的な場所 | ユーザーが番号を呼び出す | オンライン音声ルーティング ポリシー | SBC 用に構成されたモード | メディア フロー | 
|:------------|:-------|:-------|:-------|:-------|
| ベトナム | +84 4 3926 3000 | 優先度 1: ^ \+ 84(\d {9} )$ -VNsbc.contoso.com <br>優先度 2: .* - proxysbc.contoso.com | VNsbc.contoso.com – ローカル ユーザーのみ <br> proxysbc.contoso.com – 常にバイパス | Teams ユーザー < – > VNsbc.contoso.com |

次の図では、ユーザーがベトナムの支店に割り当て、オンプレミスで Teams を介して直接ルーティング電話を行っています。 

- ユーザーの Teams クライアントは、REST API を通じて電話システムと直接通信します。 

- 呼び出し中に生成されるメディアは、ローカル SBC の内部 IP アドレスに流れます。 

- ローカル SBC は、シンガポールのプロキシ SBC と接続されているローカル PSTN ネットワークにフローをリダイレクトします。 

- プロキシ SBC は外部 IP アドレスのみを介して電話システムに表示され、下流の SBC (この場合はベトナムのローカル SBC) から電話システムにフローをルーティングします。 

- ローカルブランチ オフィスの下流の SBC は電話システムに直接表示されませんが、仮想ネットワーク トポロジ内にマッピングされます。

図 7. "ローカル ユーザーのみ" モードでユーザーが "ホーム" サイトにあるトラフィック フロー

![トラフィック フローのローカル メディアの最適化を示す図](media/direct-routing-media-op-7.png ""ローカル ユーザーのみ" モードでユーザーが "ホーム" サイトにあるトラフィック フロー")


#### <a name="scenario-2-the-user-and-gateways-are-in-different-sites"></a>シナリオ 2。 ユーザーとゲートウェイが異なるサイトにある

シンガポールの SBC が、ベトナムとインドネシアのローカル下流の SBC のプロキシ SBC に構成されていることを想定します。 現地の支店に位置するインドネシアの内部ユーザーは、ベトナムへの直接ルーティング通話を行っています。 オンライン音声ルーティング ポリシーでは、ベトナムへの通話 (市域コード +84) をベトナムのローカル SBC にルーティングする必要があります。 その他の通話はすべて、ベトナムの SBC が失敗した場合に備え、ベトナムへの通話をシンガポールのプロキシ SBC にルーティングする必要があります。 シンガポールのプロキシ SBC は "Always Bypass" モードに設定され、ベトナムのローカル SBC は "ローカル ユーザーのみ" モードに設定されています。 次の表に、構成例の概要を示します。 

表 6. ユーザー構成

| ユーザーの物理的な場所 | ユーザーが番号を呼び出す | オンライン音声ルーティング ポリシー | SBC 用に構成されたモード | メディア フロー | 
|:------------|:-------|:-------|:-------|:-------|
| インドネシア | +84 4 3926 3000 | 優先度 1: ^ \+ 84(\d {9} )$ -VNsbc.contoso.com <br> 優先度 2: .* - proxysbc.contoso.com |VNsbc.contoso.com – ローカル ユーザーのみ <br> proxysbc.contoso.com – 常にバイパス | Teams ユーザー < –> proxysbc.contoso.com <–> VNsbc.contoso.com |


次の図では、内部ユーザーは、インドネシア支店のオンプレミスで、ベトナムの番号に Teams を介して直接ルーティング電話を行います。 

- ユーザーの Teams クライアントは、REST API を通じて電話システムと直接通信します。

- 最初にプロキシ SBC の内部 IP アドレスにコール フロー中に生成されるメディア。 

- シンガポールのプロキシ SBC は、フローをベトナムの下流の SBC の内部 IP アドレスと電話システムにリダイレクトします。 

- ベトナムの下流 SBC は、接続されたローカル PSTN ネットワークにフローをルーティングします。 

- プロキシ SBC は、外部 IP アドレスのみを通じて電話システムに表示されます。

- ローカルブランチ オフィスの下流の SPC は電話システムに直接表示されませんが、仮想ネットワーク トポロジ内にマッピングされます。

図 8.  "ローカル ユーザーのみ" モードで、ユーザーが "ホーム" サイトではなく内部ネットワーク内にあるトラフィック フロー

![トラフィック フローのローカル メディアの最適化を示す図](media/direct-routing-media-op-8.png ""ローカル ユーザーのみ" モードのトラフィック フロー、ユーザーは "ホーム" サイトではなく内部ネットワーク内にある")

## <a name="known-issues"></a>既知の問題

次に、ローカル メディアの最適化に現在存在する既知の問題の一覧を示します。 Microsoft では、これらの問題の解決に取り組み中です。

| 問題 | 回避策 |
| :--- | :--- |
| Teams クライアントのパブリック IPが顧客の信頼済み IP リストと一致する場合、Teams クライアントは内部として識別されません。 | ローカル メディアの最適化では、Teams クライアントサブネットがテナントで構成されたネットワーク サブネットと一致 [する必要がある](https://docs.microsoft.com/powershell/module/skype/new-cstenantnetworksubnet?view=skype-ps)|
| Teams クライアントが内部として識別されると、通話のエスカレーションによって通話がドロップされます。| ダイレクト ルーティング SBC でローカル メディアの最適化を無効にします。|


