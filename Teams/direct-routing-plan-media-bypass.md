---
title: ダイレクト ルーティングでメディア バイパスを計画する
ms.author: crowe
author: CarolynRowe
manager: serdars
ms.audience: ITPro
ms.reviewer: NMuravlyannikov
ms.topic: article
ms.service:
- msteams
ms.prod: skype-for-business-itpro
localization_priority: Normal
search.appverid: MET150
ms.collection: Teams_ITAdmin_Help
appliesto:
- Microsoft Teams
description: 電話システムの直接のルーティングのメディア バイ パスを計画する方法の詳細については、このトピックを参照してください。
ms.openlocfilehash: b3a31e23ef065840d830c111c64e0618d90aa71b
ms.sourcegitcommit: 856793c99fc02fb016383d0b6f8411c386d78886
ms.translationtype: MT
ms.contentlocale: ja-JP
ms.lasthandoff: 04/12/2019
ms.locfileid: "31827882"
---
# <a name="plan-for-media-bypass-with-direct-routing"></a>ダイレクト ルーティングでメディア バイパスを計画する

## <a name="about-media-bypass-with-direct-routing"></a>直接ルーティングでのメディア バイ パスについて

メディア バイ パスを使用すると、メディア トラフィックのパスを短くして、パフォーマンス向上のための転送中にホップの数を減らすことができます。 メディアのバイパスをメディアは、セッション ボーダー コント ローラー (SBC) と Microsoft の電話システムを使用して送信する代わりにクライアントの間で保持されます。 メディアを構成するのには、SBC とクライアントのバイパスは、同じ場所またはネットワークでなければなりません。

各 SBC のメディア バイ パスを制御するには、**セット CSOnlinePSTNGateway**コマンドを使用するには true または false に設定 **- MediaBypass**パラメーターを使用しています。 メディアのバイパスを有効にした場合とメディアのすべてのトラフィックが企業ネットワークの範囲内に収まることは限りません。 この資料では、さまざまなシナリオでの呼び出しの流れを説明します。    

次の図は、呼び出しの流れとメディア バイ パスなしの違いを示しています。

メディアのバイパスのないクライアントまたは呼び出しを受信するとシグナリングとメディアの両方フロー、SBC、Microsoft の電話システムとクライアント間で、チーム、次の図に示すように。

![番組の信号およびメディア バイ パスなしのメディア フロー](media/direct-routing-media-bypass-1.png)


ですが、同じ建物や、SBC とネットワークのユーザーであると仮定します。 たとえば、PSTN のユーザーへの呼び出しにより、フランクフルトでの建物内にあるユーザーを想定しています。 

- **メディアなしをバイパス**するには、メディアは、アムステルダムまたはダブリン (マイクロソフトのデータ センターが展開されている) を使用して、フランクフルトで SBC をフローします。 

  SBC は、ヨーロッパでは、マイクロソフトでは、SBC に最も近いデータ センターは、ヨーロッパのデータ センターが選択されます。 このアプローチは、ほとんどの地域で Microsoft ネットワーク内のトラフィック フローの最適化のための通話の音質には影響しません、トラフィックが不要なループします。     

- メディアは**メディアをバイパス**するには、チームのユーザーと、次の図に示すようの間で直接保持されます。

![番組の信号とメディアは、メディア バイ パスの流れ](media/direct-routing-media-bypass-2.png)

メディアでは、チームのクライアントと氷に、SBC のライトで対話型の接続の確立 (ICE) と呼ばれる活用してプロトコルをバイパスします。 これらのプロトコルでは、最適な品質に最も直接のメディアのパスを使用する直接ルーティングを有効にします。 氷と氷のライトは、WebRTC の標準です。 これらのプロトコルの詳細については、RFC 5245 を参照してください。


## <a name="call-flow-and-firewall-planning"></a>通話フロー、およびファイアウォールの計画

通話フロー、およびファイアウォールの計画は、ユーザーが、SBC のパブリック IP アドレスへの直接アクセスを持っているかどうかと、ユーザーは、内部または外部ネットワークかどうかによって異なります。

### <a name="call-flow-if-the-user-has-direct-access-to-the-public-ip-address-of-the-sbc"></a>ユーザーが、SBC のパブリック IP アドレスへの直接アクセスを持っている場合、通話フロー

ユーザーに、SBC のパブリック IP アドレスへの直接アクセスがある場合は、呼び出しの流れのとおりです。

- メディアのバイパス、チームのクライアント アクセス権が必要、SBC のパブリック IP アドレスに内部ネットワークからもします。 ダイレクト ・ メディアは、必要ない場合、メディア トランスポート リレー経由で流れることができます。

- ユーザーは、同じ建物や、SBC とネットワークで、これは、推奨されるソリューション – メディア パスからマイクロソフト クラウド コンポーネントを削除します。

- 信号を常には、マイクロソフトのクラウド経由で送られます。

次の図は、メディアをバイパスすると、呼び出しの流れが有効になっている、クライアントは、内部および SBC (ダイレクト ・ メディア) のパブリック IP アドレスにアクセスできるクライアントを示しています。 

- 矢印と数値を指定のパスの[マイクロソフトのチームは、フローを呼び出す](https://docs.microsoft.com/microsoftteams/microsoft-teams-online-call-flows)資料です。

- パス 4 は、常に SIP シグナリングと 4' (トラフィックの方向) に依存します。 メディアは、ローカルのままし、5 b のパスは、です。

![メディア バイ パスの呼び出しの流れを示していますが有効になっている場合、クライアントは内部であり、セッション ボーダー コント ローラー (ダイレクト ・ メディア) のパブリック ip アドレスに到達することができます。](media/direct-routing-media-bypass-3.png)


### <a name="call-flow-if-the-user-does-not-have-access-to-the-public-ip-address-of-the-sbc"></a>ユーザーには、SBC のパブリック IP アドレスへのアクセスがない場合、通話フロー

次に示しますユーザーには、SBC のパブリック IP アドレスへのアクセスがない場合の呼び出しの流れを。 

たとえば、ユーザーが外部にあり、テナント管理者がマイクロソフト クラウドに移行するだけですが、インターネット上ですべてのユーザーに、SBC のパブリック IP アドレスを開かないことにしました。 トラフィックの内部コンポーネントは、チーム ・ トランスポート ・ リレー経由で流れることができます。 これは、企業ネットワーク外部のユーザーに対して推奨される構成です。 次の点に注意してください。

- チームのトランスポートのリレーを使用します。

- メディアのバイパスには、マイクロソフトは、(3478 と 3479 だけのポートを必要とするバージョンに移行する計画は将来) で 50 000 に 59 999 チームのトランスポートのリレーと、SBC との間の範囲のポートを開く必要がありますトランスポート リレーのバージョンを使用します。

- メディアの最適化のために、トランスポートのリレーをチームにのみ、SBC のパブリック IP アドレスを開くをお勧めします。 企業ネットワークの外部クライアントは、トランスポートのリレーを使用して、SBC のパブリック IP アドレスを直接に到達するのではなくをお勧めします。

メディアをバイパスすると、呼び出しの流れが有効になっている、クライアントは、外部クライアントは、セッション ボーダー コント ローラー (メディアはチームのトランスポートのリレーで中継) のパブリック IP アドレスに到達できない次の図を示しています。

- 矢印と数値を指定のパスの[マイクロソフトのチームは、フローを呼び出す](https://docs.microsoft.com/microsoftteams/microsoft-teams-online-call-flows)資料です。

- メディアは、パス 3、3'、4 を使用して中継は、4'

![ユーザーに、SBC のパブリック ip アドレスへのアクセスがないかどうかは呼び出しのフローを示しています)](media/direct-routing-media-bypass-4.png)


### <a name="call-flow-if-a-user-is-outside-the-network-and-has-access-to-the-public-ip-of-the-sbc"></a>フローを呼び出す場合は、ユーザーはネットワークの外部であり、SBC のパブリック ip アドレスへのアクセス

> [!NOTE]
> これは推奨される構成には利用できませんトランスポート リレーのチームのためです。 代わりに、場所、ユーザーには、SBC のパブリック IP アドレスへのアクセスはありません、前のシナリオを検討してください。 

メディアをバイパスすると、呼び出しの流れが有効になっている、クライアントは、外部、および SBC (ダイレクト ・ メディア) のパブリック IP アドレスがクライアントに到達できる次の図を示しています。

- 矢印と数値を指定のパスの[マイクロソフトのチームは、フローを呼び出す](https://docs.microsoft.com/microsoftteams/microsoft-teams-online-call-flows)資料です。

- パス 3 は、常に SIP シグナリングおよび 3' (トラフィックの方向) に依存します。 メディア フローが 2 のパスを使用します。

![ユーザーに、SBC のパブリック ip アドレスへのアクセスがないかどうかは呼び出しのフローを示しています)](media/direct-routing-media-bypass-5.png)


## <a name="use-of-media-processors-and-transport-relays"></a>メディア プロセッサとトランスポートのリレーを使用

メディア トラフィックをパスすることができるマイクロソフトのクラウドでは、2 つのコンポーネントがあります: メディア プロセッサとトランスポートのリレーです。 

- メディア プロセッサは、非バイパスの場合は、メディアを処理し、音声アプリケーション用にメディアを処理するパブリック向けコンポーネントです。

   メディア プロセッサは、常にバイパスされる呼び出しのパスのことはありませんが、非バイパスの呼び出しをエンド ・ ユーザーのパスにします。 メディア プロセッサは、コール パーク、組織の自動応答を呼び出してキューなどのすべての音声アプリケーションのパスには常にします。

- トランスポートのリレーを使用して、リアルタイムのトラフィックを送信する最も近いトランスポート サービスに接続します。

   トランスポートのリレーは、バイパスされる呼び出し--元または - であるし、ネットワークの構成方法に応じて、エンド ・ ユーザー宛てのパスにあります。

無効には、次の図は、– 2 つの呼び出しのフローを示しています。 1 つはメディア バイ パスが有効になっている、2 番目はメディアから省略。 注ダイアグラムには、--元、またはエンド ・ ユーザーに送信されるトラフィックのみ示しています。  
- メディア コント ローラーは、Azure メディア プロセッサの割り当てし、セッション記述プロトコル (SDP) の提供を作成するには microservice です。

- SIP プロキシは、SIP をチームで使用されている HTTP の残りの信号に変換するコンポーネントです。    

![– メディア バイ パスが有効になっていると、メディア バイ パスが無効になっているもう一方の 2 つの呼び出しフローを示しています)](media/direct-routing-media-bypass-6.png)


次の表は、メディア プロセッサとトランスポートの中継の違いをまとめたものです。

|    | メディア プロセッサ | トランスポート リレー|
| :--------------|:---------------|:------------|
エンド ・ ユーザーのための呼び出しの非バイパスのメディアのパスで | いつも | ぜんぜん | 
エンド ・ ユーザーの呼び出しがバイパスされるため、メディア パスに | ぜんぜん | クライアントは、SBC のパブリック IP アドレスに到達できない場合 | 
音声アプリケーションのメディア パスに | いつも | ぜんぜん | 
トランス コード (B2BUA) を行うことができます。\* | はい | いいえ、エンドポイント間の音声を中継のみ | 
世界中のインスタンスの数と場所 | 合計 8: 2 では、米国の東と西。アムステルダム、ダブリン。2 香港とシンガポールです。(Q1CY2019 に追加されている) 日本で 2  | 複数

IP の範囲は、52.112.0.0/14 (IP アドレス 52.112.0.1 から 52.115.255.254 に)。 

\*トランス コードの説明: 

- メディア プロセッサでは、B2BUA、コーデック (たとえば、絹チーム クライアントから MP と MP と SBC の G.711) を変更できることを意味します。

- トランスポートのリレーは、リレー経由でのトラフィック フローを使用する場合でも、コーデックは、クライアントと、SBC--の間は変更されませんを意味する B2BUA ではありません。

### <a name="use-of-teams-transport-relays-in-escalation-scenarios-if-trunk-is-configured-for-media-bypass"></a>チームのトランスポートの中継のトランクは、メディアに対して構成されている場合、エスカレーションのシナリオでの使用を回避します。

トランスポート リレーのチームは、次のシナリオでのメディアのパスでは常に。

- グループの呼び出しを 1:1 からの呼び出しがエスカレートします。
- 呼び出しが連合チームのユーザーになります。
- 呼び出しを転送またはビジネス ユーザーは、Skype に転送

SBC が次のように、トランスポート中継へのアクセスを持つことを確認します。    


## <a name="sip-signaling-fqdns-and-firewall-ports"></a>SIP シグナル: Fqdn およびファイアウォールのポート

SIP シグナリングでは、FQDN とファイアウォールの要件が省略されていない場合と同じです。 

直接ルーティングするための接続ポイントは、次の 3 つの Fqdn です。

- **sip.pstnhub.microsoft.com** – グローバル FQDN – が最初に試行する必要があります。 SBC では、この名前を解決するのには要求を送信するとき、Microsoft Azure の DNS サーバーは、SBC にプライマリの Azure データ センターを指す IP アドレスが割り当てられているを返します。 割り当ては、データ センターおよび、SBC に地理的な近接性のパフォーマンスの測定値に基づいています。 返された IP アドレスは、プライマリの FQDN に対応します。

- **sip2.pstnhub.microsoft.com** – セカンダリ FQDN – は、2 番目の優先度の領域に地理的にマップします。

- **sip3.pstnhub.microsoft.com** – 第 3 FQDN – は、3 番目の優先度の領域に地理的にマップします。

これらのための 3 つの Fqdn を配置する必要があります。

- (小さい読み込まれ、最初の FQDN を照会することによって割り当てられている SBC のデータ センターに最も近い) の最適なエクスペリエンスを提供します。

- SBC からの接続が確立されると、一時的な問題が発生しているデータ センターへのフェイル オーバーを提供します。 詳細については、次のフェイル オーバー ・ メカニズムを参照してください。


Fqdn の**sip.pstnhub.microsoft.com**、 **sip2.pstnhub.microsoft.com**、および**sip3.pstnhub.microsoft.com**は、次の IP アドレスのいずれかに解決されます。
- 52.114.148.0
- 52.114.132.46
- 52.114.75.24
- 52.114.76.76
- 52.114.7.24
- 52.114.14.70

シグナル用とアドレスからの着信および発信トラフィックを許可するファイアウォールでこれらのすべての IP アドレスのポートを開く必要があります。 お使いのファイアウォールでは、DNS 名をサポートする場合上記のすべての IP アドレスを**sip all.pstnhub.microsoft.com**の FQDN を解決します。 次のポートを使用する必要があります。

| トラフィック | 開始 | 終了 | 送信元ポート | 宛先ポート|
| :-------- | :-------- |:-----------|:--------|:---------|
SIP や TLS| SIP プロキシ | SBC | 1024-65535 | SBC で定義されています。 |
| SIP や TLS | SBC | SIP プロキシ | SBC で定義されています。 | 5061 |


## <a name="media-traffic-ip-and-port-ranges"></a>メディア トラフィック: ip アドレスとポートの範囲

メディア トラフィック フロー SBC およびチームのクライアントとの間の直接接続がある場合、またはチームのトランスポートのリレーを使用して、クライアントがパブリック IP アドレスを使用して、SBC に到達できない場合。

### <a name="requirements-for-direct-media-traffic-between-the-teams-client-and-the-sbc"></a>(チームのクライアントと、SBC) の間の直接のメディア トラフィックの要件 

クライアントには、SBC のパブリック IP アドレスでは、(表を参照)、指定したポートにアクセス必要があります。 

注: クライアントが内部ネットワーク内にある場合は、メディア、SBC のパブリック IP アドレスに回り込みます。 NAT デバイスの hairpinning を構成するには、トラフィックがエンタープライズ ネットワーク機器を送信しないようにします。

| トラフィック | 開始 | 終了 | 送信元ポート | 宛先ポート|
| :-------- | :-------- |:-----------|:--------|:---------|
UDP または SRTP | クライアント | SBC | 50 000 – 50 019  | SBC で定義されています。 |
| UDP または SRTP | SBC | クライアント | SBC で定義されています。 | 50 000 – 50 019  |


注: クライアントの発信元ポートを変換するネットワーク デバイスを使っている場合を確認してくださいネットワーク機器との間で翻訳済みのポートが開かれることです。 

### <a name="requirements-for-using-transport-relays"></a>トランスポートのリレーを使用するための要件

(非バイパスの場合) のメディア プロセッサと同じ範囲では、トランスポートのリレー: 52.112.0.0/14 (IP アドレス 52.112.0.1 から 52.115.255.254 に)。

チームのトランスポートの中継のポートの範囲は、次の表で示されます。


| トラフィック | 開始 | 終了 | 送信元ポート | 宛先ポート|
| :-------- | :-------- |:-----------|:--------|:---------|
UDP または SRTP | トランスポート リレー | SBC | 50 000-59 999    | SBC で定義されています。 |
| UDP または SRTP | SBC | トランスポート リレー | SBC で定義されています。 | 50 000 – 59 999、3478、3479     |


注: マイクロソフトは、SBC の同時呼び出しごとに少なくとも 2 つのポートをお勧めします。 Microsoft には、トランスポートの中継の 2 つのバージョンがあるため、次が必要です。

- v4 で、50 000 に 59 999 のポート範囲を操作できます。

- v6 で、使用可能なポート 3478、3479

この時点では、メディアは、トランスポートの中継の v4 バージョンのみをサポートしていますをバイパスします。 紹介 v6 のサポート、将来的にします。 

3478 と 3479 を遷移させるためにポートを開放する必要があります。 マイクロソフトでは、メディア バイ パスと v6 のトランスポート リレーのサポートが導入されて、ときに、ネットワーク機器または SBCs を再構成する必要はありません。 

### <a name="requirements-for-using-media-processors"></a>メディア プロセッサを使用するための要件

メディア プロセッサは、常に音声アプリケーションのメディア パスにします。 要件は、非バイパスの構成と同じです。


メディア トラフィック用の IP の範囲は、52.112.0.0/14 (IP アドレス 52.112.0.1 から 52.115.255.254 に)。

メディア プロセッサのポートの範囲は、次の表で示されます。

| トラフィック | 開始 | 終了 | 送信元ポート | 宛先ポート|
| :-------- | :-------- |:-----------|:--------|:---------|
UDP または SRTP | メディア プロセッサ | SBC | 49 152 – 53 247    | SBC で定義されています。 |
| UDP または SRTP | SBC | メディア プロセッサ | SBC で定義されています。 | 49 152 – 53 247     |

## <a name="considerations-if-you-have-skype-for-business-phones-in-your-network"></a>ビジネス電話のネットワークでの Skype をした場合の考慮事項  

直接ルーティングの場合は - を使用しているネットワークでのビジネスの端点を Skype がある場合など、チームがユーザーのビジネス クライアント--Skype に基づく 3PIP 電話を持つことができますこれらのユーザーにサービスを提供するトランクのメディア バイ パス無効でなければなりません。

これらのユーザーの独立したトランクを作成して、オンライン音声ルーティング ポリシーを割り当てることです。

高度な構成手順を実行します。

- タイプ]: ユーザーに 3PIP の電話が持っているかどうかどうかに応じて、ユーザーを分割します。

- 異なる Fqdn を持つ 2 つの独立したトランクを作成する: いずれかの有効にメディアをバイパスします。他のないです。 

  両方のトランクは、同じ SBC をポイントします。 TLS の SIP シグナリング用のポートが異なる必要があります。 メディア用のポートを同じにする必要があります。

- オンラインの音声ルーティング ポリシーのユーザーの種類に応じて適切なトランクを割り当てます。

次の例は、このロジックを示しています。

| ユーザーの設定 | ユーザーの数 | トランクの FQDN が OVRP に割り当てられています。 | メディア バイ パスが有効になっています。 |
| :------------ |:----------------- |:--------------|:--------------|
チーム クライアントおよび 3PIP の電話を持つユーザー | 20 | sbc1.contoso.com:5061 | false | 
(新しい電話がチームの認定を含む) のみのチームの端点を持つユーザー | 980 | sbc2.contoso.com:5060 | true

両方のトランクは、同じパブリック IP アドレスと同じ SBC を指すことができます。 TLS を SBC のポートの信号は、次の図に示すようである必要があります。 証明書が両方のトランクをサポートしているかどうかを確認する必要があります注意してください。 SAN では、(**sbc1.contoso.com**および**sbc2.contoso.com**) の 2 つの名前またはワイルドカード証明書が存在する必要があります。


![表示の両方のトランクは、同じパブリック ip アドレスと同じ SBC を指すことができます)](media/direct-routing-media-bypass-7.png)

同じ SBC の 2 つのトランクを構成する方法の詳細については、SBC の製造元によって提供されるマニュアルを参照してください。

- AudioCodes
- リボン
- TE ・ システム (Anynode)   

## <a name="client-endpoints-supported-with-media-bypass"></a>メディアでサポートされているクライアントのエンドポイントを使用しません。

通知があるまでチームの Web クライアント以外、チームのすべてのエンドポイントでは、メディア バイ パスがサポートされます。 

場合マイクロソフトのエッジ、Google のクロムや Mozilla の Firefox のチームの Web アプリケーションは、ユーザーは、このようなユーザーに対してメディア バイ パスをオフにする必要があります。 メディアのバイパスが有効になっているトランクを使用して、将来的に呼び出すことを紹介します。   
 
## <a name="see-also"></a>関連項目

[ダイレクト ルーティングでメディア バイパスを構成する](direct-routing-configure-media-bypass.md)



