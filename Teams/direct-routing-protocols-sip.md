---
title: 電話システムのダイレクト ルーティング
author: CarolynRowe
ms.author: crowe
manager: serdars
ms.date: 01/28/2019
ms.topic: article
ms.service: msteams
audience: admin
ms.collection:
- Teams_ITAdmin_Help
- M365-voice
ms.reviewer: nmurav
search.appverid: MET150
f1.keywords:
- NOCSH
description: ダイレクト ルーティング プロトコル
appliesto:
- Microsoft Teams
ms.openlocfilehash: 4fe636029c3a058dc1a8d33cc191d7654888ec5e
ms.sourcegitcommit: 414d077b16a0ae4ea6a49e3b3d0082858174cacb
ms.translationtype: MT
ms.contentlocale: ja-JP
ms.lasthandoff: 02/17/2021
ms.locfileid: "50278727"
---
# <a name="direct-routing---sip-protocol"></a>ダイレクト ルーティング - SIP プロトコル

この記事では、ダイレクト ルーティングがセッション開始プロトコル (SIP) を実装する方法について説明します。 セッション ボーダー コントローラー (SBC) と SIP プロキシの間でトラフィックを適切にルーティングするには、一部の SIP パラメーターに特定の値が必要です。 この記事は、オンプレミスの SBC と SIP プロキシ サービス間の接続の構成を担当する音声管理者を対象にしています。

## <a name="processing-the-incoming-request-finding-the-tenant-and-user"></a>着信要求の処理: テナントとユーザーの検索

着信通話または発信通話を処理する前に、OPTIONS メッセージは SIP プロキシと SBC の間で交換されます。 これらのオプション メッセージでは、SIP プロキシが SBC に許可される機能を提供できます。 OPTIONS の交渉を成功 (200OK 応答) し、通話を確立するために SBC と SIP プロキシの間でさらに通信できるようにすることが重要です。 SIP プロキシへの OPTIONS メッセージの SIP ヘッダーは、次の例として提供されます。

| パラメーター名 | 値の例 | 
| :---------------------  |:---------------------- |
| Request-URI | OPTIONS sip:sip.pstnhub.microsoft.com:5061 SIP /2.0 |
| ヘッダー経由 | 経由: SIP/2.0/TLS sbc1.adatum.biz:5058;alias;branch=z9hG4bKac2121518978 | 
| Max-Forwards ヘッダー | 最大転送数:68 |
| ヘッダーから | [From Header From]: <sip:sbc1.adatum.biz:5058> |
| ヘッダーへ | 宛先： <sip:sip.pstnhub.microsoft.com:5061> |
| CSeq ヘッダー | CSeq: 1 回の招待 | 
| 連絡先ヘッダー | 連絡先: <sip:sbc1.adatum.biz:50588;transport=tls> |

> [!NOTE]
> SIP ヘッダーには、使用されている SIP URI に userinfo は含されません。 RFC [3261 のセクション 19.1.1](https://tools.ietf.org/html/rfc3261#section-19.1.1)に基いて、URI の userinfo 部分は省略可能であり、宛先ホストにユーザーの考え方が存在しない場合や、アドレス自体が識別されるリソースである場合には存在しない場合があります。 SIP URI に @ 記号が存在する場合、ユーザー フィールドを空にすることはできません。

着信通話では、SIP プロキシは通話の宛先のテナントを見つけて、このテナント内の特定のユーザーを見つける必要があります。 テナント管理者は、複数のテナントで非 DID 番号 (+1001 など) を構成できます。 そのため、複数の Microsoft 365 または Office 365 組織では DID 以外の番号が同じになる可能性があるため、番号参照を実行する特定のテナントを見つけるのが重要です。  

このセクションでは、SIP プロキシがテナントとユーザーを検索し、受信接続で SBC の認証を実行する方法について説明します。

着信通話での SIP 招待メッセージの例を次に示します。

| パラメーター名 | 値の例 | 
| :---------------------  |:---------------------- |
| Request-URI | SIP sip:+18338006777@sip.pstnhub.microsoft.com 2.0 を招待する |
| ヘッダー経由 | 経由: SIP/2.0/TLS sbc1.adatum.biz:5058;alias;branch=z9hG4bKac2121518978 | 
| Max-Forwards ヘッダー | 最大転送数:68 |
| ヘッダーから | From Header From: <sip:7168712781@sbc1.adatum.biz;transport=udp;tag=1c747237679 |
| ヘッダーへ | To: sip:+183338006777@sbc1.adatum.biz | 
| CSeq ヘッダー | CSeq: 1 回の招待 | 
| 連絡先ヘッダー | 連絡先: <sip: 68712781@sbc1.adatum.biz:5058;transport=tls> | 

招待を受信すると、SIP プロキシは次の手順を実行します。

1. 証明書を確認します。 最初の接続では、ダイレクト ルーティング サービスは、連絡先ヘッダーに表示される FQDN 名を受け取り、それを表示された証明書の共通名または件名の代替名と一致します。 SBC 名は、次のいずれかのオプションと一致している必要があります。

   - オプション 1。 連絡先ヘッダーに表示される完全な FQDN 名は、提示された証明書の共通名/件名の代替名と一致している必要があります。  

   - オプション 2。 連絡先ヘッダーに表示される FQDN 名のドメイン部分 (たとえば、FQDN 名 sbc1.adatum.biz の adatum.biz) は、共通名/件名の代替名 (*.adatum.biz など) のワイルドカード値と一致している必要があります。

2. 連絡先ヘッダーに表示される完全な FQDN 名を使用してテナントを検索してみてください。  

   連絡先ヘッダー (sbc1.adatum.biz) の FQDN 名が、Microsoft 365 または Office 365 組織の DNS 名として登録されていないか確認します。 見つかった場合、ユーザーの参照は、SBC FQDN がドメイン名として登録されているテナントで実行されます。 見つからない場合は、手順 3 が適用されます。   

3. 手順 3 は、手順 2 が失敗した場合にのみ適用されます。 

   連絡先ヘッダー (FQDN: sbc12.adatum.biz、ホスト部分を削除した後に adatum.biz) に表示される FQDN からホスト部分を削除し、この名前が Microsoft 365 または Office 365 組織で DNS 名として登録されていないか確認します。 見つかった場合、ユーザー参照は、このテナントで実行されます。 見つからない場合、通話は失敗します。

4. Request-URI に表示される電話番号を使用して、手順 2 または 3 で見つかったテナント内で逆番号参照を実行します。 表示された電話番号を、前の手順で見つかったテナント内のユーザー SIP URI と一致します。

5. トランク設定を適用します。 この SBC のテナント管理者によって設定されたパラメーターを見つける。

   Microsoft では、Microsoft SIP プロキシとペアリングされた SBC の間にサードパーティ SIP プロキシまたはユーザー エージェント サーバーを設定することはできません。これは、ペアリングされた SBC によって作成された要求 URI を変更する可能性があります。

   1 つの SBC が多数のテナントに相互接続されるシナリオに必要な 2 つの参照 (手順 2 と 3) の要件については、この記事の後半で説明します。

### <a name="detailed-requirements-for-contact-header-and-request-uri"></a>連絡先ヘッダーと要求-URI の詳細な要件

#### <a name="contact-header"></a>連絡先ヘッダー

Microsoft SIP プロキシへのすべての受信 SIP メッセージ (オプション、INVITE) の場合、連絡先ヘッダーには、次のように URI ホスト名にペアリングされた SBC FQDN が含まれています。

構文: 連絡先: <: SBC;transport=tls address@FQDN sip:phone または sip> 

RFC [3261 のセクション 11.1](https://tools.ietf.org/html/rfc3261#section-11.1)で説明すると、連絡先ヘッダー フィールドが OPTIONS メッセージに表示される場合があります。 直接ルーティングでは、連絡先ヘッダーが必要です。 上記の形式の INVITE メッセージの場合、OPTIONS メッセージの場合、ユーザー情報を SIP URI から削除し、次のように形式で送信される FQDN のみを削除できます。

構文: 連絡先: <SBC の sip:FQDN;transport=tls>

この名前 (FQDN) は、表示された証明書の [共通名] フィールドまたは [件名の代替名] フィールドにも含まれる必要があります。 Microsoft では、証明書の [共通名] フィールドまたは [Subject Alternative Name] フィールドで名前のワイルドカード値を使用できます。   

ワイルドカードのサポートについては [、RFC 2818 のセクション 3.1 を参照してください](https://tools.ietf.org/html/rfc2818#section-3.1)。 具体的には：

*"名前には、単一のドメイン名コンポーネントまたはコンポーネントフラグメントと一致すると見なされるワイルドカード \* 文字が含まれている可能性があります。例: .a.com はfoo.a.com \* 一致bar.foo.a.com。f .com はfoo.com一致しますが \* 、bar.com。*

SIP メッセージに表示される連絡先ヘッダーの複数の値が SBC によって送信される場合、連絡先ヘッダーの最初の値の FQDN 部分だけが使用されます。

直接ルーティングの原則として、FQDN を使用して IP の代わりに SIP URI を設定することが重要です。 ホスト名が FQDN ではなく IP で表される連絡先ヘッダーを含む SIP プロキシへの着信 INVITE または OPTIONS メッセージ。接続は 403 禁止で拒否されます。

#### <a name="request-uri"></a>Request-URI 

すべての着信通話の場合、Request-URI は電話番号とユーザーを一致するために使用されます。   

現在、次の例に示すように、電話番号にはプラス記号 (+) が含まれている必要があります。 

```console
INVITE sip:+18338006777@sip.pstnhub.microsoft.com SIP /2.0
```

## <a name="contact-and-record-route-headers-considerations"></a>連絡先とヘッダーRecord-Routeに関する考慮事項

SIP プロキシは、ダイアログ内の新しいクライアント トランザクション (Bye や Re-Invite など) および SIP オプションに返信するときに、次のホップ FQDN を計算する必要があります。 連絡先または連絡先Record-Routeが使用されます。 

RFC [3261 セクション 8.1.1.8](https://tools.ietf.org/html/rfc3261#section-8.1.1.8)によると、新しいダイアログが表示される可能性があるすべての要求で連絡先ヘッダーが必要です。 このRecord-Routeは、プロキシがダイアログで今後の要求のパスにとどまる必要がある場合にのみ必要です。 プロキシ SBC が直接ルーティング用[](https://docs.microsoft.com/MicrosoftTeams/direct-routing-media-optimization)のローカル メディア最適化で使用されている場合、プロキシ SBC がルート内に残る必要がある場合は、レコード ルートを構成する必要があります。 

プロキシ SBC が使用されていない場合は、連絡先ヘッダーのみを使用する方法をお勧めします。

- [RFC 3261、セクション 20.30、Record-Route](https://tools.ietf.org/html/rfc3261#section-20.30)では、プロキシがダイアログで今後の要求のパスを把握する必要がある場合に使用されます。これは、すべてのトラフィックが Microsoft SIP プロキシとペアリングされた SBC の間のすべてのトラフィックを行う場合にプロキシ SBC が構成されていない場合は不可欠ではありません。 

- Microsoft SIP プロキシは、送信 ping オプションを送信するときに、連絡先ヘッダー (レコード ルートではない) のみを使用して次のホップを決定します。 2 つのパラメーター (連絡先とレコード ルート) の代わりに 1 つのパラメーター (連絡先) のみを構成すると、プロキシ SBC が使用されていない場合の管理が簡素化されます。 

次のホップを計算するために、SIP プロキシは次を使用します。

- 優先度 1。 トップ レベルのレコード ルート。 トップ レベルのドメインRecord-Route FQDN 名が含まれている場合、FQDN 名を使用して送信のダイアログ内接続が作成されます。

- 優先度 2. 連絡先ヘッダー。 存在Record-Route場合、SIP プロキシは連絡先ヘッダーの値を参照して送信接続を作成します。 (推奨される構成です)。

連絡先と連絡先の両方Record-Route使用する場合、SBC 管理者は値を同じに保つ必要があります。この場合、管理オーバーヘッドが発生します。 

### <a name="use-of-fqdn-name-in-contact-or-record-route"></a>連絡先または連絡先での FQDN 名のRecord-Route

IP アドレスの使用は、連絡先または連絡先Record-Routeサポートされていません。 サポートされるオプションは FQDN のみです。このオプションは、SBC 証明書の共通名または件名の代替名と一致する必要があります (証明書のワイルドカード値はサポートされます)。

- IP アドレスがレコード ルートまたは連絡先に表示されている場合、証明書の確認は失敗し、通話は失敗します。

- FQDN が提示された証明書の Common または Subject Alternative Name の値と一致しない場合、呼び出しは失敗します。 

## <a name="inbound-call-sip-dialog-description"></a>着信通話: SIP ダイアログの説明

次の表は、非バイパス モードとバイパス モードのコール フローの相違点と類似点をまとめた表です。

| パラメーター名 | バイパスモード以外 | バイパス モード
| :---------------------  |:---------------------- |:----------------|
| 183 件と 200 件のメッセージからのメディア候補 | メディア プロセッサ | クライアント | 
| SBC が受信できる 183 件のメッセージの数 | セッションごとに 1 つ | 倍数 | 
| 通話は仮の応答で行えます (183) | はい | はい |
| 通話は仮の応答なしで行える (183) | はい | はい |

###  <a name="non-media-bypass-flow"></a>メディア以外のバイパス フロー

Teams ユーザーは、同時に複数のエンドポイントを持っている可能性があります。 たとえば、Teams for Windows クライアント、Teams for iPhone クライアント、Teams Phone (Teams Android クライアント) などです。 各エンドポイントは、HTTP 残りを次のように信号する場合があります。

-   通話の進行状況 – SIP プロキシによって SIP メッセージ 180 に変換されます。 メッセージ 180 を受信する場合、SBC はローカル呼び出し音を生成する必要があります。

-   メディア応答 – SIP プロキシによってメッセージ 183 に変換され、セッション記述プロトコル (SDP) のメディア候補が表示されます。 メッセージ 183 を受信すると、SBC は SDP メッセージで受信したメディア候補に接続する予定です。 

    > [!NOTE]
    > 場合によっては、メディアの回答が生成されない可能性があります。また、終了点が "通話承諾" メッセージで応答する場合があります。

-   通話受け入れ – SDP を使用して SIP プロキシによって SIP メッセージ 200 に変換されます。 メッセージ 200 を受信すると、SBC は提供された SDP 候補者に対してメディアを送受信する予定です。

#### <a name="multiple-endpoints-ringing-with-provisional-answer"></a>暫定応答で呼び出される複数のエンドポイント

1.  SBC から最初の招待を受信すると、SIP プロキシは "SIP SIP/2.0 100 試用中" というメッセージを送信し、着信通話についてすべてのエンド ユーザー エンドポイントに通知します。 

2.  通知すると、各エンドポイントが呼び出しを開始し、"通話の進行状況" メッセージを SIP プロキシに送信します。 Teams ユーザーは複数のエンドポイントを持つ可能性があるため、SIP プロキシは複数の通話進行状況メッセージを受信する場合があります。

3.  クライアントから受信された通話の進行状況メッセージごとに、SIP プロキシは通話の進行状況メッセージを SIP メッセージ "SIP SIP/2.0 180 Trying" に変換します。 このようなメッセージを送信する間隔は、通話コントローラーからの受信メッセージの間隔によって定義されます。 次の図では、SIP プロキシによって生成された 2 つの 180 メッセージがあります。 これらのメッセージは、ユーザーの 2 つの Teams エンドポイントから送信されます。 クライアントごとに一意のタグ ID があります。  異なるエンドポイントからのすべてのメッセージは個別のセッションになります ("To" フィールドのパラメーター "tag" は異なります)。 ただし、次の図に示すように、エンドポイントによってメッセージ 180 が生成され、メッセージ 183 が今すぐ送信されない場合があります。

4.  エンドポイントが、エンドポイントのメディア候補の IP アドレスを含む Media Answer メッセージを生成すると、SIP プロキシは、受信したメッセージを"SIP 183 セッションの進行状況" メッセージに変換し、クライアントから SDP をメディア プロセッサから SDP に置き換えます。 次の図では、Fork 2 のエンドポイントが通話に応答しました。 トランクがバイパスされていない場合、183 SIP メッセージは 1 回だけ生成されます (リング ボットまたはクライアント エンドポイント)。 183 は、既存のフォークに接続されている場合や、新しいフォークを開始する場合があります。

5.  通話受け入れメッセージは、通話を受け入れるエンドポイントの最終的な候補と一緒に送信されます。 通話受け入れメッセージは SIP メッセージ 200 に変換されます。 

> [!div class="mx-imgBorder"]
> ![暫定応答で呼び出される複数のエンドポイントを示す図](media/direct-routing-protocols-1.png)

#### <a name="multiple-endpoints-ringing-without-provisional-answer"></a>暫定応答なしで呼び出される複数のエンドポイント

1.  SBC から最初の招待を受信すると、SIP プロキシは "SIP SIP/2.0 100 試用中" というメッセージを送信し、着信通話についてすべてのエンド ユーザー エンドポイントに通知します。 

2.  通知すると、各エンドポイントが呼び出しを開始し、"通話の進行状況" というメッセージを SIP プロキシに送信します。 Teams ユーザーは複数のエンドポイントを持つ可能性があるため、SIP プロキシは複数の通話進行状況メッセージを受信する場合があります。

3.  クライアントから受信された通話の進行状況メッセージごとに、SIP プロキシは通話の進行状況メッセージを SIP メッセージ "SIP SIP/2.0 180 Trying" に変換します。  メッセージを送信する間隔は、通話コントローラーからメッセージを受信する間隔によって定義されます。 下の図では、SIP プロキシによって生成された 2 つの 180 メッセージがあります。つまり、ユーザーは 3 つの Teams クライアントにログインし、各クライアントは通話の進行状況を送信します。 すべてのメッセージは個別のセッションになります ("To" フィールドのパラメーター "tag" は異なります)。

4.  通話受け入れメッセージは、通話を受け入れるエンドポイントの最終的な候補と一緒に送信されます。 通話受け入れメッセージは SIP メッセージ 200 に変換されます。 

> [!div class="mx-imgBorder"]
> ![暫定応答なしで呼び出される複数のエンドポイントを示す図](media/direct-routing-protocols-2.png)

### <a name="media-bypass-flow"></a>メディア バイパス フロー

メディア バイパスのシナリオでは、同じメッセージ (100 の試用、180、183) が使用されます。 

次のスキーマは、バイパスコール フローの例を示しています。 

> [!NOTE]
> メディア候補は、異なるエンドポイントから取得できます。 

> [!div class="mx-imgBorder"]
> ![暫定応答で呼び出される複数のエンドポイントを示す図](media/direct-routing-protocols-3.png)

## <a name="replaces-option"></a>[置換] オプション

SBC では、置換後の招待をサポートする必要があります。

## <a name="size-of-sdp-considerations"></a>SDP の考慮事項のサイズ

ダイレクト ルーティング インターフェイスは、1,500 バイトを超える SIP メッセージを送信する場合があります。  主に SDP のサイズが原因です。 ただし、SBC の背後に UDP トランクがある場合、Microsoft SIP プロキシから変更されていないトランクに転送された場合、メッセージは拒否されることがあります。 メッセージを UDP トランクに送信するときに、SBC の SDP で一部の値を除去する方法をお勧めします。 たとえば、ICE 候補や未使用のコーデックを削除できます。

## <a name="call-transfer"></a>通話の転送

ダイレクト ルーティングでは、通話転送の 2 つの方法がサポートされています。

- オプション 1。 SIP プロキシ プロセスは、クライアントをローカルに参照し、RFC 3892 のセクション 7.1 で説明されているレフェリーとして機能します。

  このオプションを使用すると、SIP プロキシは転送を終了し、新しい招待を追加します。 


- オプション 2。 SIP プロキシは SBC の参照を送信し、RFC 5589 のセクション 6 で説明する転送者として機能します。

  このオプションを使用すると、SIP プロキシは SBC を参照し、SBC が転送を完全に処理する予定です。

SIP プロキシは、SBC によって報告された機能に基づいてメソッドを選択します。 SBC がメソッド "Refer" をサポートしている場合、SIP プロキシは通話転送にオプション 2 を使用します。

Refer メソッドがサポートされているメッセージを送信する SBC の例を次に示します。

```console
ALLOW: INVITE, OPTIONS, INFO, BYE, CANCEL, ACK, PRACK, UPDATE, REFER, SUBSCRIBE, NOTIFY
```

SBC がサポートされている方法として参照する方法を示さなかった場合、ダイレクト ルーティングではオプション 1 (SIP プロキシがレフェリーとして機能) を使用します。 また、SBC は Notify メソッドをサポートしているという通知も行う必要があります。

Refer メソッドがサポートされていないことを示す SBC の例:

```console
ALLOW: INVITE, ACK, CANCEL, BYE, INFO, NOTIFY, PRACK, UPDATE, OPTIONS
```

### <a name="sip-proxy-processes-refer-from-the-client-locally-and-acts-as-a-referee"></a>SIP プロキシ プロセスクライアントをローカルに参照し、レフェリーとして機能する

SBC が Refer メソッドがサポートされていないと示した場合、SIP プロキシはレフェリーとして機能します。 

クライアントから送信される参照要求は、SIP プロキシで終了します。 (クライアントからの参照要求は、次の図に "Dave への通話転送" と表示されています。  詳細については [、RFC 3892 のセクション 7.1 を参照してください](https://www.ietf.org/rfc/rfc3892.txt)。 

> [!div class="mx-imgBorder"]
> ![暫定応答で呼び出される複数のエンドポイントを示す図](media/direct-routing-protocols-4.png)

### <a name="sip-proxy-send-the-refer-to-the-sbc-and-acts-as-a-transferor"></a>SIP プロキシは SBC を参照し、転送者として機能します

これは通話転送に推奨される方法であり、メディア バイパス認定を求めているデバイスには必須です。 SBC が Refer を処理できない場合の呼び出し転送は、メディア バイパス モードではサポートされません。 

この標準については、RFC 5589 のセクション 6 で説明します。 関連する RFC は次のとおりです。

- [セッション開始プロトコル (SIP) 通話制御 - 転送](https://tools.ietf.org/html/rfc5589)

- [セッション開始プロトコル (SIP) の "Replaces" ヘッダー](https://tools.ietf.org/html/rfc3891)

- [セッション開始プロトコル (SIP) "参照者" メカニズム](https://tools.ietf.org/html/rfc3892)

このオプションは、SIP プロキシが転送者として機能し、SBC に参照メッセージを送信すると想定します。 SBC は譲渡先として機能し、参照を処理して、新しい譲渡オファーを生成します。 次の 2 つのケースが考えられる。

- 通話は外部 PSTN 参加者に転送されます。 
- 通話は、1 人の Teams ユーザーから SBC 経由で同じテナント内の別の Teams ユーザーに転送されます。 

通話が SBC を介して Teams ユーザー間で転送される場合、SBC は参照メッセージで受信した情報を使用して転送先 (Teams ユーザー) に対して新しい招待 (新しいダイアログを開始) を発行する予定です。 

要求のトランザクションの To/Transferor フィールドを内部的に設定するには、SIP プロキシが REFER-TO/REFERRED-BY ヘッダー内でこの情報を伝達する必要があります。 

SIP プロキシは、ホスト名の SIP プロキシ FQDN と次のいずれかで構成される SIP URI として REFER-TO を形成します。

- 転送先が電話番号である場合の URI のユーザー名部分の E.164 電話番号。

- 完全転送ターゲットの XML とテナント ID をそれぞれエンコードする x-m パラメーターと x-t パラメーター 

REFERRED-BY ヘッダーは、次の表に示すように、転送者のテナント ID と他の転送コンテキスト パラメーターと同様に、転送者の URI がエンコードされた SIP URI です。

| パラメーター | 値 | 説明 |  
|:---------------------  |:---------------------- |:---------------------- |
| x-m | [影付き] | CC によって入力される転送先/転送ターゲットの完全な B/CS |
| x-t | テナント ID | CC によって入力される x-t テナント ID オプションのテナント ID |
| x-ti | Transferor Correlation Id | 転送者への呼び出しの関連付け ID |
| x-tt | 転送ターゲット呼び出し URI | エンコードされた呼び出しの置き換え URI |

この場合、参照ヘッダーのサイズは最大 400 の記号を指定できます。 SBC は、最大 400 記号のサイズの参照メッセージの処理をサポートする必要があります。

> [!div class="mx-imgBorder"]
> ![暫定応答で呼び出される複数のエンドポイントを示す図](media/direct-routing-protocols-5.png)

## <a name="session-timer"></a>セッション タイマー

SIP プロキシは(常に) バイパス以外の呼び出しでセッション タイマーをサポートしますが、バイパス呼び出しでは提供しません。 SBC によるセッション タイマーの使用は必須ではありません。

##  <a name="use-of-request-uri-parameter-userphone"></a>Request-URI パラメーター user=phone の使用

SIP プロキシは Request-URI を分析し、パラメーター user=phone が存在する場合、サービスは Request-URI を電話番号として処理し、番号をユーザーに照合します。 パラメーターが存在しない場合、SIP プロキシは、Request-URI ユーザー タイプ (電話番号または SIP アドレス) を決定するためにヒューリスティックを適用します。

Microsof では、通話セットアップ プロセスを簡略化するために、常に user=phone パラメーターを適用する方法をお勧めします。

## <a name="history-info-header"></a>History-Info ヘッダー

History-Info ヘッダーは、SIP 要求のターゲットを変更し、ネットワークおよびエンド ユーザー向けのさまざまなサービスを有効にするための要求履歴情報をキャプチャするための標準的なメカニズムを提供するために使用されます。 詳細については [、RFC 4244 – セクション 1.1 を参照してください](http://www.ietf.org/rfc/rfc4244.txt)。 Microsoft Phone System の場合、このヘッダーは Simulring と Call Forwarding のシナリオで使用されます。  

送信する場合、次History-Info有効になります。

- SIP プロキシは、PSTN コントローラーに送信されるヘッダーを構成する個々History-Infoエントリに、関連付けられた電話番号を含History-Infoパラメーターを挿入します。  電話番号パラメーターを持つエントリのみを使用して、PSTN コントローラーは新しい History-Info ヘッダーを再構築し、SIP プロキシ経由で SIP トランク プロバイダーに渡します。

- History-Infoが同時呼び出しと呼び出しの転送ケースに追加されます。

- History-Info転送ケースのヘッダーは追加されません。

- 再構築された History-Info ヘッダーの個々の履歴エントリには、URI のホスト部分として設定されたダイレクト ルーティング FQDN (sip.pstnhub.microsoft.com) と組み合わせて提供される電話番号パラメーターが含まれます。'user=phone' のパラメーターは SIP URI の一部として追加されます。  電話コンテキスト パラメーターを除き、元の History-Info ヘッダーに関連付けられているその他のパラメーターは、再構築されたヘッダーHistory-Infoされます。  

  > [!NOTE]
  > (RFC 4244 のセクション 3.3 で定義されているメカニズムによって決定される) プライベートなエントリは、SIP トランク プロバイダーが信頼できるピアのため、この方法で転送されます。

- 受信History-Infoは無視されます。

SIP プロキシによって送信される履歴情報ヘッダーの形式を次に示します。

```console
<sip:UserB@sip.pstnhub.microsoft.com?Privacy=history&Reason=SIP%3B\cause%3D486>;index=1.2,
```

呼び出しが数回リダイレクトされた場合、すべてのリダイレクトに関する情報が時系列順に適切な理由で含まれます。


ヘッダーの例:

```console
History-info: 
<sip:+14257123456@sip.pstnhub.microsoft.com;user=phone?Reason=SIP;cause=302;text=”Move Temporarily”>;index=1
<sip:+14257123457@sip.pstnhub.microsoft.com;user=phone?Reason=SIP;cause=496;text=”User Busy”>;index=1.1
```

このHistory-Infoは、必須の TLS メカニズムによって保護されます。 

## <a name="sbc-connection-to-direct-routing-and-failover-mechanism"></a>ダイレクト ルーティングとフェールオーバー メカニズムへの SBC 接続

「ダイレクト ルーティングの計画」の「SIP シグナリングの [フェールオーバー メカニズム」セクションを参照してください](direct-routing-plan.md#failover-mechanism-for-sip-signaling)。

## <a name="retry-after"></a>Retry-After

ダイレクト ルーティング データセンターがビジー状態の場合、サービスは 1 秒の間隔で Retry-Afterメッセージを SBC に送信できます。 SBC が INVITE に応答して Retry-After ヘッダーを含む 503 メッセージを受信した場合、SBC は接続を終了し、次に利用可能な Microsoft データセンターを試す必要があります。 

## <a name="ice-restart-media-bypass-call-transferred-to-an-endpoint-that-does-not-support-media-bypass"></a>ICE 再起動: メディア バイパスをサポートしていないエンドポイントに転送されるメディア バイパス呼び出し

SBC は [、RFC 5245 のセクション 9.1.1.1](https://tools.ietf.org/html/rfc5245#section-9.1.1.1)で説明されている ICE の再起動をサポートする必要があります。

ダイレクト ルーティングでの再起動は、RFC の次の段落に従って実装されます。

*ICE を再起動するには、エージェントがオファーのメディア ストリームの ice-pwd と ice-ufrag の両方を変更する必要があります。 1 つのオファーでセッション レベル属性を使用し、後続のオファーでメディア レベル属性と同じ ice-pwd または ice-ufrag を提供することが許可されることに注意してください。 これはパスワードの変更ではなく、単なる表記の変更であり、ICE の再起動を引き起こすのではありません。*

*エージェントは、このメディア ストリームの最初のオファーと同様に、SDP の残りのフィールドをこのメディア ストリームに設定します (セクション 4.3 を参照)。 その結果、候補者のセットには、そのストリームの以前の候補者の一部、なし、またはすべての候補者が含まれる場合があります。また、セクション 4.1.1 で説明したように、全く新しい候補者のセットが含まれる場合があります。*

通話が最初にメディア バイパスで確立され、通話が Skype for Business クライアントに転送される場合、ダイレクト ルーティングはメディア プロセッサを挿入する必要があります。これは、メディア バイパスを使用して Skype for Business クライアントで直接ルーティングを使用できないためです。 直接ルーティングでは、ice-pwd と ice-ufrag を変更し、新しいメディア候補を再指定することで ICE 再起動プロセスを開始します。 


