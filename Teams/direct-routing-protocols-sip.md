---
title: 電話システムのダイレクト ルーティング
author: CarolynRowe
ms.author: crowe
manager: serdars
ms.date: 01/28/2019
ms.topic: article
ms.service: msteams
audience: admin
ms.collection:
- Teams_ITAdmin_Help
- M365-voice
ms.reviewer: nmurav
search.appverid: MET150
f1.keywords:
- NOCSH
description: ダイレクト ルーティング プロトコル
appliesto:
- Microsoft Teams
ms.openlocfilehash: 04e9507595ef721ced5d47eb58646559601c5cab
ms.sourcegitcommit: 8750f98d59e74e3835d762d510fb0e038c8f17eb
ms.translationtype: MT
ms.contentlocale: ja-JP
ms.lasthandoff: 04/20/2021
ms.locfileid: "51899128"
---
# <a name="direct-routing---sip-protocol"></a>ダイレクト ルーティング - SIP プロトコル

この記事では、ダイレクト ルーティングがセッション開始プロトコル (SIP) を実装する方法について説明します。 セッション ボーダー コントローラー (SBC) と SIP プロキシの間でトラフィックを適切にルーティングするには、一部の SIP パラメーターに特定の値が必要です。 この記事は、オンプレミスの SBC と SIP プロキシ サービス間の接続を構成する音声管理者を対象にしています。

## <a name="processing-the-incoming-request-finding-the-tenant-and-user"></a>受信要求の処理: テナントとユーザーの検索

着信または送信呼び出しを処理する前に、SIP プロキシと SBC の間で OPTIONS メッセージが交換されます。 これらの OPTIONS メッセージを使用すると、SIP プロキシは SBC に許可されている機能を提供できます。 OPTIONS ネゴシエーションが成功する (200OK 応答) ため、SBC と SIP プロキシの間で通話を確立するための通信をさらに可能にすることが重要です。 SIP プロキシへの OPTIONS メッセージの SIP ヘッダーは、次の例として提供されます。

| パラメーター名 | 値の例 | 
| :---------------------  |:---------------------- |
| Request-URI | OPTIONS sip:sip.pstnhub.microsoft.com:5061 SIP /2.0 |
| ヘッダー経由 | Via: SIP/2.0/TLS sbc1.adatum.biz:5058;alias;branch=z9hG4bKac2121518978 | 
| Max-Forwardsヘッダー | Max-Forwards:68 |
| [ヘッダーから] | From Header From: <sip:sbc1.adatum.biz:5058> |
| ヘッダーへ | 宛先： <sip:sip.pstnhub.microsoft.com:5061> |
| CSeq ヘッダー | CSeq: 1 INVITE | 
| 連絡先ヘッダー | 連絡先: <sip:sbc1.adatum.biz:50588;transport=tls> |

> [!NOTE]
> SIP ヘッダーには、使用されている SIP URI に userinfo が含まれています。 RFC [3261、セクション 19.1.1](https://tools.ietf.org/html/rfc3261#section-19.1.1)に基いて、URI の userinfo 部分は省略可能であり、宛先ホストにユーザーの考え方が存在しない場合、または hosst 自体が識別されるリソースである場合は、存在しない可能性があります。 @記号が SIP URI に存在する場合、ユーザー フィールドは空にすることはできません。

着信呼び出しでは、SIP プロキシは、呼び出しの宛先であるテナントを検索し、このテナント内の特定のユーザーを見つける必要があります。 テナント管理者は、複数のテナントで非 DID 番号 (+1001 など) を構成する場合があります。 そのため、複数の Microsoft 365 組織または 365 組織で DID 以外の番号が同じになる可能性があるため、番号検索を実行する特定のテナントを見Office重要です。  

このセクションでは、SIP プロキシがテナントとユーザーを検索し、受信接続で SBC の認証を実行する方法について説明します。

着信呼び出しでの SIP 招待メッセージの例を次に示します。

| パラメーター名 | 値の例 | 
| :---------------------  |:---------------------- |
| Request-URI | SIP sip:+18338006777@sip.pstnhub.microsoft.com /2.0 を招待する |
| ヘッダー経由 | Via: SIP/2.0/TLS sbc1.adatum.biz:5058;alias;branch=z9hG4bKac2121518978 | 
| Max-Forwardsヘッダー | Max-Forwards:68 |
| [ヘッダーから] | From Header From: <sip:7168712781@sbc1.adatum.biz;transport=udp;tag=1c747237679 |
| ヘッダーへ | To: sip:+183338006777@sbc1.adatum.biz | 
| CSeq ヘッダー | CSeq: 1 INVITE | 
| 連絡先ヘッダー | 連絡先: <sip: 68712781@sbc1.adatum.biz:5058;transport=tls> | 

招待を受信すると、SIP プロキシは次の手順を実行します。

1. 証明書を確認します。 最初の接続では、ダイレクト ルーティング サービスは、連絡先ヘッダーに表示される FQDN 名を受け取り、提示された証明書の共通名またはサブジェクト代替名と一致します。 SBC 名は、次のいずれかのオプションと一致する必要があります。

   - オプション 1。 連絡先ヘッダーに表示される完全な FQDN 名は、提示された証明書の共通名/サブジェクト代替名と一致する必要があります。  

   - オプション 2。 連絡先ヘッダー (FQDN 名 sbc1.adatum.biz の adatum.biz など) に表示される FQDN 名のドメイン部分は、共通名/サブジェクト代替名 (例: *.adatum.biz) のワイルドカード値と一致する必要があります。

2. 連絡先ヘッダーに表示される完全な FQDN 名を使用してテナントを検索してみてください。  

   連絡先ヘッダー (sbc1.adatum.biz) の FQDN 名が、Microsoft 365 組織または 365 組織の DNS 名として登録Office確認します。 見つかった場合は、SBC FQDN がドメイン名として登録されているテナントでユーザーのルックアップが実行されます。 見つからない場合は、手順 3 が適用されます。   

3. 手順 3 は、手順 2 が失敗した場合にのみ適用されます。 

   ホスト部分 adatum.biz を削除した後、連絡先ヘッダー (FQDN: sbc12.adatum.biz) に表示されている FQDN からホスト部分を削除し、この名前が Microsoft 365 組織または Office 365 組織で DNS 名として登録Office確認します。 見つかった場合、ユーザールックアップは、このテナントで実行されます。 見つからない場合、呼び出しは失敗します。

4. Request-URI に示されている電話番号を使用して、手順 2 または 3 で見つかったテナント内で逆引き番号ルックアップを実行します。 前の手順で見つかったテナント内のユーザー SIP URI に、提示された電話番号を一致します。

5. トランク設定を適用します。 この SBC のテナント管理者によって設定されたパラメーターを見つける。

   Microsoft は、Microsoft SIP プロキシとペアリングされた SBC の間にサード パーティの SIP プロキシまたはユーザー エージェント サーバーを持つことをサポートしません。これは、ペアの SBC によって作成された要求 URI を変更する可能性があります。

   1 つの SBC が多数のテナント (キャリア シナリオ) に相互接続されるシナリオに必要な 2 つのルックアップ (手順 2 と 3) の要件については、この記事の後半で説明します。

### <a name="detailed-requirements-for-contact-header-and-request-uri"></a>連絡先ヘッダーと Request-URI の詳細な要件

#### <a name="contact-header"></a>連絡先ヘッダー

Microsoft SIP プロキシへのすべての着信 SIP メッセージ (OPTIONS、INVITE) に対して、連絡先ヘッダーには、次のように URI ホスト名にペアの SBC FQDN が必要です。

構文: 連絡先: <SIP:phone または sip address@FQDN SBC;transport=tls> 

RFC [3261、セクション 11.1](https://tools.ietf.org/html/rfc3261#section-11.1)に基い、OPTIONS メッセージに連絡先ヘッダー フィールドが存在する場合があります。 ダイレクト ルーティングでは、連絡先ヘッダーが必要です。 上記の形式の INVITE メッセージの場合、OPTIONS メッセージの場合、ユーザー情報を SIP URI から削除し、次のように形式で送信される FQDN のみを削除できます。

構文: 連絡先: sBC;transport=tls <の sip:FQDN の>

この名前 (FQDN) は、提示された証明書の [共通名] または [サブジェクトの代替名] フィールドにも含まれる必要があります。 Microsoft では、証明書の [共通名] フィールドまたは [サブジェクトの代替名] フィールドで名前のワイルドカード値を使用できます。   

ワイルドカードのサポートについては [、RFC 2818、セクション 3.1 で説明されています](https://tools.ietf.org/html/rfc2818#section-3.1)。 具体的には：

*"名前には、単一のドメイン名コンポーネントまたはコンポーネント フラグメントと一致すると見なされるワイルドカード \* 文字が含まれている場合があります。例: .a.com は、foo.a.com と一致 bar.foo.a.com 一致します。f .com は foo.com 一致しますが \* \* 、bar.com。*

SIP メッセージに表示される連絡先ヘッダーの複数の値が SBC によって送信される場合は、連絡先ヘッダーの最初の値の FQDN 部分だけが使用されます。

ダイレクト ルーティングの経験則として、FQDN を使用して IP ではなく SIP URI を設定することが重要です。 ホスト名が FQDN ではなく IP で表される連絡先ヘッダーを含む SIP プロキシへの着信 INVITE または OPTIONS メッセージは、403 Forbidden で接続が拒否されます。

#### <a name="request-uri"></a>Request-URI 

すべての着信呼び出しに対して、Request-URI は電話番号をユーザーに一致するために使用されます。   

現在、電話番号には、次の例に示すようにプラス記号 (+) が含まれている必要があります。 

```console
INVITE sip:+18338006777@sip.pstnhub.microsoft.com SIP /2.0
```

## <a name="contact-and-record-route-headers-considerations"></a>連絡先とRecord-Routeに関する考慮事項

SIP プロキシは、新しいダイアログ内クライアント トランザクション (Bye や Re-Invite など) の次ホップ FQDN を計算し、SIP オプションに応答する場合に計算する必要があります。 [連絡先] または [Record-Route] が使用されます。 

RFC [3261 セクション 8.1.1.8](https://tools.ietf.org/html/rfc3261#section-8.1.1.8)によると、新しいダイアログが発生する可能性がある要求には、連絡先ヘッダーが必要です。 このRecord-Routeは、プロキシがダイアログで将来の要求のパスにとどまる場合にのみ必要です。 プロキシ SBC がダイレクト ルーティング[](./direct-routing-media-optimization.md)のローカル メディア最適化で使用されている場合は、プロキシ SBC がルートにとどまる必要がある場合に、レコード ルートを構成する必要があります。 

プロキシ SBC が使用されていない場合は、連絡先ヘッダーのみを使用してください。

- RFC [3261、セクション 20.30、Record-Route](https://tools.ietf.org/html/rfc3261#section-20.30)では、プロキシがダイアログで将来の要求のパスにとどまる場合に使用されます。すべてのトラフィックが Microsoft SIP プロキシとペアの SBC の間を移動する際にプロキシ SBC が構成されていない場合は必須ではありません。 

- Microsoft SIP プロキシでは、送信 ping オプションを送信するときに、連絡先ヘッダー (レコード ルートではなく) のみを使用して次ホップを決定します。 2 つのパラメーター (連絡先とレコード ルート) の代わりに 1 つのパラメーター (連絡先) のみを構成すると、プロキシ SBC が使用されていない場合の管理が簡素化されます。 

次ホップを計算するために、SIP プロキシは次の値を使用します。

- 優先度 1。 トップ レベルのレコード ルート。 トップ レベルのドメインに FQDN Record-Routeが含まれている場合は、FQDN 名を使用して、送信インダイアログ接続を行います。

- 優先度 2。 連絡先ヘッダー。 このRecord-Route存在しない場合、SIP プロキシは Contact ヘッダーの値を参照して送信接続を行います。 (これは推奨される構成です)。

連絡先と連絡先の両方Record-Route使用する場合、SBC 管理者は値を同一に保つ必要があります。この場合、管理者のオーバーヘッドが発生します。 

### <a name="use-of-fqdn-name-in-contact-or-record-route"></a>連絡先または連絡先で FQDN 名を使用Record-Route

IP アドレスの使用は、連絡先または連絡先Record-Routeサポートされていません。 サポートされるオプションは FQDN のみです。これは SBC 証明書の共通名またはサブジェクトの代替名と一致する必要があります (証明書のワイルドカード値はサポートされています)。

- [レコード ルート] または [連絡先] に IP アドレスが表示されている場合、証明書のチェックは失敗し、呼び出しは失敗します。

- FQDN が提示された証明書の共通またはサブジェクトの代替名の値と一致しない場合、呼び出しは失敗します。 

## <a name="inbound-call-sip-dialog-description"></a>着信呼び出し: SIP ダイアログの説明

次の表は、非バイパス モードとバイパス モードの呼び出しフローの違いと類似点をまとめたものです。

| パラメーター名 | バイパス以外のモード | バイパス モード
| :---------------------  |:---------------------- |:----------------|
| 183 と 200 のメッセージのメディア候補 | メディア プロセッサ | クライアント | 
| SBC が受信できるメッセージ数 183 件 | セッションごとに 1 つ | 複数のユーザー | 
| 呼び出しは、暫定応答を使用できます (183) | はい | はい |
| 呼び出しは、暫定応答なしで実行できます (183) | はい | はい |

###  <a name="non-media-bypass-flow"></a>メディア以外のバイパス フロー

Teams ユーザーは、同時に複数のエンドポイントを持つ場合があります。 たとえば、Teams for Windows クライアント、Teams for iPhone クライアント、Teams Phone (Teams Android クライアント)。 各エンドポイントは、次のように HTTP の残りを示す場合があります。

-   通話の進行状況 – SIP プロキシによって SIP メッセージ 180 に変換されます。 メッセージ 180 を受信する場合、SBC はローカル 呼び出し音を生成する必要があります。

-   メディア応答 – SIP プロキシによって、セッション記述プロトコル (SDP) のメディア候補を含むメッセージ 183 に変換されます。 メッセージ 183 を受信すると、SBC は SDP メッセージで受信したメディア候補に接続する予定です。 

    > [!NOTE]
    > 場合によっては、メディアの回答が生成されない可能性があります。また、エンド ポイントが "受け入れ呼び出し" メッセージで応答する場合があります。

-   受け入れ呼び出し – SDP を使用して SIP プロキシによって SIP メッセージ 200 に変換されます。 メッセージ 200 を受信すると、SBC は、指定された SDP 候補者とメディアを送受信する必要があります。

    > [!NOTE]
    > ダイレクト ルーティングでは、遅延オファーの招待 (SDP なしの招待) はサポートされていません。

#### <a name="multiple-endpoints-ringing-with-provisional-answer"></a>暫定応答で呼び出される複数のエンドポイント

1.  SBC から最初の招待を受信すると、SIP プロキシは"SIP SIP/2.0 100 Trying" というメッセージを送信し、着信呼び出しについてすべてのエンド ユーザー エンドポイントに通知します。 

2.  通知すると、各エンドポイントが呼び出しを開始し、SIP プロキシに "通話の進行状況" メッセージを送信します。 Teams ユーザーは複数のエンド ポイントを持つ可能性があるため、SIP プロキシは複数の通話進行状況メッセージを受信する可能性があります。

3.  クライアントから受信した通話進行状況メッセージごとに、SIP プロキシは通話進行状況メッセージを SIP メッセージ "SIP SIP/2.0 180 Trying" に変換します。 このようなメッセージを送信する間隔は、呼び出しコントローラーからの受信メッセージの間隔によって定義されます。 次の図では、SIP プロキシによって生成される 2 つの 180 メッセージがあります。 これらのメッセージは、ユーザーの 2 つの Teams エンドポイントから取得されます。 クライアントには、それぞれ一意のタグ ID があります。  別のエンドポイントから送信されるメッセージは、個別のセッションになります ("To" フィールドのパラメーター "tag" は異なります)。 ただし、次の図に示すように、エンドポイントでメッセージ 180 が生成され、メッセージ 183 が送信されない場合があります。

4.  エンドポイントがエンドポイントのメディア候補の IP アドレスを含む Media Answer メッセージを生成すると、SIP プロキシは、受信したメッセージを、メディア プロセッサから SDP に置き換えられたクライアントから SDP で "SIP 183 セッション進行状況" メッセージに変換します。 次の図では、Fork 2 のエンドポイントが呼び出しに応答しました。 トランクがバイパスされていない場合、183 SIP メッセージは 1 回だけ生成されます (リング ボットまたはクライアント エンドポイント)。 183 は、既存のフォークに接続されている場合や、新しいフォークを開始する場合があります。

5.  呼び出しの受け入れメッセージが、呼び出しを受け入れるエンドポイントの最終的な候補と一緒に送信されます。 通話の受け入れメッセージは、SIP メッセージ 200 に変換されます。 

> [!div class="mx-imgBorder"]
> ![暫定回答で呼び出される複数のエンドポイントを示す図](media/direct-routing-protocols-1.png)

#### <a name="multiple-endpoints-ringing-without-provisional-answer"></a>暫定応答なしで呼び出される複数のエンドポイント

1.  SBC から最初の招待を受信すると、SIP プロキシは"SIP SIP/2.0 100 Trying" というメッセージを送信し、着信呼び出しについてすべてのエンド ユーザー エンドポイントに通知します。 

2.  通知すると、各エンドポイントが呼び出しを開始し、メッセージ "通話の進行状況" を SIP プロキシに送信します。 Teams ユーザーは複数のエンド ポイントを持つ可能性があるため、SIP プロキシは複数の通話進行状況メッセージを受信する可能性があります。

3.  クライアントから受信した通話進行状況メッセージごとに、SIP プロキシは通話進行状況メッセージを SIP メッセージ "SIP SIP/2.0 180 Trying" に変換します。  メッセージを送信する間隔は、呼び出しコントローラーからメッセージを受信する間隔によって定義されます。 次の図では、SIP プロキシによって生成された 2 つの 180 メッセージがあります。つまり、ユーザーが 3 つの Teams クライアントにログインし、各クライアントが通話の進行状況を送信します。 すべてのメッセージは個別のセッションになります ("To" フィールドのパラメーター "tag" は異なります)

4.  呼び出しの受け入れメッセージが、呼び出しを受け入れるエンドポイントの最終的な候補と一緒に送信されます。 通話の受け入れメッセージは、SIP メッセージ 200 に変換されます。 

> [!div class="mx-imgBorder"]
> ![暫定応答なしで呼び出される複数のエンドポイントを示す図](media/direct-routing-protocols-2.png)

### <a name="media-bypass-flow"></a>メディア バイパス フロー

メディア バイパス シナリオでは、同じメッセージ (100 Trying、180、183) が使用されます。 

次のスキーマは、バイパス呼び出しフローの例を示しています。 

> [!NOTE]
> メディア候補は、さまざまなエンドポイントから取得できます。 

> [!div class="mx-imgBorder"]
> ![暫定回答で呼び出される複数のエンドポイントを示す図](media/direct-routing-protocols-3.png)

## <a name="replaces-option"></a>オプションを置き換える

SBC は、Invite with Replaces をサポートする必要があります。

## <a name="size-of-sdp-considerations"></a>SDP の考慮事項のサイズ

ダイレクト ルーティング インターフェイスは、1,500 バイトを超える SIP メッセージを送信する場合があります。  SDP のサイズは、主にこれが原因です。 ただし、SBC の背後に UDP トランクがある場合は、Microsoft SIP プロキシから変更されていないトランクに転送された場合、メッセージを拒否する可能性があります。 メッセージを UDP トランクに送信するときに、SBC の SDP で一部の値を削除する方法をお勧めします。 たとえば、ICE 候補や未使用のコーデックは削除できます。

## <a name="call-transfer"></a>転送を呼び出す

ダイレクト ルーティングでは、呼び出し転送の 2 つの方法がサポートされています。

- オプション 1。 SIP プロキシ プロセス クライアントからローカルに参照し、RFC 3892 のセクション 7.1 で説明されているレフリーとして機能します。

  このオプションを使用すると、SIP プロキシは転送を終了し、新しい招待を追加します。 


- オプション 2。 SIP プロキシは、SBC の参照を送信し、RFC 5589 のセクション 6 で説明されている転送者として機能します。

  このオプションを使用すると、SIP プロキシは SBC を参照し、SBC が転送を完全に処理する必要があります。

SIP プロキシは、SBC によって報告された機能に基づいてメソッドを選択します。 SBC がメソッド "参照" をサポートすると示す場合、SIP プロキシは呼び出し転送にオプション 2 を使用します。

次に、Refer メソッドがサポートされているメッセージを送信する SBC の例を示します。

```console
ALLOW: INVITE, OPTIONS, INFO, BYE, CANCEL, ACK, PRACK, UPDATE, REFER, SUBSCRIBE, NOTIFY
```

SBC がサポートされている方法として参照するを示さなかった場合、ダイレクト ルーティングではオプション 1 が使用されます (SIP プロキシはレフリーとして機能します)。 SBC は、Notify メソッドをサポートしているという通知も必要です。

Refer メソッドがサポートされていないことを示す SBC の例:

```console
ALLOW: INVITE, ACK, CANCEL, BYE, INFO, NOTIFY, PRACK, UPDATE, OPTIONS
```

### <a name="sip-proxy-processes-refer-from-the-client-locally-and-acts-as-a-referee"></a>SIP プロキシ プロセス クライアントからローカルに参照し、レフリーとして機能する

SBC が Refer メソッドがサポートされていないと示した場合、SIP プロキシはレフリーとして機能します。 

クライアントから送信される Refer 要求は、SIP プロキシで終了します。 (クライアントからの参照要求は、次の図に"Dave への呼び出し転送" と表示されます。  詳細については [、RFC 3892 のセクション 7.1 を参照してください](https://www.ietf.org/rfc/rfc3892.txt)。 

> [!div class="mx-imgBorder"]
> ![暫定回答で呼び出される複数のエンドポイントを示す図](media/direct-routing-protocols-4.png)

### <a name="sip-proxy-send-the-refer-to-the-sbc-and-acts-as-a-transferor"></a>SIP プロキシは、SBC の参照を送信し、Transferor として機能します

これは呼び出し転送に推奨される方法であり、メディア バイパス認定を求めるデバイスでは必須です。 SBC が Refer を処理できない場合の呼び出し転送は、メディア バイパス モードではサポートされていません。 

この標準については、RFC 5589 のセクション 6 で説明されています。 関連する RFC は次のとおりです。

- [セッション開始プロトコル (SIP) 呼び出し制御 - 転送](https://tools.ietf.org/html/rfc5589)

- [セッション開始プロトコル (SIP) "Replaces" ヘッダー](https://tools.ietf.org/html/rfc3891)

- [セッション開始プロトコル (SIP) "referred-By" メカニズム](https://tools.ietf.org/html/rfc3892)

このオプションは、SIP プロキシが Transferor として機能し、SBC に Refer メッセージを送信すると想定します。 SBC は譲渡先として機能し、[参照] を処理して、新しい譲渡オファーを生成します。 次の 2 つのケースが考えられる。

- 呼び出しは、外部 PSTN 参加者に転送されます。 
- 呼び出しは、SBC を介して同じテナント内の 1 つの Teams ユーザーから別の Teams ユーザーに転送されます。 

通話が SBC を介して Teams ユーザー間で転送される場合、SBC は、参照メッセージで受信した情報を使用して、転送先 (Teams ユーザー) に対して新しい招待 (新しいダイアログを開始) を発行する必要があります。 

要求のトランザクションの To/Transferor フィールドを内部的に設定するには、SIP プロキシが REFER-TO/REFERRED-BY ヘッダー内でこの情報を伝達する必要があります。 

SIP プロキシは、ホスト名内の SIP プロキシ FQDN で構成される SIP URI として REFER-TO を形成し、次のいずれかの方法で構成されます。

- 転送先が電話番号である場合の URI のユーザー名部分の E.164 電話番号

- 完全転送ターゲットの MRI とテナント ID をそれぞれエンコードする x-m パラメーターと x-t パラメーター 

REFERRED-BY ヘッダーは、次の表に示すように、転送者の MRI がエンコードされた SIP URI と、転送者テナント ID と他の転送コンテキスト パラメーターです。

| パラメーター | 値 | 説明 |  
|:---------------------  |:---------------------- |:---------------------- |
| x-m | MRI | CC で設定された転送または転送ターゲットの完全な MRI |
| x-t | テナント ID | x-t テナント ID CC によって設定されたテナント ID (省略可能) |
| x-ti | Transferor の関連付け ID | 転送者への呼び出しの関連付け ID |
| x-tt | 転送先の呼び出し URI | エンコードされた呼び出しの置換 URI |

この場合、参照ヘッダーのサイズは最大 400 記号にできます。 SBC は、最大 400 シンボルのサイズの Refer メッセージの処理をサポートする必要があります。

> [!div class="mx-imgBorder"]
> ![暫定回答で呼び出される複数のエンドポイントを示す図](media/direct-routing-protocols-5.png)

## <a name="session-timer"></a>セッション タイマー

SIP プロキシは、バイパス以外の呼び出しでセッション タイマーをサポート (常に提供) しますが、バイパス呼び出しでは提供しません。 SBC によるセッション タイマーの使用は必須ではありません。

##  <a name="use-of-request-uri-parameter-userphone"></a>Request-URI パラメーター user=phone の使用

SIP プロキシは Request-URI を分析し、パラメーター user=phone が存在する場合、サービスは電話番号として Request-URI を処理し、その番号をユーザーに照合します。 パラメーターが存在しない場合、SIP プロキシはヒューリスティックを適用して Request-URI ユーザーの種類 (電話番号または SIP アドレス) を決定します。

呼び出しセットアップ プロセスを簡素化するために、常に user=phone パラメーターを適用してください。

## <a name="history-info-header"></a>History-Infoヘッダー

History-Info ヘッダーは、SIP 要求のリターゲティングに使用され、「要求履歴情報をキャプチャするための標準的なメカニズムを提供して、ネットワークとエンド ユーザー向けのさまざまなサービスを有効にする」のに使用されます。 詳細については [、RFC 4244 – セクション 1.1 を参照してください](http://www.ietf.org/rfc/rfc4244.txt)。 Microsoft Phone System の場合、このヘッダーは Simulring シナリオと Call Forwarding シナリオで使用されます。  

送信する場合、History-Infoが有効になります。

- SIP プロキシは、PSTN コントローラーに送信される History-Info ヘッダーを構成する個々の History-Info エントリに、関連付けられている電話番号を含むパラメーターを挿入します。  電話番号パラメーターを持つエントリのみを使用して、PSTN コントローラーは新しい History-Info ヘッダーを再構築し、SIP プロキシを介して SIP トランク プロバイダーに渡します。

- History-Info呼び出しの転送ケースに対して、このヘッダーが追加されます。

- History-Info転送ケースでは、ヘッダーは追加されません。

- 再構築された History-Info ヘッダーの個々の履歴エントリには、URI のホスト部分としてダイレクト ルーティング FQDN (sip.pstnhub.microsoft.com) が設定された電話番号パラメーターが指定されます。'user=phone' のパラメーターが SIP URI の一部として追加されます。  元の History-Info ヘッダーに関連付けられているその他のパラメーター (電話コンテキスト パラメーターを除く) は、再構築されたヘッダーHistory-Infoされます。  

  > [!NOTE]
  > プライベートなエントリ (RFC 4244 のセクション 3.3 で定義されているメカニズムによって決まります) は、SIP トランク プロバイダーが信頼できるピアなので、この方法で転送されます。

- 受信のHistory-Infoは無視されます。

SIP プロキシによって送信される History-info ヘッダーの形式を次に示します。

```console
<sip:UserB@sip.pstnhub.microsoft.com?Privacy=history&Reason=SIP%3B\cause%3D486>;index=1.2,
```

呼び出しが何度かリダイレクトされた場合、すべてのリダイレクトに関する情報が、適切な理由を時系列順に含まれます。


ヘッダーの例:

```console
History-info: 
<sip:+14257123456@sip.pstnhub.microsoft.com;user=phone?Reason=SIP;cause=302;text=”Move Temporarily”>;index=1
<sip:+14257123457@sip.pstnhub.microsoft.com;user=phone?Reason=SIP;cause=496;text=”User Busy”>;index=1.1
```

このHistory-Infoは、必須の TLS メカニズムによって保護されます。 

## <a name="sbc-connection-to-direct-routing-and-failover-mechanism"></a>ダイレクト ルーティングとフェールオーバー メカニズムへの SBC 接続

「ダイレクト ルーティングの計画」の SIP シグナリングのフェールオーバー [メカニズムに関するセクションを参照してください](direct-routing-plan.md#failover-mechanism-for-sip-signaling)。

## <a name="retry-after"></a>Retry-After

ダイレクト ルーティング データセンターがビジー状態の場合、サービスは SBC に 1 Retry-After間隔でメッセージを送信できます。 SBC が INVITE に応答して Retry-After ヘッダーを含む 503 メッセージを受信すると、SBC は接続を終了し、次に使用可能な Microsoft データセンターを試す必要があります。

## <a name="handling-retries-603-response"></a>再試行の処理 (603 応答)
エンド ユーザーが着信呼び出しを拒否した後、1 回の呼び出しに対して複数の着信が見つからない場合は、SBC または PSTN トランク プロバイダーの再試行メカニズムが正しく構成されていないという意味です。 SBC を再構成して、603 応答での再試行を停止する必要があります。

## <a name="ice-restart-media-bypass-call-transferred-to-an-endpoint-that-does-not-support-media-bypass"></a>ICE の再起動: メディア バイパスをサポートしていないエンドポイントに転送されるメディア バイパス呼び出し

SBC は、RFC [5245 セクション 9.1.1.1](https://tools.ietf.org/html/rfc5245#section-9.1.1.1)で説明されている ICE の再起動をサポートする必要があります。

ダイレクト ルーティングでの再起動は、RFC の次の段落に従って実装されます。

*ICE を再起動するには、エージェントはオファー内のメディア ストリームの ice-pwd と ice-ufrag の両方を変更する必要があります。 1 つのオファーでセッション レベル属性を使用できますが、後続のオファーでメディア レベルの属性として同じ ice-pwd または ice-ufrag を指定できます。 これはパスワードの変更ではなく、その表現の変更に過ぎなく、ICE の再起動を引き起こします。*

*エージェントは、このメディア ストリームの最初のオファーと同様に、このメディア ストリームの SDP の残りのフィールドを設定します (セクション 4.3 を参照)。 そのため、候補者のセットには、そのストリームの以前の候補の一部、なし、またはすべての候補が含まれ、セクション 4.1.1 で説明されているとおりに収集された全く新しい候補セットが含まれる場合があります。*

呼び出しが最初にメディア バイパスで確立され、呼び出しが Skype for Business クライアントに転送される場合、ダイレクト ルーティングはメディア プロセッサを挿入する必要があります。これは、メディア バイパスを使用した Skype for Business クライアントではダイレクト ルーティングを使用できないためです。 ダイレクト ルーティングは、ice-pwd と ice-ufrag を変更し、新しいメディア候補を再び提供することで、ICE 再起動プロセスを開始します。
