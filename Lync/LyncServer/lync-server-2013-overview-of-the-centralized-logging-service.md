---
title: 集中ログサービスの概要
TOCTitle: 集中ログサービスの概要
ms:assetid: 975718a0-f3e3-404d-9453-6224e73bfdd0
ms:mtpsurl: https://technet.microsoft.com/ja-jp/library/JJ688145(v=OCS.15)
ms:contentKeyID: 49887062
ms.date: 12/10/2016
mtps_version: v=OCS.15
ms.translationtype: HT
---

# 集中ログサービスの概要

 

_**トピックの最終更新日:** 2016-12-08_

集中ログ サービス は、広いスコープまたは狭いスコープを使用してデータのコレクションを制御する手段を提供するように設計されています。展開内のすべてのサーバーから同時にデータを収集し、トレースする特定の要素を定義し、トレース フラグを設定して、単一のコンピューターからの検索結果またはすべてのサーバーからの全データの集合を返すことができます。集中ログ サービス は、展開内のすべてのサーバーで実行されます。集中ログ サービス のアーキテクチャは、以下のエージェントとサービスで構成されます。

  - Centralized Logging Service Agent   ClsAgent.exe は、コントローラーと通信を行って、管理者がコントローラーで実行したコマンドを受信するサービスの実行可能ファイルです。このエージェントは、各 Lync Server コンピューターでサービスとして実行されます。コマンドを受信したエージェントは、そのコマンドを実行し、定義済みのコンポーネントにメッセージを送信してトレースを実行し、トレース ログをディスクに書き込みます。また、そのコンピューターのトレース ログを読み取り、要求された場合にトレース データをコントローラーに戻します。ClsAgent は、**TCP 50001**、**TCP 50002**、および **TCP 50003** の各ポートでコマンドをリッスンします。

  - Centralized Logging Service Controller   ClsControllerLib.dll は、Lync Server 管理シェルおよび ClsController.exe 用のコマンド実行エンジンです。CLSControllerLib.dll は、開始、停止、フラッシュ、および検索のコマンドを ClsAgent に送信します。検索のコマンドが送信されると、結果のログが ClsControllerLib.dll に返されて、集計されます。エージェントにコマンドを送信し、そのコマンドの状態を受信して、検索範囲内のすべてのコンピューター上の全エージェントから返される検索ログ ファイル データを管理し、ログ データをわかりやすい出力セットにまとめるのはコントローラーの役割です。以下のトピックで示す情報は、Lync Server 管理シェルを使用する場合を中心に説明しています。ClsController.exe では、Lync Server 管理シェルで使用可能な機能の一部しか使用できません。ClsController.exe のヘルプを表示するには、コマンド ラインにおいて、既定のディレクトリである C:\\Program Files\\Common Files\\Microsoft Lync Server 2013\\ClsAgent で「`ClsController`」と入力します。

**ClsController と ClsAgent の通信**

![CLSController と CLSAgent の間の関係.](images/JJ688145.68c90811-5cf9-4a84-95b7-ea9ffc61eac4(OCS.15).jpg "CLSController と CLSAgent の間の関係.")

コマンドを実行するには、Windows Server コマンド ライン インターフェイスまたは Lync Server 管理シェルを使用します。コマンドは、ログインしたコンピューターで実行され、ClsAgent にローカルで送信されます。または、展開内の他のコンピューターやプールに送信されます。

ClsAgent は、ローカル コンピューター上のすべての .CACHE ファイルのインデックス ファイルを保持します。ClsAgent は、CacheFileLocalFolders オプションで定義されたボリュームにファイルが均等に分散されるような割り当てを行います。各ボリュームが 80% 以上使用されることはありません (**Set-CsClsConfiguration** コマンドレットを使用して、ローカルのキャッシュの場所とパーセンテージを構成できます)。また、ClsAgent は、キャッシュされた古いイベント トレース ログ (.etl) ファイルのエージングを実行して、ローカル コンピューターから削除します。2 週間 (**Set-CsClsConfiguration** コマンドレットを使用して、期間を構成できます) が経過すると、これらのファイルがファイル共有にコピーされて、ローカル コンピューターから削除されます。詳細については、「[Set-CsClsConfiguration](https://docs.microsoft.com/en-us/powershell/module/skype/Set-CsClsConfiguration)」を参照してください。検索要求を受信すると、エージェントが保持するインデックス内の値に基づいて検索を実行する、キャッシュされた .etl ファイルのセットを選択するための検索条件が使用されます。

> [!NOTE]
> ローカル コンピューターからファイル共有に移動されたファイルを ClsAgent で検索できます。ClsAgent がファイルをファイル共有に移動すると、ファイルのエージングと削除は ClsAgent で管理されません。ファイル共有内のファイルのサイズを監視し、ファイルを削除またはアーカイブするための管理タスクを定義する必要があります。


**Snooper.exe** や、テキスト ファイルを読み取ることのできるツール (**Notepad.exe** など) を含むさまざまなツールを使用して、結果のログ ファイルの読み取りと分析を行うことができます。Snooper.exe は Lync Server 2013 のデバッグ ツールに含まれており、Web 経由でダウンロードできます。

OCSLogger と同様に、集中ログ サービス には、トレース対象となる複数のコンポーネントが存在し、TF\_COMPONENT や TF\_DIAG などのフラグを選択するためのオプションが用意されています。また、集中ログ サービス には OCSLogger のログ レベルのオプションもあります。

Windows PowerShell がコマンド ラインの ClsController よりも優れている最も重要な利点として、問題の領域、カスタム フラグ、およびログ レベルを対象としたプロバイダーを選択して新しいシナリオを構成および定義できることが挙げられます。ClsController で使用可能なシナリオは、実行可能ファイル用に定義されるシナリオに制限されます。

以前のバージョンでは、管理者とサポート担当者が展開内のコンピューターからトレース ファイルを収集できるようにするために OCSLogger.exe が提供されていました。OCSLogger には、長所と同時に短所も存在しました。ログは一度に 1 台のコンピューター上でしか収集できませんでした。OCSLogger のコピーを使用して複数のコンピューターにログオンすることは可能でしたが、最終的にログが複数作成され、結果を集計するのが容易ではありませんでした。

ユーザーがログの検索を要求すると、ClsController が (選択したシナリオに基づいて) 要求の送信先コンピューターを特定します。また, .etl ファイルが保存されているファイル共有に検索を送信する必要があるかどうかを判断します。検索結果が ClsController に返されると、コントローラーが結果をマージして時系列の 1 つの結果セットを作成し、ユーザーに提供します。ユーザーは、ローカル コンピューターに検索結果を保存して、以降の分析に使用できます。

ログ記録セッションを開始したら、解決しようとする問題に関連するシナリオを指定します。常に実行することのできるシナリオは 2 つあります。そのうちの 1 つは AlwaysOn シナリオにする必要があります。名前が示すとおり、このシナリオを展開内で常に実行し、すべてのコンピューター、プール、およびコンポーネントに関する情報を収集する必要があります。


> [!IMPORTANT]
> 既定では、AlwaysOn シナリオは展開内で実行されません。このシナリオは明示的に開始する必要があります。開始したシナリオは明示的に停止されるまで実行され、実行状態はコンピューターを再起動しても保持されます。シナリオの開始および停止の詳細については、「<A href="lync-server-2013-using-start-for-the-centralized-logging-service-to-capture-logs.md">集中ログ サービスの Start を使用したログのキャプチャー</A>」および「<A href="lync-server-2013-using-stop-for-the-centralized-logging-service.md">集中ログ サービスの Stop の使用</A>」を参照してください。



問題が発生した場合は、報告された問題に関連する 2 つ目のシナリオを開始します。問題を再現し、2 つ目のシナリオのログ記録を停止します。報告された問題に関連するログの検索を開始します。集計されたログのコレクションによって、展開のサイト スコープまたはグローバル スコープ内のすべてのコンピューターからのトレース メッセージを含むログ ファイルが生成されます。分析可能なデータ以上のデータが検索から返された場合は (通常、信号対ノイズ比とも呼ばれ、この場合はノイズが多すぎる状態です)、パラメーターを絞り込んで別の検索を実行します。この時点で、問題を明確にするために役立つパターンの特定を開始できます。最終的には、いくつかの絞り込み検索を実行した後で問題に関連するデータが見つかり、根本原因を特定できます。


> [!TIP]
> Lync Server で問題のシナリオが提示されたら、まずは "問題について既にわかっていることは何か" を考えます。問題の境界を定量化する場合は、Lync Server で稼働中のエンティティの大部分を除外できます。<BR>ユーザーが連絡先を検索するときに現在の結果を取得していないことがわかっているシナリオ例を検討します。メディア コンポーネント、エンタープライズ VoIP、会議、およびその他の複数のコンポーネントで問題を検索しても意味はありません。実際はどこに問題が存在するのか (クライアントなのか、サーバー側の問題なのか) がわからないためです。ユーザー レプリケーターによって、Active Directory から連絡先が収集され、アドレス帳サーバー (ABServer) 経由でクライアントに提供されます。ABServer は、既定では午前 1 時 30 分に (ユーザー レプリケーターが更新内容を書き込む) RTC データベースから更新を取得してアドレス帳ファイルにまとめます。Lync Server クライアントは、不定期に新しいアドレス帳を取得します。プロセスの流れがわかっているので、考えられる原因の検索を、ユーザー レプリケーターによって Active Directory から収集されるデータ、アドレス帳ファイルを取得および作成しない ABServer、またはアドレス帳ファイルをダウンロードしないクライアントに関連する問題に限定することができます。


