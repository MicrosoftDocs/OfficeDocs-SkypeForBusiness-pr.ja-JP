---
title: Skype for Business Server 2015 での常設チャット サーバーの高可用性および障害復旧の管理
ms.reviewer: ''
ms.author: v-lanac
author: lanachin
manager: serdars
ms.date: 1/31/2018
audience: ITPro
ms.topic: article
ms.prod: skype-for-business-itpro
localization_priority: Normal
ms.assetid: 4346e70b-ac48-4ab9-853e-3cdd6dcfe678
description: '概要: Skype for Business Server 2015 で永続的なチャットサーバーの高可用性と障害回復を管理する方法について説明します。'
ms.openlocfilehash: ff30bcdd99a4c92bd8fbd8f0a5c4bcedd8aa63b0
ms.sourcegitcommit: d4248fefd706616bd3ccc5b510a6696303fa88e1
ms.translationtype: MT
ms.contentlocale: ja-JP
ms.lasthandoff: 07/02/2019
ms.locfileid: "35418706"
---
# <a name="manage-high-availability-and-disaster-recovery-for-persistent-chat-server-in-skype-for-business-server-2015"></a>Skype for Business Server 2015 での常設チャット サーバーの高可用性および障害復旧の管理
 
**概要:** Skype for Business Server 2015 で永続的なチャットサーバーの高可用性と障害回復を管理する方法について説明します。
  
このトピックでは、常設チャットサーバをフェイルオーバーしてフェイルバックする方法について説明します。 このトピックを読む前に、「 [skype For Business server 2015 の常設チャットサーバーの高可用性と障害回復の計画」](../../plan-your-deployment/persistent-chat-server/high-availability-and-disaster-recovery.md)を参照して、 [Skype の常設チャットサーバーの高可用性と障害回復を構成することを確認してください。Business Server 2015](../../deploy/deploy-persistent-chat-server/configure-hadr-for-persistent-chat.md)

> [!NOTE]
> 常設チャットは Skype for Business Server 2015 で使用できますが、Skype for Business Server 2019 ではサポートされなくなりました。 Teams でも同じ機能を使用できます。 詳細については、「 [Microsoft Teams のアップグレードの](/microsoftteams/upgrade-start-here)概要」を参照してください。 常設チャットを使用する必要がある場合は、この機能が必要なユーザーをチームに移行するか、Skype for Business Server 2015 を使い続けるかのいずれかを選択できます。 
  
## <a name="fail-over-persistent-chat-server"></a>常設チャットサーバーのフェイルオーバー

常設チャットサーバーのフェールオーバーは、主に手動で行うように設計されています。
  
フェイルオーバー手順は、セカンダリデータセンターが稼働していることを前提としていますが、プライマリ常設チャットデータベースが配置されている常設チャットサーバーサービスは、次のように完全には使用できません。
  
- 常設チャットサーバーのプライマリデータベースと常設チャットサーバーのミラーデータベースがダウンしています。
    
- Skype for Business Server フロントエンドサーバーがダウンしています。
    
この操作は次の 2 つの基本手順に基づいています。
  
- プライマリ常設チャットデータベース (行う) を回復します。
    
- 新しいプライマリ データベースのミラーリングを確立する。
    
常設チャットのコンプライアンスデータベース (会社間) は、フェールオーバーされません。 このデータベースの内容は一時的なものであり、コンプライアンス アダプターがデータを処理するときに削除されます。 データの損失を防ぐために、アダプターの出力を適切に管理することは、常設チャット管理者の責任となります。
  
常設チャット サーバーをフェールオーバーさせるには、次の操作を行います。
  
1. 常設チャットサーバーバックアップログ配布データベースからログ配布を削除します。
    
   - SQL Server Management Studio を使用して、常設チャットサーバーバックアップ行うデータベースが配置されているデータベースインスタンスに接続します。
    
   - マスター データベースに対するクエリ ウィンドウを開きます。
    
   - 次のコマンドを使用して、ログ配布を削除します。
    
   ```
   exec sp_delete_log_shipping_secondary_database mgc
   ```

2. バックアップ共有から、バックアップ サーバーのコピー先フォルダーへ、コピーしていないバックアップ ファイルをコピーします。
    
3. セカンダリ データベースに、適用していないトランザクション ログ バックアップを順番に適用します。 詳細については、「[トランザクションログバックアップ (transact-sql) を適用する方法](https://go.microsoft.com/fwlink/p/?linkid=247428)」を参照してください。
    
4. バックアップ mgc データベースをオンラインにします。手順 1b. で開いたクエリ ウィンドウを使用して、次の手順を実行します。
    
   - mgc データベースへのすべての接続を終了します (接続がある場合)。
    
   - **exec sp_who2** を実行して、mgc データベースへの接続を識別します。
    
   - spid を終了してこれらの接続を終了します。 ** \<\> **
    
   - データベースをオンラインにします。
    
   - **restore database mgc with recovery** を実行します。
    
5. Skype for Business Server 管理シェルで、コマンド**セット CsPersistentChatState-Identity "service: 001.litwareinc.com"-PoolState FailedOver**を使用して、行う backup データベースにフェールオーバーします。 atl-cs-001.litwareinc.com の部分には、常設チャット プールの完全修飾ドメイン名を指定します。
    
    mgc バックアップ データベースがプライマリ データベースとして動作するようになります。
    
6. Skype for Business Server 管理シェルで、 **CsMirrorDatabase**コマンドレットを使用して、プライマリデータベースとして機能するバックアップデータベースに対して高可用性ミラーを確立します。 バックアップ データベース インスタンスをプライマリ データベースとして使用し、バックアップ ミラー データベース インスタンスをミラー インスタンスとして使用します。 これは、セットアップ時にプライマリ データベースに対して最初に構成したミラーと同じものではありません。
    
7. 常設チャットサーバーのアクティブなサーバーを設定します。 Skype for Business Server 管理シェルで、 **CsPersistentChatActiveServer**コマンドレットを使用してアクティブなサーバーの一覧を設定します。
    
    > [!IMPORTANT]
    > すべてのアクティブ サーバーは、新しいプライマリ データベースと同じデータ センター内、またはデータベースへの接続が低待機時間/高帯域幅であるデータ センター内に配置する必要があります。 
  
    この時点で、常設チャットサーバーのプライマリデータベースから永続的なチャットサーバーバックアップデータベースへのフェールオーバーが正常に完了します。
    
## <a name="fail-back-persistent-chat-server"></a>常設チャットサーバーのフェイルバック

この手順では、常設チャットサーバーの障害から回復するために必要な手順と、プライマリデータセンターからの操作を再確立するために必要な手順について説明します。
  
常設チャットサーバーの障害時に、プライマリデータセンターには完全な停止が発生し、プライマリデータベースとミラーデータベースは利用できなくなります。 プライマリ データ センターはバックアップ サーバーにフェールオーバーします。
  
以下の手順では、プライマリ データ センターがバックアップされ、サーバーが再構築された後、通常の動作を回復します。 この手順では、プライマリデータセンターが全体の停止から回復され、トポロジビルダーを使用して行うデータベースと、使い方が再構築されていることを前提としています。
  
また、フェールオーバー期間に新たにミラー サーバーやバックアップ サーバーは展開されていないこと、および前述した「常設チャット サーバーのフェールオーバー」で定義されているように、展開されたサーバーはバックアップ サーバーとそのミラー サーバーだけであることを想定しています。
  
この手順の意図は、プライマリ サーバーからバックアップ サーバーへのフェールオーバーの原因となった障害が発生する前の状態に構成を復旧することにあります。
  
1. Skype for Business Server 管理シェルから**CsPersistentChatActiveServer**コマンドレットを使用して、常設チャットサーバーの Active Server リストからすべてのサーバーをクリアします。 これにより、すべての常設チャットサーバーが、フェイルバック中に行うデータベースとデータベースに接続できなくなります。
    
    > [!IMPORTANT]
    > セカンダリ常設チャットサーバーのバックエンドサーバー上の SQL Server エージェントは、特権を持つアカウントで実行されている必要があります。 このアカウントには、次のアクセス許可が与えられている必要があります。 
  
   - バックアップが置かれるネットワーク共有に対する読み取りアクセス
    
   - バックアップのコピー先となるローカル ディレクトリに対する書き込みアクセス
    
2. バックアップ mgc データベースでのミラーリングを無効にします。
    
   - SQL Server Management Studio を使用して、backup 行うインスタンスに接続します。
    
   - mgc データベースを右クリックし、[**タスク**] をポイントしてから、[**ミラー**] をクリックします。
    
   - [**ミラーリングの削除**] をクリックします。
    
   - [**OK**] をクリックします。
    
   - mgccomp データベースに対しても同じ手順を実行します。
    
3. mgc データベースをバックアップして、新しいプライマリ データベースに復元できるようにします。
    
   - SQL Server Management Studio を使用して、backup 行うインスタンスに接続します。
    
   - mgc データベースを右クリックし、[**タスク**] をポイントしてから、[**バックアップ**] をクリックします。[**データベースのバックアップ**] ダイアログ ボックスが表示されます。
    
   - [**バックアップの種類**] で、[**完全**] を選択します。
    
   - [**バックアップ コンポーネント**] として、[**データベース**] をクリックします。
    
   - [**名前**] に表示される既定のバックアップ セット名をそのまま使用するか、バックアップ セット名として別の名前を入力します。
    
   -  * \<オプション\> * [**説明**] にバックアップセットの説明を入力します。
    
   - バックアップ先の一覧から既定のバックアップ場所を削除します。
    
   - ログ配布用に設定した共有の場所へのパスを使用して、この一覧にファイルを追加します。このパスはプライマリ データベースとバックアップ データベースの両方に使用できます。
    
   - [**OK**] をクリックします。ダイアログ ボックスが閉じられ、バックアップ プロセスが開始されます。
    
4. 上記のステップで作成されたバックアップ データベースを使用して、プライマリ データベースを復元します。
    
   - SQL Server Management Studio を使用して、プライマリ行うインスタンスに接続します。
    
   - mgc データベースを右クリックし、[**タスク**]、[**復元**] の順にポイントしてから、[**データベース**] をクリックします。[**データベースの復元**] ダイアログ ボックスが表示されます。
    
   - [**復元元デバイス**] を選択します。
    
   - [参照] ボタンをクリックします。[**バックアップの指定**] ダイアログ ボックスが表示されます。[**バックアップ メディア**] で、[**ファイル**] を選択します。[**追加**] をクリックし、ステップ 3 で作成したバックアップ ファイルを選択し、[**OK**] をクリックします。
    
   - [**復元するバックアップ セットの選択**] で、バックアップを選択します。
    
   - [**ページの選択**] ウィンドウで、[**オプション**] をクリックします。
    
   - [**復元オプション**] で、[**既存のデータベースを上書きする**] を選択します。
    
   - [**復旧状態**] で、[**データベースを使用可能な状態にする**] を選択します。
    
   - [**OK**] をクリックします。復元プロセスが開始されます。
    
5. プライマリデータベースの SQL Server ログの配布を構成します。 「 [Skype For Business server 2015 の常設チャットサーバー用に高可用性と障害回復を構成](../../deploy/deploy-persistent-chat-server/configure-hadr-for-persistent-chat.md)する」の手順に従って、プライマリ行うデータベースのログの配布を確立します。
    
6. 常設チャットサーバーのアクティブなサーバーを設定します。 Skype for Business Server 管理シェルで、 **CsPersistentChatActiveServer**コマンドレットを使用してアクティブなサーバーの一覧を設定します。
    
    > [!IMPORTANT]
    > すべてのアクティブ サーバーは、新しいプライマリ データベースと同じデータ センター内、またはデータベースへの接続が低待機時間/高帯域幅であるデータ センター内に配置する必要があります。 
  
プールを通常の状態に復元するには、次の Windows PowerShell コマンドを実行します。
  
```
Set-CsPersistentChatState -Identity "service: lyncpc.dci.discovery.com" -PoolState Normal
```

詳細については、[Set-CsPersistentChatState](https://docs.microsoft.com/powershell/module/skype/set-cspersistentchatstate?view=skype-ps) コマンドレットのヘルプ トピックを参照してください。
  

