---
title: Skype for Business Server 2015 での常設チャット サーバーの高可用性および障害復旧の管理
ms.reviewer: ''
ms.author: serdars
author: SerdarSoysal
manager: serdars
ms.date: 1/31/2018
ms.audience: ITPro
ms.topic: article
ms.prod: skype-for-business-itpro
localization_priority: Normal
ms.assetid: 4346e70b-ac48-4ab9-853e-3cdd6dcfe678
description: '概要: ビジネス サーバー 2015 の永続的なチャット サーバーの高可用性と Skype では障害回復を管理する方法を説明します。'
ms.openlocfilehash: b7c898be275a4a3642eae88412a14686b258130f
ms.sourcegitcommit: 111bf6255fa877b3fce70fa8166e8ec5a6643434
ms.translationtype: MT
ms.contentlocale: ja-JP
ms.lasthandoff: 04/23/2019
ms.locfileid: "32232683"
---
# <a name="manage-high-availability-and-disaster-recovery-for-persistent-chat-server-in-skype-for-business-server-2015"></a>Skype for Business Server 2015 での常設チャット サーバーの高可用性および障害復旧の管理
 
**の概要:** ビジネス サーバー 2015 の永続的なチャット サーバーの高可用性と Skype では障害回復を管理する方法について説明します。
  
このトピックでは、フェイル オーバーとフェイル バックに永続的なチャット サーバーにする方法について説明します。 このトピックを読む前にするの Skype での永続的なチャット サーバーの[高可用性とビジネス サーバー 2015 の Skype での永続的なチャット サーバーの障害回復の計画](../../plan-your-deployment/persistent-chat-server/high-availability-and-disaster-recovery.md)し[の構成の高可用性および災害復旧を参照してください。ビジネス サーバー 2015年](../../deploy/deploy-persistent-chat-server/configure-hadr-for-persistent-chat.md)。

> [!NOTE]
> 永続的なチャットですがビジネス サーバー 2015 の Skype で利用可能なビジネス サーバー 2019 の Skype でサポートされていません。 同じ機能は、チームで使用できます。 詳細については、[マイクロソフトのチームにビジネス用の Skype からの旅](/microsoftteams/journey-skypeforbusiness-teams)を参照してください。 永続的なチャットを使用する場合は、選択肢は、いずれかをチームでは、この機能を必要とするユーザーを移行するまたはビジネス サーバー 2015 の Skype を使用し続ける。 
  
## <a name="fail-over-persistent-chat-server"></a>永続的なチャット サーバー上で失敗します。

永続的なチャット サーバーのフェイル オーバーは手動のプロセスでは主に設計されています。
  
フェイル オーバー手順をセカンダリ ・ データ ・ センターであることを前提に基づいており、実行中、ですが、プライマリの永続的なチャットのデータベースが格納されている永続的なチャット サーバー サービスは、完全に利用可能な次に示す。
  
- 永続的なチャット サーバーのプライマリ データベースとミラー データベースの永続的なチャット サーバー ダウンしています。
    
- Skype のビジネス サーバーのフロント エンド サーバーがあります。
    
この操作は次の 2 つの基本手順に基づいています。
  
- 永続的なチャット プライマリ データベース (mgc) をリカバリします。
    
- 新しいプライマリ データベースのミラーリングを確立する。
    
永続的なチャット コンプライアンス データベース (mgccomp) はフェイル オーバーしません。 このデータベースの内容は一時的なものであり、コンプライアンス アダプターがデータを処理するときに削除されます。 永続的なチャット管理者は、データの損失を避けるためにアダプターの出力を正しく管理するために、あなたの責任です。
  
常設チャット サーバーをフェールオーバーさせるには、次の操作を行います。
  
1. 永続的なチャット サーバーのバックアップ ログ配布のデータベースからログ配布を削除します。
    
   - SQL Server Management Studio を使用すると、永続的なチャット サーバーのバックアップ mgc データベースが格納されているデータベース ・ インスタンスに接続します。
    
   - マスター データベースに対するクエリ ウィンドウを開きます。
    
   - 次のコマンドを使用して、ログ配布を削除します。
    
   ```
   exec sp_delete_log_shipping_secondary_database mgc
   ```

2. バックアップ共有から、バックアップ サーバーのコピー先フォルダーへ、コピーしていないバックアップ ファイルをコピーします。
    
3. セカンダリ データベースに、適用していないトランザクション ログ バックアップを順番に適用します。 詳細についてを参照してください[する方法: トランザクション ログのバックアップ (Transact SQL) を適用する](https://go.microsoft.com/fwlink/p/?linkid=247428)です。
    
4. バックアップ mgc データベースをオンラインにします。手順 1b. で開いたクエリ ウィンドウを使用して、次の手順を実行します。
    
   - mgc データベースへのすべての接続を終了します (接続がある場合)。
    
   - **exec sp_who2** を実行して、mgc データベースへの接続を識別します。
    
   - **kill \<spid\>** をこれらの接続を終了します。
    
   - データベースをオンラインにします。
    
   - **restore database mgc with recovery** を実行します。
    
5. ビジネス サーバー管理シェルの Skype は、コマンドを使用して**セット CsPersistentChatState-アイデンティティ」サービス: atl の cs-001.litwareinc.com"- PoolState FailedOver** mgc バックアップ データベースにフェールオーバーします。 atl-cs-001.litwareinc.com の部分には、常設チャット プールの完全修飾ドメイン名を指定します。
    
    mgc バックアップ データベースがプライマリ データベースとして動作するようになります。
    
6. ビジネス サーバー管理シェルの Skype では、プライマリ データベースとして使用するデータベースのバックアップを高可用性のミラーを確立するために**インストール CsMirrorDatabase**コマンドレットを使用します。 バックアップ データベース インスタンスをプライマリ データベースとして使用し、バックアップ ミラー データベース インスタンスをミラー インスタンスとして使用します。 これは、セットアップ時にプライマリ データベースに対して最初に構成したミラーと同じものではありません。
    
7. 永続的なチャット サーバーのアクティブなサーバーを設定します。 ビジネス サーバー管理シェルの Skype からには、アクティブなサーバーの一覧を設定するのには、**セット CsPersistentChatActiveServer**コマンドレットを使用します。
    
    > [!IMPORTANT]
    > すべてのアクティブ サーバーは、新しいプライマリ データベースと同じデータ センター内、またはデータベースへの接続が低待機時間/高帯域幅であるデータ センター内に配置する必要があります。 
  
    この時点では、永続的なチャット サーバーのプライマリ データベースから永続的なチャット サーバーのバックアップ データベースへのフェールオーバーが正常に完了します。
    
## <a name="fail-back-persistent-chat-server"></a>戻る永続的なチャット サーバーが失敗します。

この手順では、永続的なチャット サーバー障害から回復して、プライマリ ・ データ ・ センターから操作を再確立するために必要な手順について説明します。
  
永続的なチャット サーバーの障害発生時にプライマリ ・ データ ・ センターの低下、完全なシステム停止となり、プライマリおよびミラー データベースが使用できなくなります。 プライマリ データ センターはバックアップ サーバーにフェールオーバーします。
  
以下の手順では、プライマリ データ センターがバックアップされ、サーバーが再構築された後、通常の動作を回復します。 プロシージャは、プライマリ ・ データ ・ センターが総停止から回復されたことと、mgc データベースと mgccomp データベースが再構築されトポロジ ビルダーを使用して再インストールを想定しています。
  
また、フェールオーバー期間に新たにミラー サーバーやバックアップ サーバーは展開されていないこと、および前述した「常設チャット サーバーのフェールオーバー」で定義されているように、展開されたサーバーはバックアップ サーバーとそのミラー サーバーだけであることを想定しています。
  
この手順の意図は、プライマリ サーバーからバックアップ サーバーへのフェールオーバーの原因となった障害が発生する前の状態に構成を復旧することにあります。
  
1. ビジネス サーバー管理シェルには、Skype から**セット CsPersistentChatActiveServer**コマンドレットを使用して永続的なチャット アクティブ サーバー] ボックスの一覧からすべてのサーバーをオフにします。 これは、永続的なチャットからすべてのサーバーのフェイル バック中 mgc データベースと mgccomp データベースへの接続を停止します。
    
    > [!IMPORTANT]
    > セカンダリ上の SQL Server エージェント権限を持つアカウントで、永続的なチャット サーバー バック エンド サーバーを実行する必要があります。 このアカウントには、次のアクセス許可が与えられている必要があります。 
  
   - バックアップが置かれるネットワーク共有に対する読み取りアクセス
    
   - バックアップのコピー先となるローカル ディレクトリに対する書き込みアクセス
    
2. バックアップ mgc データベースでのミラーリングを無効にします。
    
   - SQL Server Management Studio を使用すると、バックアップの mgc のインスタンスに接続します。
    
   - mgc データベースを右クリックし、[**タスク**] をポイントしてから、[**ミラー**] をクリックします。
    
   - [**ミラーリングの削除**] をクリックします。
    
   - [**OK**] をクリックします。
    
   - mgccomp データベースに対しても同じ手順を実行します。
    
3. mgc データベースをバックアップして、新しいプライマリ データベースに復元できるようにします。
    
   - SQL Server Management Studio を使用すると、バックアップの mgc のインスタンスに接続します。
    
   - mgc データベースを右クリックし、[**タスク**] をポイントしてから、[**バックアップ**] をクリックします。[**データベースのバックアップ**] ダイアログ ボックスが表示されます。
    
   - [**バックアップの種類**] で、[**完全**] を選択します。
    
   - [**バックアップ コンポーネント**] として、[**データベース**] をクリックします。
    
   - [**名前**] に表示される既定のバックアップ セット名をそのまま使用するか、バックアップ セット名として別の名前を入力します。
    
   -  *\<オプション\>* [**説明**] にバックアップ セットの説明を入力します。
    
   - バックアップ先の一覧から既定のバックアップ場所を削除します。
    
   - ログ配布用に設定した共有の場所へのパスを使用して、この一覧にファイルを追加します。このパスはプライマリ データベースとバックアップ データベースの両方に使用できます。
    
   - [**OK**] をクリックします。ダイアログ ボックスが閉じられ、バックアップ プロセスが開始されます。
    
4. 上記のステップで作成されたバックアップ データベースを使用して、プライマリ データベースを復元します。
    
   - SQL Server Management Studio を使用して、mgc のプライマリ ・ インスタンスに接続します。
    
   - mgc データベースを右クリックし、[**タスク**]、[**復元**] の順にポイントしてから、[**データベース**] をクリックします。[**データベースの復元**] ダイアログ ボックスが表示されます。
    
   - [**復元元デバイス**] を選択します。
    
   - [参照] ボタンをクリックします。[**バックアップの指定**] ダイアログ ボックスが表示されます。[**バックアップ メディア**] で、[**ファイル**] を選択します。[**追加**] をクリックし、ステップ 3 で作成したバックアップ ファイルを選択し、[**OK**] をクリックします。
    
   - [**復元するバックアップ セットの選択**] で、バックアップを選択します。
    
   - [**ページの選択**] ウィンドウで、[**オプション**] をクリックします。
    
   - [**復元オプション**] で、[**既存のデータベースを上書きする**] を選択します。
    
   - [**復旧状態**] で、[**データベースを使用可能な状態にする**] を選択します。
    
   - [**OK**] をクリックします。復元プロセスが開始されます。
    
5. プライマリ ・ データベースの SQL Server のログ配布を構成します。 [構成の高可用性と災害復旧業務サーバー 2015 の Skype での永続的なチャット サーバーの](../../deploy/deploy-persistent-chat-server/configure-hadr-for-persistent-chat.md)mgc のプライマリ データベースのログ配布を設定する手順に従います。
    
6. 永続的なチャット サーバーのアクティブなサーバーを設定します。 ビジネス サーバー管理シェルの Skype からには、アクティブなサーバーの一覧を設定するのには、**セット CsPersistentChatActiveServer**コマンドレットを使用します。
    
    > [!IMPORTANT]
    > すべてのアクティブ サーバーは、新しいプライマリ データベースと同じデータ センター内、またはデータベースへの接続が低待機時間/高帯域幅であるデータ センター内に配置する必要があります。 
  
プールを通常に戻すには、状態は、次の Windows PowerShell コマンドを実行します。
  
```
Set-CsPersistentChatState -Identity "service: lyncpc.dci.discovery.com" -PoolState Normal
```

詳細については、[Set-CsPersistentChatState](https://docs.microsoft.com/powershell/module/skype/set-cspersistentchatstate?view=skype-ps) コマンドレットのヘルプ トピックを参照してください。
  

