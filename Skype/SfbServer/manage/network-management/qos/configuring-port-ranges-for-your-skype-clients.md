---
title: クライアントのポート範囲とサービス品質ポリシーを構成する
ms.reviewer: ''
ms:assetid: 287d5cea-7ada-461c-9b4a-9da2af315e71
ms:mtpsurl: https://technet.microsoft.com/en-us/library/JJ204760(v=OCS.15)
ms:contentKeyID: 48183694
mtps_version: v=OCS.15
ms.author: v-lanac
author: lanachin
manager: serdars
audience: ITPro
ms.topic: article
ms.prod: skype-for-business-itpro
localization_priority: Normal
description: この記事では、Windows 10 で実行されているクライアントのために、クライアントのポート範囲を構成し、サービスの品質ポリシーを構成する方法について説明します。
ms.openlocfilehash: ce1690c295f1f5ed991780919370e5dbf5b5d6b1
ms.sourcegitcommit: f7ec026accb0bb91ce62a9d5f24ac4b70a514c4e
ms.translationtype: MT
ms.contentlocale: ja-JP
ms.lasthandoff: 06/25/2019
ms.locfileid: "35204015"
---
# <a name="configuring-port-ranges-and-a-quality-of-service-policy-for-your-clients-in-skype-for-business-server"></a>Skype for Business Server でのクライアントのポート範囲とサービス品質ポリシーの構成

この記事では、Windows 10 で実行されているクライアントのために、クライアントのポート範囲を構成し、サービスの品質ポリシーを構成する方法について説明します。

## <a name="configure-port-ranges"></a>ポート範囲を構成する

既定では、Skype for Business クライアントアプリケーションは、通信セッションに参加している場合は、ポート1024と65535の間の任意のポートを使用できます。これは、特定のポート範囲がクライアントに対して自動的に有効にならないためです。 ただし、サービスの品質を使用するためには、さまざまな種類のトラフィック (オーディオ、ビデオ、メディア、アプリケーション共有、ファイル転送) を、一連の固有のポート範囲に割り当てる必要があります。 これを行うには、CsConferencingConfiguration コマンドレットを使用します。

> [!NOTE]  
> エンドユーザーはこれらの変更を行うことはできません。 ポートの変更は、CsConferencingConfiguration コマンドレットを使用している管理者のみが実行できます。


現在通信セッションに使用されているポート範囲を特定するには、Skype for Business Server 管理シェルで次のコマンドを実行します。

    Get-CsConferencingConfiguration

Skype for Business Server をインストールしてから会議の設定を変更していない場合は、次のプロパティ値を含む情報が返されます。

    ClientMediaPortRangeEnabled : False
    ClientAudioPort             : 5350
    ClientAudioPortRange        : 40
    ClientVideoPort             : 5350
    ClientVideoPortRange        : 40
    ClientAppSharingPort        : 5350
    ClientAppSharingPortRange   : 40
    ClientFileTransferPort      : 5350
    ClientTransferPortRange     : 40

上記の出力をよく見ると、2つの重要な点が表示されます。 まず、ClientMediaPortRangeEnabled プロパティが False に設定されます。

    ClientMediaPortRangeEnabled : False

このプロパティが False に設定されている場合、Skype for Business クライアントは、通信セッションに関与するときに、ポート1024と65535の間で使用可能なポートを使用します。これは、他のポート設定 (ClientMediaPort や ClientVideoPort など) に関係なく true になります。 指定した一連のポートに使用を制限する場合 (これは、サービスの品質の実装を計画している場合に実行します)、まずクライアントのメディアポート範囲を有効にする必要があります。 この操作を行うには、次の Windows PowerShell コマンドを使用します。

    Set-CsConferencingConfiguration -ClientMediaPortRangeEnabled $True

上のコマンドを実行すると、会議構成設定のグローバルコレクションに対してクライアントのメディアポート範囲が有効になります。ただし、これらの設定は、サイトのスコープやサービスの範囲 (会議サーバーサービスのみ) に適用することもできます。 特定のサイトまたはサーバーに対してクライアントのメディアポート範囲を有効にするには、Set-CsConferencingConfiguration を呼び出すときにそのサイトまたはサーバーの Id を指定します。

    Set-CsConferencingConfiguration -Identity "site:Redmond" -ClientMediaPortRangeEnabled $True

または、このコマンドを使用して、すべての会議構成設定のポート範囲を同時に有効にすることもできます。

    Get-CsConferencingConfiguration | Set-CsConferencingConfiguration  -ClientMediaPortRangeEnabled $True

2番目の重要な点は、既定では、各種類のネットワークトラフィックに設定されたメディアポート範囲が同じであることを示しています。

    ClientAudioPort             : 5350
    ClientVideoPort             : 5350
    ClientAppSharingPort        : 5350
    ClientFileTransferPort      : 5350

QoS を実装するために、これらの各ポート範囲は一意である必要があります。 たとえば、次のようなポート範囲を構成することができます。


<table>
<colgroup>
<col style="width: 33%" />
<col style="width: 33%" />
<col style="width: 33%" />
</colgroup>
<thead>
<tr class="header">
<th>クライアントトラフィックの種類</th>
<th>ポートの開始</th>
<th>ポートの範囲</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td><p>オーディオ</p></td>
<td><p>50020</p></td>
<td><p>超える</p></td>
</tr>
<tr class="even">
<td><p>ビデオ</p></td>
<td><p>58000</p></td>
<td><p>超える</p></td>
</tr>
<tr class="odd">
<td><p>アプリケーション共有</p></td>
<td><p>42000</p></td>
<td><p>超える</p></td>
</tr>
<tr class="even">
<td><p>ファイル転送</p></td>
<td><p>42020</p></td>
<td><p>超える</p></td>
</tr>
</tbody>
</table>


上の表のクライアントポート範囲は、サーバーに構成されているポート範囲のサブセットを表しています。 たとえば、サーバー上では、40803 ~ 49151 のポートを使用するようにアプリケーション共有が構成されています。クライアントコンピューターでは、[アプリケーション共有] は、42000 ~ 42019 のポートを使用するように構成されます。 これは主に、QoS の管理を簡単にするために行われています。クライアントポートは、サーバーで使われているポートのサブセットを表す必要はありません。 (たとえば、クライアントコンピューターで、1万 ~ 10019 のポートを使用するようにアプリケーション共有を構成することができます)。ただし、クライアントポート範囲をサーバーのポート範囲のサブセットにすることをお勧めします。

また、サーバー上でのアプリケーション共有のために8348のポートが設定されていても、クライアントでのアプリケーション共有については20個のポートしか設定されていないことに気付いた場合もあります。 これもお勧めしますが、これは、ハードとファーストのルールではありません。 一般的に、1つの通信セッションを表すために使用可能な各ポートを検討することができます。ポート範囲で利用可能な100ポートがある場合、そのコンピューターは、いつでも最大100の通信セッションに参加できることを意味します。 サーバーはクライアントよりも多くの会話に参加する可能性があるため、クライアントよりも多くのポートをサーバー上で開くことが適切です。 クライアント上のアプリケーション共有に20個のポートを確保することは、ユーザーが指定したデバイスで20個のアプリケーション共有セッションに参加することを意味します。 これは、ほとんどのユーザーにとって十分なものであることを証明する必要があります。

上のポート範囲を会議の構成設定のグローバルコレクションに割り当てるには、次の Skype for Business Server 管理シェルコマンドを使用できます。

    Set-CsConferencingConfiguration -Identity global -ClientAudioPort 50020 -ClientAudioPortRange 20 -ClientVideoPort 58000 -ClientVideoPortRange 20 -ClientAppSharingPort 42000 -ClientAppSharingPortRange 20 -ClientFileTransferPort 42020 -ClientFileTransferPortRange 20

または、このコマンドを使用して、すべての会議の構成設定にこれらと同じポート範囲を割り当てることができます。

    Get-CsConferencingConfiguration | Set-CsConferencingConfiguration -ClientAudioPort 50020 -ClientAudioPortRange 20 -ClientVideoPort 58000 -ClientVideoPortRange 20 -ClientAppSharingPort 42000 -ClientAppSharingPortRange 20 -ClientFileTransferPort 42020 -ClientFileTransferPortRange 20

個々のユーザーは、Skype for Business からログオフしてから再びログインする必要があります。これらの変更は実際に有効になります。

> [!NOTE]  
> クライアントのメディアポート範囲を有効にして、1つのコマンドを使用してこれらのポート範囲を割り当てることもできます。 次に例を示します。<BR><CODE>Set-CsConferencingConfiguration -ClientMediaPortRangeEnabled $True -ClientAudioPort 50020 -ClientAudioPortRange 20 -ClientVideoPort 58000 -ClientVideoPortRange 20 -ClientAppSharingPort 42000 -ClientAppSharingPortRange 20 -ClientFileTransferPort 42020 -ClientFileTransferPortRange 20</CODE>

## <a name="configure-quality-of-service-policies-for-clients-running-on-windows-10"></a>Windows 10 で実行されているクライアントのサービス品質ポリシーを構成する

Skype for Business クライアントで使用するポート範囲を指定するだけでなく、クライアントコンピューターに適用されるサービスの品質ポリシーを個別に作成する必要があります。 (会議、アプリケーション、および仲介サーバー用に作成されたサービスの品質ポリシーは、クライアントコンピューターに適用しないでください)。この情報は、Skype for Business クライアントと Windows 10 を実行しているコンピューターにのみ適用されます。

次の例では、この一連のポート範囲を使ってオーディオポリシーとビデオポリシーを作成しています。


<table>
<colgroup>
<col style="width: 33%" />
<col style="width: 33%" />
<col style="width: 33%" />
</colgroup>
<thead>
<tr class="header">
<th>クライアントトラフィックの種類</th>
<th>ポートの開始</th>
<th>ポートの範囲</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td><p>オーディオ</p></td>
<td><p>50020</p></td>
<td><p>超える</p></td>
</tr>
<tr class="even">
<td><p>ビデオ</p></td>
<td><p>58000</p></td>
<td><p>超える</p></td>
</tr>
<tr class="odd">
<td><p>アプリケーション共有</p></td>
<td><p>42000</p></td>
<td><p>超える</p></td>
</tr>
<tr class="even">
<td><p>ファイル転送</p></td>
<td><p>42020</p></td>
<td><p>超える</p></td>
</tr>
</tbody>
</table>

Windows 10 コンピューターのサービス品質のオーディオポリシーを作成するには、まずグループポリシー管理がインストールされているコンピューターにログオンします。 [グループポリシーの管理] を開き ([**スタート**] をクリックし、[**管理ツール**] をポイントして、[**グループポリシーの管理**] をクリックし)、次の手順を実行します。

1.  [グループポリシーの管理] で、新しいポリシーを作成するコンテナーを見つけます。 たとえば、すべてのクライアントコンピューターがクライアントという名前の OU に配置されている場合、新しいポリシーがクライアント OU に作成されます。

2.  適切なコンテナーを右クリックし、[**このドメインに GPO を作成**] をクリックして、ここにリンクを設定します。

3.  [**新しい GPO** ] ダイアログボックスの [**名前**] ボックスに新しいグループポリシーオブジェクトの名前を入力し、[ **OK**] をクリックします。

4.  新しく作成したポリシーを右クリックし、[**編集**] をクリックします。

5.  グループポリシー管理エディターで、[**コンピューターの構成**]、[ **Windows の設定**] の順に展開し、[**ポリシーベースの QoS**] を右クリックして、[**新しいポリシーの作成**] をクリックします。

6.  [**ポリシーベースの QoS** ] ダイアログボックスの [開く] ページで、[**名前**] ボックスに新しいポリシーの名前を入力します。 [ **DSCP 値の指定**] を選択し、値を**46**に設定します。 [**送信スロットルの比率を指定する**] をオフにして、[**次へ**] をクリックします。

7.  次のページで、[**この実行可能ファイル名のアプリケーションのみ**] を選択し、名前として「 **Lync** 」と入力して、[**次へ**] をクリックします。 この設定では、Skype for Business クライアントからの一致トラフィックのみの優先順位付けをポリシーに指示します。

8.  3番目のページで、[**ソース ip アドレス**] と [**宛先 ip アドレス**] の両方が選択されていることを確認し、[**次へ**] をクリックします。 この2つの設定では、どのコンピューター (IP アドレス) がそれらのパケットを送信したか、どのコンピューター (IP アドレス) がそれらのパケットを受信するかに関係なく、パケットが管理されるようにします。

9.  4ページ目で、[**この QoS ポリシーが適用されるプロトコルを選択**してください] ドロップダウンリストから [ **TCP および UDP** ] を選びます。 TCP (伝送制御プロトコル) と UDP (ユーザーデータグラムプロトコル) は、Skype for Business Server およびそのクライアントアプリケーションで最も一般的に使用される2つのネットワークプロトコルです。

10. 見出しの下で、**ソースポート番号を指定**して、[**このソースポートまたは範囲から**] を選択します。 [付随するテキスト] ボックスに、オーディオ送信用に予約されているポート範囲を入力します。 たとえば、ポート50020からオーディオトラフィック用にポート50039を予約した場合、次の形式を使用してポート範囲を入力します**50020:50039**。 [**完了**] をクリックします。

オーディオの QoS ポリシーを作成したら、ビデオ用の第2のポリシーを作成する必要があります。 ビデオのポリシーを作成するには、オーディオポリシーを作成する場合と同じ基本的な手順に従い、次のように置き換えます。

  - 別の (一意の) ポリシー名を使用します。

  - DSCP 値を46ではなく、 **34**に設定します。 (前に説明したように、DSCP 値34を使用する必要はありません。単に、オーディオに使用されている別の DSCP 値を割り当てる必要があります)。

  - 以前に構成されたポート範囲をビデオトラフィックに使用します。 たとえば、ビデオ用にポート 58000 ~ 58019 を予約している場合は、ポート範囲を次のよう**58000:58019**に設定します。

アプリケーション共有トラフィックを管理するためのポリシーを作成する場合は、次のように置き換えます。

  - 別の (一意の) ポリシー名 (「 **Skype For Business Server アプリケーション共有**」など) を使用します。

  - DSCP 値を46の代わりに**24**に設定します。 (この値は、必ずしも24である必要はありません。単に、音声とビデオに使われる DSCP 値とは異なる必要があります)。

  - 以前に構成されたポート範囲をビデオトラフィックに使用します。 たとえば、アプリケーション共有用にポート 42000 ~ 42019 を予約している場合は、ポート範囲を " **42000:42019**" に設定します。

ファイル転送ポリシーの場合:

  - 別の (一意の) ポリシー名を使用します (たとえば、 **Skype For Business Server ファイル転送**)。

  - DSCP 値を**14**に設定します。 (この値は、14でなくてもかまいません。単に一意の DSCP コードである必要があります)。

  - 以前に構成されたアプリケーションのポート範囲を使用します。 たとえば、アプリケーション共有用にポート 42020 ~ 42039 を予約している場合は、ポート範囲を " **42020:42039**" に設定します。

クライアントコンピューターでグループポリシーが更新されるまで、作成した新しいポリシーは有効になりません。 グループ ポリシーは定期的に自動更新されますが、グループ ポリシーを更新する必要がある各コンピューター上で次のコマンドを実行すると、即座に強制的に更新することができます。

    Gpudate.exe /force

このコマンドは、管理者の資格情報のもとで実行されているコマンド ウィンドウから実行できます。 管理者の資格情報のもとでコマンド ウィンドウを開くには、[**スタート**] メニューをクリックし、[**コマンド プロンプト**] を右クリックして、[**管理者として実行**] をクリックします。

これらのポリシーは、クライアントコンピューターのターゲットにする必要があることに注意してください。 Skype for Business Server を実行しているサーバーには適用しないでください。

ネットワークパケットが適切な DSCP 値でマークされていることを確認するには、次の手順に従って、各コンピューターに新しいレジストリエントリを作成する必要もあります。

1.  [**スタート**] ボタンをクリックし、[**ファイル名を指定して実行**] をクリックします。

2.  [**実行**] ダイアログボックスで、「 **regedit**」と入力し、enter キーを押します。

3.  レジストリエディターで、[ **\_HKEY ローカル\_コンピューター**]、[**システム**]、[ **CurrentControlSet**] の順に展開し、[**サービス**] を展開して、[ **Tcpip**] を展開します。

4.  [ **Tcpip**] を右クリックし、[**新規作成**] をポイントして、[**キー**] をクリックします。 新しいレジストリキーが作成されたら、「 **QoS**」と入力し、enter キーを押してキーの名前を変更します。

5.  [ **QoS**] を右クリックし、[**新規作成**] をポイントして、[**文字列値**] をクリックします。 新しいレジストリ値が作成されたら、[ **NLA を使用しない**] と入力し、enter キーを押して値の名前を変更します。

6.  [ **NLA を使わない**] をダブルクリックします。 [**文字列の編集**] ダイアログボックスで、[**値のデータ**] ボックスに「 **1** 」と入力して、[ **OK**] をクリックします。

7.  レジストリエディターを終了し、コンピューターを起動します。

### <a name="configure-quality-of-service-on-computers-with-multiple-network-adapters"></a>複数のネットワークアダプターを搭載したコンピューターでサービスの品質を設定する

複数のネットワークアダプターを搭載したコンピューターを使用している場合、DSCP 値が構成された値ではなく0x00 として表示される問題が発生する場合があります。 これは通常、1つ以上のネットワークアダプターが Active Directory ドメインにアクセスできない (たとえば、これらのアダプターがプライベートネットワーク用に使用されている) 場合に発生します。 このような場合、DSCP 値は、ドメインにアクセスできるアダプターに対してタグ付けされますが、ドメインにアクセスできないアダプターにはタグ付けされません。

ドメインへのアクセス権を持たないアダプターも含め、コンピューターのすべてのネットワークアダプターの DSCP 値にタグを付ける場合は、レジストリに値を追加して構成する必要があります。 この操作を行うには、次の手順を実行します。

1.  [**スタート**] ボタンをクリックし、[**ファイル名を指定して実行**] をクリックします。

2.  [**実行**] ダイアログボックスで、「 **regedit**」と入力し、enter キーを押します。

3.  レジストリエディターで、[ **\_HKEY ローカル\_コンピューター**]、[**システム**]、[ **CurrentControlSet**] の順に展開し、[**サービス**] を展開して、[ **Tcpip**] を展開します。

4.  [ **QoS** ] というラベルのレジストリキーが表示されない場合は、[ **Tcpip**] を右クリックし、[**新規**] をポイントして、[**キー**] をクリックします。 新しいキーを作成したら、「 **QoS**」と入力し、enter キーを押してキーの名前を変更します。

5.  [ **QoS**] を右クリックし、[**新規作成**] をポイントして、[**文字列値**] をクリックします。 新しいレジストリ値が作成されたら、[ **NLA を使用しない**] と入力し、enter キーを押して値の名前を変更します。

6.  [ **NLA を使わない**] をダブルクリックします。 [**文字列の編集**] ダイアログボックスで、[**値のデータ**] ボックスに「 **1** 」と入力して、[ **OK**] をクリックします。

新しいレジストリ値を作成して構成した後、変更を有効にするには、コンピューターを再起動する必要があります。

## <a name="see-also"></a>関連項目

[Windows 10 でグループポリシーオブジェクトを作成する](https://docs.microsoft.com/en-us/windows/security/threat-protection/windows-firewall/create-a-group-policy-object)
