---
title: Skype for Business 2015 の集中ログ サービス
ms.reviewer: ''
ms.author: v-lanac
author: lanachin
manager: serdars
ms.date: 2/1/2018
audience: ITPro
ms.topic: article
ms.prod: skype-for-business-itpro
localization_priority: Normal
ms.collection: IT_Skype16
ms.assetid: 975718a0-f3e3-404d-9453-6224e73bfdd0
description: '概要: Skype for Business Server 2015 の中央集中ログサービスのサービスコンポーネントと構成設定について説明します。'
ms.openlocfilehash: 1dfdc0de999e79182e5beb57c6d51ecc75359672
ms.sourcegitcommit: 2cc98fcecd753e6e8374fc1b5a78b8e3d61e0cf7
ms.translationtype: MT
ms.contentlocale: ja-JP
ms.lasthandoff: 01/08/2020
ms.locfileid: "40992604"
---
# <a name="centralized-logging-service-in-skype-for-business-2015"></a>Skype for Business 2015 の集中ログ サービス
 
**概要:** Skype for Business Server 2015 の中央集中ログサービスのサービスコンポーネントと構成設定について説明します。
  
一元管理サービスでは、次のことができます。 
  
- 1つまたは複数のコンピューターとプールで、1つのコマンドで中央の場所から1つのコマンドでログの記録を開始または停止します。
    
- 1 つ以上のコンピューターとプールに関するログを検索します。 すべてのコンピューター上のすべてのログを返すように検索をカスタマイズしたり、より簡潔な結果を返すことができます。
    
- ログ セッションの構成は次のとおりです。
    
  - **シナリオ**を定義するか、既定のシナリオを使用します。 一元管理サービスのシナリオは、スコープ (グローバルまたはサイト) で構成されています。シナリオ名は、そのシナリオの目的と1つ以上のプロバイダーを識別するために用意されています。 コンピューターでは、既定のシナリオと1つの定義済みシナリオをいつでも実行できます。
    
  - 既存のプロバイダーを使用するか、新しいプロバイダーを作成します。 Aprovider は、ログセッションが収集する内容、詳細レベル、トレースするコンポーネント、および適用されるフラグを定義します。
    
    > [!TIP]
    >  OCSLogger に精通している場合、termproviders は、**コンポーネント**(たとえば、S4, SIPStack)、**ログの種類**(たとえば、WPP、EVENTLOG、または IIS logfile)、**トレースレベル**(たとえば、すべて、verbose、debug)、**フラグ**(TF_COMPONENT、TF_DIAG など) を参照します。 これらの項目は、プロバイダー (Windows PowerShell 変数) で定義され、中央の [ログサービス] コマンドに渡されます。
  
  - 特定のコンピューターとプールのログを構成します。
    
  - ログ セッションの対象範囲を、**サイト** (そのサイトのコンピューターだけでログ キャプチャを実行します) または**グローバル** (展開のすべてのコンピューターでログ キャプチャを実行します) から定義します。
    
一元管理のログサービスは、根本原因の分析からパフォーマンスの問題まで、さまざまな問題を解決するための強力なトラブルシューティングツールです。 すべての例は、Skype for Business Server 管理シェルを使用して表示されます。 ツール自体にコマンドライン ツールのヘルプが用意されていますが、コマンド ラインから実行できる機能は限られています。 Skype for Business Server 管理シェルを使用すると、非常に多くの構成が可能な機能セットにアクセスできるため、常に最初に選択する必要があります。 
  
## <a name="logging-service-components"></a>ログ サービス コンポーネント

 一元管理サービスは、展開されているすべてのサーバーで実行され、次のエージェントとサービスで構成されます。
  
- 一元化された Logging Service Agent の ClsAgent は、Skype for Business Server が展開されているすべてのコンピューターで実行されます。 WCF 経由の ClsController からのコマンドに対して (ポート**TCP 50001-50003**で) リッスンし、応答をコントローラーに戻します。 ログセッション (開始/停止/更新) を管理し、ログを検索します。 また、ログのアーカイブやパージなどのハウスキーピング操作も実行します。 
    
- 一元化されたログサービスコントローラーのコマンドレット。 Skype for Business Server 管理シェルが、[開始]、[停止]、[フラッシュ]、[検索] コマンドを ClsAgent に送信します。 検索コマンドが送信されると、結果として得られたログは Clsコントローラーライブラリに戻され、集計されます。 コントローラーは、エージェントにコマンドを送信し、そのコマンドの状態を受け取り、検索ログファイルデータを、検索範囲内の任意のコンピューター上のすべてのエージェントから返されたデータを収集して、意味のある順序付きの出力セットに集約します。 次のトピックの情報は、Skype for Business Server 管理シェルの使用に重点を置いています。
    
**ClsController と ClsAgent の通信**

![CLSController と CLSAgent の間の関係](../../media/Ops_CLS_Architecture.jpg)
  
Windows Server のコマンドラインインターフェイスまたは Skype for Business Server 管理シェルを使用して、コマンドを実行します。 コマンドは、ログインしているコンピューターで実行され、ローカルまたは展開内の他のコンピューターやプールに送信されます。
  
ClsAgent は、すべてのインデックスファイルを管理します。ローカルコンピューターにあるファイルをキャッシュします。 ClsAgent は、オプション CacheFileLocalFolders によって定義されたボリューム間で均等に分散されるように、各ボリュームの80% を消費しないようにします (つまり、ローカルキャッシュの場所と割合は、 **Set-CsClsConfiguration**コマンドレットを使用して構成できます)。 ClsAgent は、ローカルコンピューターから古いキャッシュされたイベントトレースログ (.etl) ファイルを処理する責任も担います。 2週間後 (つまり、 **Set-CsClsConfiguration**コマンドレットを使用して期間を構成できます)、これらのファイルはファイル共有にコピーされ、ローカルコンピューターから削除されます。 詳細については、「 [Set-CsClsConfiguration](https://docs.microsoft.com/powershell/module/skype/set-csclsconfiguration?view=skype-ps)」を参照してください。 検索要求を受信すると、検索条件を使ってキャッシュされた一連の .etl ファイルが選択され、エージェントによって管理されているインデックス内の値に基づいて検索が実行されます。
  
> [!NOTE]
> ローカル コンピューターからファイル共有に移動されたファイルを ClsAgent で検索できます。ClsAgent がファイルをファイル共有に移動すると、ファイルのエージングと削除は ClsAgent で管理されません。ファイル共有内のファイルのサイズを監視し、ファイルを削除またはアーカイブするための管理タスクを定義する必要があります。 
  
**Snooper.exe** や、テキスト ファイルを読み取ることのできるツール (**Notepad.exe** など) を含むさまざまなツールを使用して、結果のログ ファイルの読み取りと分析を行うことができます。 Snooper は、Skype for Business Server 2015 デバッグツールの一部であり、 [Web ダウンロード](https://go.microsoft.com/fwlink/p/?LinkId=285257)として利用できます。
  
OCSLogger と同様に、一元管理サービスには、追跡対象となるいくつかのコンポーネントがあり、TF_COMPONENT や TF_DIAG などのフラグを選択するオプションが用意されています。 一元管理サービスは、OCSLogger の [ログレベル] オプションも保持します。
  
コマンドラインの ClsController 経由で Skype for Business Server 管理シェルを使用するための最も重要な利点は、問題スペース、カスタムフラグ、およびログレベルを対象とする、選択したプロバイダーを使用して新しいシナリオを構成して定義できることです。 ClsController で使用可能なシナリオは、実行可能ファイル用に定義されるシナリオに制限されます。
  
以前のバージョンでは、管理者とサポート担当者が展開内のコンピューターからトレース ファイルを収集できるようにするために OCSLogger.exe が提供されていました。OCSLogger には、長所と同時に短所も存在しました。ログは一度に 1 台のコンピューター上でしか収集できませんでした。OCSLogger のコピーを使用して複数のコンピューターにログオンすることは可能でしたが、最終的にログが複数作成され、結果を集計するのが容易ではありませんでした。
  
ユーザーがログの検索を要求すると、ClsController が (選択したシナリオに基づいて) 要求の送信先コンピューターを特定します。また、.etl ファイルが保存されているファイル共有に検索を送信する必要があるかどうかを判断します。検索結果が ClsController に返されると、コントローラーが結果をマージして時系列の 1 つの結果セットを作成し、ユーザーに提供します。ユーザーは、ローカル コンピューターに検索結果を保存して、以降の分析に使用できます。
  
ログ記録セッションを開始したら、解決しようとする問題に関連するシナリオを指定します。常に実行することのできるシナリオは 2 つあります。そのうちの 1 つは AlwaysOn シナリオにする必要があります。名前が示すとおり、このシナリオを展開内で常に実行し、すべてのコンピューター、プール、およびコンポーネントに関する情報を収集する必要があります。
  
> [!IMPORTANT]
> 既定では、AlwaysOn シナリオは展開内で実行されません。 このシナリオは明示的に開始する必要があります。 開始したシナリオは明示的に停止されるまで実行され、実行状態はコンピューターを再起動しても保持されます。 シナリオの開始と停止の詳細については、「 [Skype For Business Server 2015 での CLS ログのキャプチャの開始と停止](start-or-stop-log-capture.md)」を参照してください。 
  
問題が発生した場合は、報告された問題に関連する 2 つ目のシナリオを開始します。問題を再現し、2 つ目のシナリオのログ記録を停止します。報告された問題に関連するログの検索を開始します。集計されたログのコレクションによって、展開のサイト スコープまたはグローバル スコープ内のすべてのコンピューターからのトレース メッセージを含むログ ファイルが生成されます。分析可能なデータ以上のデータが検索から返された場合は (通常、信号対ノイズ比とも呼ばれ、この場合はノイズが多すぎる状態です)、パラメーターを絞り込んで別の検索を実行します。この時点で、問題を明確にするために役立つパターンの特定を開始できます。最終的には、いくつかの絞り込み検索を実行した後で問題に関連するデータが見つかり、根本原因を特定できます。
  
> [!TIP]
> Skype for Business Server で問題のシナリオを提示された場合は、"問題に関する情報は何ですか?" というメッセージが表示されます。 問題の境界を定量化すると、Skype for Business Server の運用エンティティの一部を削除することができます。 
  
ユーザーが連絡先を検索するときに現在の結果を取得していないことがわかっているシナリオ例を検討します。 メディアコンポーネント、エンタープライズ Voip、会議、その他のコンポーネントで問題があるかどうかを調べるポイントはありません。 実際はどこに問題が存在するのか (クライアントなのか、サーバー側の問題なのか) がわからないためです。 連絡先は、ユーザーレプリケーターによって Active Directory から収集され、アドレス帳サーバー (ABServer) を介してクライアントに配信されます。 ABServer は、(ユーザーレプリケーターによって作成された) RTC データベースから更新プログラムを取得して、アドレス帳ファイル (既定では 1:30 AM) に収集します。 Skype for Business Server クライアントは、ランダムなスケジュールで新しいアドレス帳を取得します。 プロセスがどのように動作するかがわかっているため、ユーザーレプリケーターによって Active Directory から収集されたデータに関連する問題の可能性を検索したり、ABServer がアドレス帳ファイルを取得して作成したりすることはありません。アドレス帳ファイルをダウンロードしています。
  
## <a name="current-configuration"></a>現在の構成

一元的なログサービスは、ログサービスの収集方法、収集方法、収集される場所、およびログ設定の内容を定義するように構成されています。 これらの設定は、グローバル (展開全体) またはサイト (展開内で指定されたサイト) に対して定義します。 定義するすべてのログで、ログを開始、停止、更新、および検索するコマンドに対して使用する ID に適した設定が使用されます。
  
### <a name="to-display-the-current-centralized-logging-service-configuration"></a>現在の集中化ログサービスの構成を表示するには

1. Skype for Business Server 管理シェルを以下の手順で起動します。[**スタート**]、[**すべてのプログラム**]、[**Skype for Business 2015**]、[**Skype for Business Server 管理シェル**] の順にクリックします。
    
2. コマンド ライン プロンプトで、次のように入力します。
    
   ```PowerShell
   Get-CsClsConfiguration
   ```

    > [!TIP]
    > 定義`-Identity`によって返される構成設定の範囲を絞り込んだり、展開したりすることができます。たとえば、"Site: レドモンド" のように、サイトレドモンドの CsClsConfiguration のみを返すようにします。 構成の特定の部分に関する詳細が必要な場合は、出力を別の Windows PowerShell コマンドレットにパイプすることができます。 たとえば、サイト "Redmond" の構成で定義されているシナリオに関する詳細情報を取得するには、次のように入力します。`Get-CsClsConfiguration -Identity "site:Redmond" | Select-Object -ExpandProperty Scenarios`
  
     ![Get-CsClsConfiguration からのサンプル出力](../../media/Ops_Get-CsClsConfiguration_Basic.jpg)
  
    このコマンドレットの結果には、一元管理サービスの現在の構成が表示されます。
    
|**構成設定**|**説明**|
|:-----|:-----|
|**Identity** <br/> |この構成のスコープと名前を識別します。存在するグローバル構成は 1 つのみで、サイトごとに 1 つの構成があります。  <br/> |
|**Scenarios** <br/> |この構成に対して定義されたシナリオの一覧。  <br/> |
|**SearchTerms** <br/> |構成の定義済み検索用語。 Office 365、オンプレミス展開ではありません。  <br/> |
|**SecurityGroups** <br/> |コンピューターを確認できるユーザー (つまり、セキュリティ グループのメンバー) を、そのユーザーのサイトに基づいて制御する定義済みセキュリティ グループ。 このコンテキストのサイトは、トポロジビルダーで定義されているサイトです。  <br/> |
|**Regions** <br/> |SecurityGroups を地域にまとめる際に定義済み地域が使用されます。  <br/> |
|**EtlFileRolloverSizeMB** <br/> |パラメーターは、新しいイベント トレース ログ (.etl) ファイルが作成される前のログ ファイルの最大サイズを示します。定義したサイズに達すると、EtlFileRolloverMinutes で設定された最大時間に達していなくても、新しいログ ファイルが作成されます。  <br/> |
|**EtlFileRolloverMinutes** <br/> |新しい .etl ファイルが作成されるまでのログの定義済み最大経過時間 (分単位)。指定した時間が過ぎると、EtlFileRolloverSizeMBE で設定された最大サイズに達していなくても、新しいログ ファイルが作成されます。  <br/> |
|**TmfFileSearchPath** <br/> |トレース メッセージ形式のファイルを検索する場所。  <br/> |
|**CacheFileLocalFolders** <br/> |キャッシュ ファイルが書き込まれるコンピューター上の場所への定義済みパス。CLSAgent はキャッシュ ファイルを書き込み、ネットワーク サービスとの関連で実行されます。この場合は、%TEMP% が %WINDIR%\ServiceProfiles\NetworkService\AppData\Local に展開されます。既定では、キャッシュ ファイルとログ ファイルは同じディレクトリに書き込まれます。  <br/> |
|**CacheFileNetworkFolder** <br/> |汎用名前付け規則 (UNC) パスを定義すると、ログ操作中にキャッシュ ファイルを受け取ることができます。  <br/> |
|**CacheFileLocalRetentionPeriod** <br/> |キャッシュ ファイルが保持される最大時間 (日単位) として定義されます。  <br/> |
|**CacheFileMaxDiskUsage** <br/> |キャッシュ ファイルで使用できるディスク容量の割合として定義されます。  <br/> |
|**ComponentThrottleLimit** <br/> |自動調整制限がトリガーされるまでの、コンポーネントが生成できる秒あたりの最大トレース数として定義されます。  <br/> |
|**ComponentThrottleSample** <br/> |ComponentThrottleLimit を超えることができる 60 秒単位の回数。  <br/> |
|**MinimumClsAgentServiceVersion** <br/> |実行が許可されている CLSAgent の最小バージョン。 この要素は、Office 365 を対象としています。  <br/> |
   

