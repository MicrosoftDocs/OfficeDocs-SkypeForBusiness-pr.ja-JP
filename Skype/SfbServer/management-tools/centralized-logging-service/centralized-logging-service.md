---
title: Skype for Business 2015 の集中ログ サービス
ms.reviewer: ''
ms.author: v-cichur
author: cichur
manager: serdars
ms.date: 2/1/2018
audience: ITPro
ms.topic: article
ms.prod: skype-for-business-itpro
f1.keywords:
- NOCSH
localization_priority: Normal
ms.collection: IT_Skype16
ms.assetid: 975718a0-f3e3-404d-9453-6224e73bfdd0
description: '概要: Skype for Business Server 2015 の集中ログ サービスのサービス コンポーネントと構成設定について説明します。'
ms.openlocfilehash: 7cc49d258011334d7c72bca3f55d5f83ae5d06af
ms.sourcegitcommit: 01087be29daa3abce7d3b03a55ba5ef8db4ca161
ms.translationtype: MT
ms.contentlocale: ja-JP
ms.lasthandoff: 03/23/2021
ms.locfileid: "51098873"
---
# <a name="centralized-logging-service-in-skype-for-business-2015"></a>Skype for Business 2015 の集中ログ サービス
 
**概要:** Skype for Business Server 2015 の集中ログ サービスのサービス コンポーネントと構成設定について説明します。
  
集中ログ サービスでは、次の処理を実行できます。 
  
- 1 つのコマンドを使用して、1 つ以上のコンピューターとプールのログ記録を開始または停止します。中央の場所から実行します。
    
- 1 つ以上のコンピューターとプールでログを検索します。 検索を調整して、すべてのコンピューター上のすべてのログを返したり、より簡潔な結果を返したりできます。
    
- ログ セッションの構成は次のとおりです。
    
  - **シナリオ** を定義するか、既定のシナリオを使用します。 集中ログ サービスのシナリオは、スコープ (グローバルまたはサイト)、シナリオの目的を識別するシナリオ名、および 1 つ以上のプロバイダーで構成されます。 既定のシナリオと 1 つの定義されたシナリオは、コンピューター上で任意の時点で実行できます。
    
  - 既存のプロバイダーを使用するか、新しいプロバイダーを作成します。 Aprovider は、ログ セッションが収集する情報、詳細レベル、トレースするコンポーネント、および適用されるフラグを定義します。
    
    > [!TIP]
    >  OCSLogger に精通している場合、用語プロバイダーは、**コンポーネントのコレクション**(S4、SIPStack など)、ログの種類 (WPP、EventLog、IIS ログ ファイルなど)、トレース レベル(All、verbose、debug など)、フラグ (TF_COMPONENT、TF_DIAG など) を参照します。 これらのアイテムは、プロバイダー (Windows PowerShell変数) で定義され、集中ログ サービス コマンドに渡されます。
  
  - 特定のコンピューターとプールのログを構成します。
    
  - オプション Site (そのサイト内のコンピューターでのみログ キャプチャを実行する場合) または **グローバル****(展開** 内のすべてのコンピューターでログ 記録キャプチャを実行する) からログ セッションの範囲を定義します。
    
集中ログ サービスは、根本原因分析からパフォーマンスの問題まで、大小の問題に対する強力なトラブルシューティング ツールです。 すべての例は、Skype for Business Server 管理シェルを使用して示されています。 コマンド ライン ツールのヘルプは、ツール自体を介して提供されますが、コマンド ラインから実行できる機能のセットは限られています。 Skype for Business Server 管理シェルを使用すると、はるかに大きく構成可能な一連の機能にアクセスできます。 
  
## <a name="logging-service-components"></a>サービス コンポーネントのログ記録

 集中ログ サービスは展開内のすべてのサーバーで実行され、次のエージェントとサービスで構成されます。
  
- 集中ログ サービス エージェント ClsAgent は、Skype for Business Server が展開されたすべてのコンピューターで実行されます。 ClsController から WCF 上のコマンドをリッスンし( **ポート TCP 50001~50003)、** 応答をコントローラーに返します。 ログ セッション (開始/停止/更新) を管理し、ログを検索します。 また、ログのアーカイブや削除などのハウスキーピング操作も実行します。 
    
- 集中ログ サービス コントローラー コマンドレット Skype for Business Server 管理シェルは、スタート、停止、フラッシュ、および検索コマンドを ClsAgent に送信します。 検索コマンドが送信された場合、結果のログはデータベースに返され、ClsControllerLib.dllされます。 コントローラーは、エージェントにコマンドを送信し、それらのコマンドの状態を受信し、検索スコープ内のすべてのコンピューター上のすべてのエージェントから返される検索ログ ファイル データを管理し、ログ データを意味のある順序付き出力セットに集約します。 次のトピックの情報は、Skype for Business Server 管理シェルの使用に重点を置いて説明します。
    
**ClsController から ClsAgent への通信**

![CLSController と CLSAgent の関係。](../../media/Ops_CLS_Architecture.jpg)
  
Windows Server コマンド ライン インターフェイスを使用するか、Skype for Business Server 管理シェルを使用してコマンドを発行します。 コマンドは、ログインしているコンピューター上で実行され、ClsAgent にローカルで送信されます。または展開内の他のコンピューターとプールに送信されます。
  
ClsAgent は、すべてのインデックス ファイルを保持します。ローカル コンピューターに含む CACHE ファイル。 ClsAgent は、オプション CacheFileLocalFolders で定義されたボリューム間で均等に分散され、各ボリュームの 80% を超える消費を行う (つまり、ローカル キャッシュの場所と割合が **Set-CsClsConfiguration** コマンドレットを使用して構成可能) ので、それらを割り当てる。 ClsAgent は、ローカル コンピューターから古いキャッシュされたイベント トレース ログ (.etl) ファイルをエージングする責任もあります。 2 週間後 (つまり **、Set-CsClsConfiguration** コマンドレットを使用して時間枠を構成できます)、これらのファイルはファイル共有にコピーされ、ローカル コンピューターから削除されます。 詳細については [、「Set-CsClsConfiguration」を参照してください](/powershell/module/skype/set-csclsconfiguration?view=skype-ps)。 検索要求を受信すると、検索条件を使用してキャッシュされた .etl ファイルのセットを選択し、エージェントが管理するインデックスの値に基づいて検索を実行します。
  
> [!NOTE]
> ローカル コンピューターからファイル共有に移動されたファイルは、ClsAgent で検索できます。 ClsAgent がファイル共有にファイルを移動すると、ファイルのエージングと削除は ClsAgent によって維持されません。 ファイル共有内のファイルのサイズを監視し、それらを削除またはアーカイブする管理タスクを定義する必要があります。 
  
結果のログ ファイルは **、Snooper.exe** やNotepad.exeなどのテキスト ファイルを読み取るツールなど、さまざまなツールを使用して読み **取りおよび分析できます**。 Snooper.exe Skype for Business Server 2015 デバッグ ツールの一部であり、Web ダウンロードとして [利用できます](https://go.microsoft.com/fwlink/p/?LinkId=285257)。
  
OCSLogger と同様に、集中ログ サービスにはトレースするコンポーネントがいくつか含め、TF_COMPONENT や TF_DIAG などのフラグを選択するオプションが提供されます。 集中ログ サービスでは、OCSLogger のログ レベル オプションも保持されます。
  
コマンド ライン ClsController で Skype for Business Server 管理シェルを使用する最も重要な利点は、問題領域、カスタム フラグ、およびログ レベルを対象とする選択したプロバイダーを使用して新しいシナリオを構成および定義できる点です。 ClsController で使用できるシナリオは、実行可能ファイルに対して定義されているシナリオに制限されます。
  
以前のバージョンでは、管理者OCSLogger.exeサポート担当者が展開内のコンピューターからトレース ファイルを収集する機能が提供されています。 OCSLogger は、すべての強みのために、欠点を持っていた。 ログを収集できるのは、一度に 1 つのコンピューターのみです。 OCSLogger の個別のコピーを使用して複数のコンピューターにログオンできますが、複数のログが作成され、結果を簡単に集計する方法が得れなくなっています。
  
ユーザーがログ検索を要求すると、ClsController は要求を送信するコンピューター (つまり、選択したシナリオに基づいて) を決定します。 また、保存された .etl ファイルが保存されているファイル共有に検索を送信する必要があるかどうかを決定します。 検索結果が ClsController に返された場合、コントローラーは結果をユーザーに提示される 1 つの時間順の結果セットにマージします。 ユーザーは、検索結果をローカル コンピューターに保存して、詳細な分析を行います。
  
ログ セッションを開始するときに、解決しようとしている問題に関連するシナリオを指定します。 2 つのシナリオをいつでも実行できます。 これら 2 つのシナリオの 1 つは AlwaysOn シナリオである必要があります。 名前が示すように、展開内で常に実行し、すべてのコンピューター、プール、およびコンポーネントに関する情報を収集する必要があります。
  
> [!IMPORTANT]
> 既定では、AlwaysOn シナリオは展開で実行されません。 シナリオを明示的に開始する必要があります。 一度起動すると、明示的に停止するまで実行が続行され、コンピューターの再起動によって実行中の状態が維持されます。 シナリオの開始と停止の詳細については、「Start or stop CLS log [capture in Skype for Business Server 2015」を参照](start-or-stop-log-capture.md)してください。 
  
問題が発生した場合は、報告された問題に関連する 2 つ目のシナリオを開始します。 問題を再現し、2 番目のシナリオのログ記録を停止します。 報告された問題を基準にログ検索を開始します。 ログの集約されたコレクションは、展開のサイトまたはグローバル スコープ内のすべてのコンピューターからのトレース メッセージを含むログ ファイルを生成します。 検索で、分析可能なデータよりも多くのデータが返される場合 (通常は、ノイズが高すぎる信号対雑音比と呼ばれる)、より狭いパラメーターで別の検索を実行します。 この時点で、表示されるパターンに気付き始め、問題に対するより明確なフォーカスを得るのに役立ちます。 最終的には、いくつかの絞り込み検索を実行した後、問題に関連するデータを見つけて、根本的な原因を把握できます。
  
> [!TIP]
> Skype for Business Server で問題のシナリオが表示された場合は、まず「問題について既に何を知っていますか」という質問から始める必要があります。 問題の境界を数値化すると、Skype for Business Server の運用エンティティの大部分を排除できます。 
  
連絡先を探す際に、ユーザーが現在の結果を取得していないと分かっているシナリオの例を考えます。 メディア コンポーネント、会議、会議、および他の多数のコンポーネントで問題エンタープライズ VoIP探す意味はありません。 実際に問題がどこにあるのか、クライアント上にあるか、それともサーバー側の問題なのかが分からない場合があります。 連絡先は、ユーザー レプリケーターによって Active Directory から収集され、アドレス帳サーバー (ABServer) を使用してクライアントに配信されます。 ABServer は RTC データベース (ユーザー レプリケーターが書き込んだ場所) から更新プログラムを取得し、既定では午前 1 時 30 分にアドレス帳ファイルに収集します。 Skype for Business Server クライアントは、ランダムなスケジュールで新しいアドレス帳を取得します。 プロセスのしくみを知っているから、ユーザー レプリケーターによって Active Directory から収集されるデータ、ABServer がアドレス帳ファイルを取得して作成しない、またはアドレス帳ファイルをダウンロードしていないクライアントに関連する問題の潜在的な原因の検索を減らします。
  
## <a name="current-configuration"></a>現在の構成

集中ログ サービスは、ログ サービスの収集対象、収集方法、収集元、ログ設定を定義するように構成されています。 これらの設定は、グローバル (つまり、展開全体) またはサイト (つまり、展開内の名前付きサイト) に対して定義します。 定義するすべてのログで、ログを開始、停止、更新、および検索するコマンドに対して使用する ID に適した設定が使用されます。
  
### <a name="to-display-the-current-centralized-logging-service-configuration"></a>現在の集中ログ サービス構成を表示するには

1. Skype for Business Server 管理シェルを開始する: **[スタート**] をクリックし、[すべてのプログラム] をクリックし **、[Skype for Business 2015]** をクリックし、[Skype for Business Server 管理シェル]**をクリックします**。
    
2. コマンド ライン プロンプトで、次のように入力します。
    
   ```PowerShell
   Get-CsClsConfiguration
   ```

    > [!TIP]
    > 定義によって返される構成設定の範囲と、"Site:Redmond" などの範囲を絞り込みまたは展開して、サイト Redmond の  `-Identity` CsClsConfiguration のみを返します。 構成の特定の部分に関する詳細が必要な場合は、出力を別のコマンドレットにパイプWindows PowerShellできます。 たとえば、サイト "Redmond" の構成で定義されているシナリオの詳細を取得するには、次のように入力します。 `Get-CsClsConfiguration -Identity "site:Redmond" | Select-Object -ExpandProperty Scenarios`
  
     ![Get-CsClsConfiguration からの出力例。](../../media/Ops_Get-CsClsConfiguration_Basic.jpg)
  
    コマンドレットの結果には、集中ログ サービスの現在の構成が表示されます。
    
|**構成設定**|**説明**|
|:-----|:-----|
|**Identity** <br/> |この構成のスコープと名前を識別します。存在するグローバル構成は 1 つのみで、サイトごとに 1 つの構成があります。  <br/> |
|**Scenarios** <br/> |この構成に対して定義されたシナリオの一覧。  <br/> |
|**SearchTerms** <br/> |構成の定義済み検索用語。 Microsoft 365 または Officeオンプレミス展開ではなく、365 を使用します。  <br/> |
|**SecurityGroups** <br/> |コンピューターを確認できるユーザー (つまり、セキュリティ グループのメンバー) を、そのユーザーのサイトに基づいて制御する定義済みセキュリティ グループ。 このコンテキストでは、サイトはトポロジ ビルダーで定義されているサイトです。  <br/> |
|**地域** <br/> |SecurityGroups を地域にまとめる際に定義済み地域が使用されます。  <br/> |
|**EtlFileRolloverSizeMB** <br/> |パラメーターは、新しいイベント トレース ログ (.etl) ファイルが作成される前のログ ファイルの最大サイズを示します。定義したサイズに達すると、EtlFileRolloverMinutes で設定された最大時間に達していなくても、新しいログ ファイルが作成されます。  <br/> |
|**EtlFileRolloverMinutes** <br/> |新しい .etl ファイルが作成されるまでのログの定義済み最大経過時間 (分単位)。指定した時間が過ぎると、EtlFileRolloverSizeMBE で設定された最大サイズに達していなくても、新しいログ ファイルが作成されます。  <br/> |
|**TmfFileSearchPath** <br/> |トレース メッセージ形式のファイルを検索する場所。  <br/> |
|**CacheFileLocalFolders** <br/> |キャッシュ ファイルが書き込まれるコンピューター上の場所への定義済みパス。CLSAgent はキャッシュ ファイルを書き込み、ネットワーク サービスとの関連で実行されます。この場合は、%TEMP% が %WINDIR%\ServiceProfiles\NetworkService\AppData\Local に展開されます。既定では、キャッシュ ファイルとログ ファイルは同じディレクトリに書き込まれます。  <br/> |
|**CacheFileNetworkFolder** <br/> |汎用名前付け規則 (UNC) パスを定義すると、ログ操作中にキャッシュ ファイルを受け取ることができます。  <br/> |
|**CacheFileLocalRetentionPeriod** <br/> |キャッシュ ファイルが保持される最大時間 (日単位) として定義されます。  <br/> |
|**CacheFileMaxDiskUsage** <br/> |キャッシュ ファイルで使用できるディスク容量の割合として定義されます。  <br/> |
|**ComponentThrottleLimit** <br/> |自動調整制限がトリガーされるまでの、コンポーネントが生成できる秒あたりの最大トレース数として定義されます。  <br/> |
|**ComponentThrottleSample** <br/> |ComponentThrottleLimit を超えることができる 60 秒単位の回数。  <br/> |
|**MinimumClsAgentServiceVersion** <br/> |実行が許可されている CLSAgent の最小バージョン。 この要素は、Microsoft 365 または Office 365 を対象とします。  <br/> |
