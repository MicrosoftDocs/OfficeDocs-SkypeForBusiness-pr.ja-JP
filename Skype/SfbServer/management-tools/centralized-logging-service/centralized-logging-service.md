---
title: Skype for Business 2015 の集中ログ サービス
ms.reviewer: ''
ms.author: v-cichur
author: cichur
manager: serdars
ms.date: 2/1/2018
audience: ITPro
ms.topic: article
ms.prod: skype-for-business-itpro
f1.keywords:
- NOCSH
localization_priority: Normal
ms.collection: IT_Skype16
ms.assetid: 975718a0-f3e3-404d-9453-6224e73bfdd0
description: '概要: Skype for Business Server 2015 の集中ログ サービスのサービス コンポーネントと構成設定について説明します。'
ms.openlocfilehash: f4cb47204aa4970e0a86d5f1d556099b52afd07c
ms.sourcegitcommit: c528fad9db719f3fa96dc3fa99332a349cd9d317
ms.translationtype: MT
ms.contentlocale: ja-JP
ms.lasthandoff: 01/12/2021
ms.locfileid: "49835267"
---
# <a name="centralized-logging-service-in-skype-for-business-2015"></a>Skype for Business 2015 の集中ログ サービス
 
**概要:** Skype for Business Server 2015 の集中ログ サービスのサービス コンポーネントと構成設定について説明します。
  
集中ログ サービスでは、次の処理を実行できます。 
  
- 1 つのコマンドを使用して、1 つ以上のコンピューターとプールのログ記録を開始または停止します。
    
- 1 つ以上のコンピューターとプールでログを検索します。 すべてのコンピューター上のすべてのログを返す検索を調整したり、より簡潔な結果を返したりすることができます。
    
- ログ セッションの構成は次のとおりです。
    
  - **シナリオ** を定義するか、既定のシナリオを使用します。 集中ログ サービスのシナリオは、スコープ (グローバルまたはサイト)、シナリオの目的を識別するシナリオ名、および 1 つ以上のプロバイダーで構成されます。 既定のシナリオと定義された 1 つのシナリオは、コンピューター上で任意の時点で実行できます。
    
  - 既存のプロバイダーを使用するか、新しいプロバイダーを作成します。 Aprovider は、ログ セッションが収集する情報、詳細レベル、トレースするコンポーネント、適用されるフラグを定義します。
    
    > [!TIP]
    >  OCSLogger に慣れ親しんだ場合、用語プロバイダーはコンポーネントのコレクション(S4、SIPStack など)、ログの種類 (WPP、EventLog、IIS ログ ファイルなど)、トレース レベル (All、verbose、debug など)、フラグ (TF_COMPONENT、TF_DIAG など) を参照します。  これらのアイテムは、プロバイダー (Windows PowerShell 変数) で定義され、集中ログ サービス コマンドに渡されます。
  
  - 特定のコンピューターとプールのログを構成します。
    
  - オプション Site **(その** サイト内のコンピューターでのみログ キャプチャを実行する場合) または **グローバル** (展開内のすべてのコンピューターでログ キャプチャを実行する場合) から、ログ セッションのスコープを定義します。
    
集中ログ サービスは、根本原因の分析からパフォーマンスの問題まで、大小の問題に対する強力なトラブルシューティング ツールです。 すべての例は、Skype for Business Server 管理シェルを使用して示されています。 ツール自体を使用してコマンド ライン ツールのヘルプが提供されますが、コマンド ラインから実行できる機能のセットは限られています。 Skype for Business Server 管理シェルを使用すると、より大規模で構成可能な一連の機能にアクセスできます。そのため、常に最初の選択になります。 
  
## <a name="logging-service-components"></a>ログ サービス コンポーネント

 集中ログ サービスは展開内のすべてのサーバーで実行され、次のエージェントとサービスで構成されます。
  
- 集中ログ サービス エージェント ClsAgent は、Skype for Business Server が展開されているすべてのコンピューターで実行されます。 TCP **50001 から 50003** のポートで CLsController からのコマンドを WCF でリッスンし、応答をコントローラーに送信します。 ログ セッション (開始/停止/更新) を管理し、ログを検索します。 また、ログのアーカイブや消去などの操作の処理も実行します。 
    
- 集中ログ サービス コントローラーコマンドレット Skype for Business Server 管理シェルは、スタート、停止、フラッシュ、および検索の各コマンドを ClsAgent に送信します。 検索コマンドが送信された場合、結果のログは検索ログにClsControllerLib.dllされ、集計されます。 コントローラーは、エージェントにコマンドを送信し、これらのコマンドの状態を受け取り、検索範囲の任意のコンピューター上のすべてのエージェントから返される検索ログ ファイル データを管理し、ログ データを意味のある順序付き出力セットに集約します。 以下のトピックでは、Skype for Business Server 管理シェルの使用について説明します。
    
**ClsController と ClsAgent の通信**

![CLSController と CLSAgent の関係。](../../media/Ops_CLS_Architecture.jpg)
  
Windows Server コマンドライン インターフェイスまたは Skype for Business Server 管理シェルを使用してコマンドを発行します。 コマンドは、ログインしているコンピューターで実行され、ClsAgent にローカルで、または展開内の他のコンピューターとプールに送信されます。
  
ClsAgent は、すべてのインデックス ファイルを保持します。ローカル コンピューター上の CACHE ファイル。 ClsAgent は、CacheFileLocalFolders オプションで定義されたボリューム間で均等に分散し、各ボリュームの 80% を超える消費を行う (つまり、ローカル キャッシュの場所とパーセンテージは **Set-CsClsConfiguration** コマンドレットを使用して構成可能) ので、割り当ては行います。 ClsAgent は、ローカル コンピューターから古いキャッシュされたイベント トレース ログ (.etl) ファイルを保存することもできます。 2 週間後 (つまり **、Set-CsClsConfiguration** コマンドレットを使用して期間を構成できます)、これらのファイルはファイル共有にコピーされ、ローカル コンピューターから削除されます。 詳細については [、「Set-CsClsConfiguration」を参照してください](https://docs.microsoft.com/powershell/module/skype/set-csclsconfiguration?view=skype-ps)。 検索要求を受信すると、検索条件が使用され、エージェントが保持するインデックスの値に基づいて検索を実行するために、キャッシュされた .etl ファイルのセットが選択されます。
  
> [!NOTE]
> ローカル コンピューターからファイル共有に移動されたファイルは、ClsAgent で検索できます。 ClsAgent がファイルをファイル共有に移動すると、ファイルの保存と削除は ClsAgent によって維持されません。 ファイル共有内のファイルのサイズを監視して削除するか、アーカイブする管理タスクを定義する必要があります。 
  
結果のログ ファイルは **、Snooper.exe** やテキスト ファイルを読み取るツール (Notepad.exeなど) など、さまざまなツールを使用して読み取 **りおよび分析Notepad.exe。** Snooper.exe Skype for Business Server 2015 デバッグ ツールの一部であり、Web ダウンロードとして [利用できます](https://go.microsoft.com/fwlink/p/?LinkId=285257)。
  
OCSLogger と同様に、集中ログ サービスにはトレースするコンポーネントがいくつか含め、フラグを選択するためのオプション (TF_COMPONENT や TF_DIAG など) が提供されています。 集中ログ サービスでは、OCSLogger のログ レベル オプションも保持されます。
  
コマンドライン ClsController よりも Skype for Business Server 管理シェルを使用する最も重要な利点は、問題領域、カスタム フラグ、およびログ 出力レベルを対象とする選択したプロバイダーを使用して、新しいシナリオを構成および定義できる点です。 ClsController で使用できるシナリオは、実行可能ファイルに対して定義されているシナリオに限定されます。
  
以前のバージョンでは、管理者OCSLogger.exeサポート担当者が展開内のコンピューターからトレース ファイルを収集できる機能が提供されています。 OCSLogger は、その長所のすべてについて、欠点があります。 一度に収集できるログは 1 つのコンピューターのみです。 OCSLogger の別々のコピーを使用して複数のコンピューターにログオンできますが、最終的に複数のログが作成され、結果を簡単に集計する方法が得られたりする必要はありません。
  
ユーザーがログ検索を要求すると、ClsController は要求を送信するコンピューター (つまり、選択したシナリオに基づいて) を決定します。 また、保存した .etl ファイルが保存されているファイル共有に検索を送信する必要があるかどうかも決定します。 検索結果が ClsController に返された場合、コントローラーは結果を、ユーザーに表示される 1 つの時間順の結果セットにマージします。 ユーザーは、さらに分析するために、検索結果をローカル コンピューターに保存できます。
  
ログ セッションを開始するときに、解決しようとしている問題に関連するシナリオを指定します。 2 つのシナリオをいつでも実行できます。 これら 2 つのシナリオの 1 つは AlwaysOn シナリオである必要があります。 名前が示すように、すべてのコンピューター、プール、コンポーネントに関する情報を収集して、常に展開で実行する必要があります。
  
> [!IMPORTANT]
> 既定では、AlwaysOn シナリオは展開で実行されません。 シナリオを明示的に開始する必要があります。 起動すると、明示的に停止するまで実行が続行され、コンピューターの再起動によって実行状態が維持されます。 シナリオの開始と停止の詳細については [、「Skype for Business Server 2015](start-or-stop-log-capture.md)での CLS ログ キャプチャの開始または停止」を参照してください。 
  
問題が発生した場合は、報告された問題に関連する 2 つ目のシナリオを開始します。 問題を再現し、2 番目のシナリオのログを停止します。 報告された問題を基準にログ検索を開始します。 ログの集約されたコレクションは、展開のサイトスコープまたはグローバル スコープ内のすべてのコンピューターからのトレース メッセージを含むログ ファイルを生成します。 検索で返されるデータの数が、実行可能な分析よりも多い場合 (一般に、ノイズが大きすぎる信号対ノイズ比と呼ばれる)、より狭いパラメーターを使用して別の検索を実行します。 この時点で、パターンが表示され、問題に明確に焦点を当てるのに役立ちます。 最終的には、いくつかの絞り込み検索を実行した後、問題に関連するデータを見つけ、根本原因を特定できます。
  
> [!TIP]
> Skype for Business Server で問題のシナリオが表示された場合は、まず「問題について既に知っている情報」を確認します。 問題の境界を数値化すると、Skype for Business Server の運用エンティティの大部分を排除できます。 
  
連絡先を検索するときに、ユーザーが現在の結果を取得していないとわかっているシナリオの例を考えます。 メディア コンポーネント、会議、および他の多くのコンポーネントでエンタープライズ VoIPを探す意味はありません。 実際に問題がどこにあるのか、クライアント上にあるのか、それともサーバー側の問題なのかを知らない場合があります。 連絡先は、Active Directory からユーザー レプリケーターによって収集され、アドレス帳サーバー (ABServer) を使用してクライアントに配信されます。 ABServer は、RTC データベース (ユーザー レプリケーターが更新プログラムを書き込んだ場所) から更新を取得し、既定では午前 1 時 30 分にアドレス帳ファイルに収集します。 Skype for Business Server クライアントは、ランダム化されたスケジュールで新しいアドレス帳を取得します。 プロセスのしくみを知っているから、ユーザー レプリケーターによって Active Directory から収集されたデータ、ABServer がアドレス帳ファイルを取得および作成しない、またはアドレス帳ファイルをダウンロードしていないクライアントに関連する問題が発生する可能性がある原因の検索を減らします。
  
## <a name="current-configuration"></a>現在の構成

集中ログ サービスは、ログ サービスが収集する対象、収集方法、収集元、ログ設定を定義するように構成されています。 これらの設定は、グローバル (つまり、展開全体) またはサイト (展開内の名前付きサイト) に対して定義します。 定義するすべてのログで、ログを開始、停止、更新、および検索するコマンドに対して使用する ID に適した設定が使用されます。
  
### <a name="to-display-the-current-centralized-logging-service-configuration"></a>現在の集中ログ サービス構成を表示するには

1. Skype for Business Server 管理シェルを起動します。[スタート] ボタン、[すべてのプログラム] の順にクリックし **、[Skype for Business 2015]** をクリックして **、[Skype for Business Server 管理シェル**] をクリックします。
    
2. コマンド ライン プロンプトで、次のように入力します。
    
   ```PowerShell
   Get-CsClsConfiguration
   ```

    > [!TIP]
    > 戻される構成設定のスコープを絞り込むか展開するには、"Site:Redmond" などのスコープを定義して、サイト Redmond の  `-Identity` CsClsConfiguration のみを返します。 構成の特定の部分に関する詳細が必要な場合は、出力を別の Windows PowerShell コマンドレットにパイプ処理できます。 たとえば、サイト "Redmond" の構成で定義されているシナリオに関する詳細を取得するには、次のように入力します。 `Get-CsClsConfiguration -Identity "site:Redmond" | Select-Object -ExpandProperty Scenarios`
  
     ![Get-CsClsConfiguration からの出力例。](../../media/Ops_Get-CsClsConfiguration_Basic.jpg)
  
    コマンドレットの結果には、集中ログ サービスの現在の構成が表示されます。
    
|**構成設定**|**説明**|
|:-----|:-----|
|**Identity** <br/> |この構成のスコープと名前を識別します。存在するグローバル構成は 1 つのみで、サイトごとに 1 つの構成があります。  <br/> |
|**Scenarios** <br/> |この構成に対して定義されたシナリオの一覧。  <br/> |
|**SearchTerms** <br/> |構成の定義済み検索用語。 Microsoft 365 または Office 365 (オンプレミス展開ではありません)。  <br/> |
|**SecurityGroups** <br/> |コンピューターを確認できるユーザー (つまり、セキュリティ グループのメンバー) を、そのユーザーのサイトに基づいて制御する定義済みセキュリティ グループ。 このコンテキストのサイトは、トポロジ ビルダーで定義されているサイトです。  <br/> |
|**地域** <br/> |SecurityGroups を地域にまとめる際に定義済み地域が使用されます。  <br/> |
|**EtlFileRolloverSizeMB** <br/> |パラメーターは、新しいイベント トレース ログ (.etl) ファイルが作成される前のログ ファイルの最大サイズを示します。定義したサイズに達すると、EtlFileRolloverMinutes で設定された最大時間に達していなくても、新しいログ ファイルが作成されます。  <br/> |
|**EtlFileRolloverMinutes** <br/> |新しい .etl ファイルが作成されるまでのログの定義済み最大経過時間 (分単位)。指定した時間が過ぎると、EtlFileRolloverSizeMBE で設定された最大サイズに達していなくても、新しいログ ファイルが作成されます。  <br/> |
|**TmfFileSearchPath** <br/> |トレース メッセージ形式のファイルを検索する場所。  <br/> |
|**CacheFileLocalFolders** <br/> |キャッシュ ファイルが書き込まれるコンピューター上の場所への定義済みパス。CLSAgent はキャッシュ ファイルを書き込み、ネットワーク サービスとの関連で実行されます。この場合は、%TEMP% が %WINDIR%\ServiceProfiles\NetworkService\AppData\Local に展開されます。既定では、キャッシュ ファイルとログ ファイルは同じディレクトリに書き込まれます。  <br/> |
|**CacheFileNetworkFolder** <br/> |汎用名前付け規則 (UNC) パスを定義すると、ログ操作中にキャッシュ ファイルを受け取ることができます。  <br/> |
|**CacheFileLocalRetentionPeriod** <br/> |キャッシュ ファイルが保持される最大時間 (日単位) として定義されます。  <br/> |
|**CacheFileMaxDiskUsage** <br/> |キャッシュ ファイルで使用できるディスク容量の割合として定義されます。  <br/> |
|**ComponentThrottleLimit** <br/> |自動調整制限がトリガーされるまでの、コンポーネントが生成できる秒あたりの最大トレース数として定義されます。  <br/> |
|**ComponentThrottleSample** <br/> |ComponentThrottleLimit を超えることができる 60 秒単位の回数。  <br/> |
|**MinimumClsAgentServiceVersion** <br/> |実行が許可されている CLSAgent の最小バージョン。 この要素は、Microsoft 365 または Office 365 を対象とします。  <br/> |
   

