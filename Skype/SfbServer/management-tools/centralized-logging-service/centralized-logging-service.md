---
title: Skype for Business 2015 の集中ログサービス
ms.reviewer: ''
ms.author: v-lanac
author: lanachin
manager: serdars
ms.date: 2/1/2018
audience: ITPro
ms.topic: article
ms.prod: skype-for-business-itpro
f1.keywords:
- NOCSH
localization_priority: Normal
ms.collection: IT_Skype16
ms.assetid: 975718a0-f3e3-404d-9453-6224e73bfdd0
description: '概要: Skype for Business Server 2015 の集中ログサービスのサービスコンポーネントと構成設定について説明します。'
ms.openlocfilehash: e65ea3a0a5ed4d86591b630df6d84e436a7efd66
ms.sourcegitcommit: d69bad69ba9a9bca4614d72d8f34fb2a0a9e4dc4
ms.translationtype: MT
ms.contentlocale: ja-JP
ms.lasthandoff: 05/13/2020
ms.locfileid: "44221891"
---
# <a name="centralized-logging-service-in-skype-for-business-2015"></a>Skype for Business 2015 の集中ログサービス
 
**概要:** Skype for Business Server 2015 の集中ログサービスのサービスコンポーネントと構成設定について説明します。
  
集中ログサービスは、次のことを行うことができます。 
  
- 1つのコマンドを中心とした1つのコマンドで、1つ以上のコンピューターおよびプールでログ記録を開始または停止できます。
    
- 1つ以上のコンピューターおよびプールでログを検索します。 すべてのコンピューター上のすべてのログを返すように検索を調整したり、より簡潔な結果を返すことができます。
    
- ログ セッションの構成は次のとおりです。
    
  - **シナリオ**を定義するか、既定のシナリオを使用します。 集中ログサービスのシナリオは、範囲 (グローバルまたはサイト)、シナリオ名、および1つ以上のプロバイダーで構成されます。 既定のシナリオと1つの定義済みのシナリオは、いつでもコンピューター上で実行できます。
    
  - 既存のプロバイダーを使用するか、新しいプロバイダーを作成します。 Aprovider は、ログセッションが収集する内容、詳細レベル、トレースするコンポーネント、適用されるフラグを定義します。
    
    > [!TIP]
    >  OCSLogger を使い慣れている場合、termproviders は**コンポーネント**のコレクション (たとえば、S4、SIPStack)、**ログの種類**(たとえば、WPP、EVENTLOG、または IIS logfile)、**トレースレベル**(たとえば、All、verbose、debug)、**フラグ**(たとえば、TF_COMPONENT、TF_DIAG) を参照します。 これらのアイテムは、プロバイダー (Windows PowerShell 変数) で定義され、集中ログサービスコマンドに渡されます。
  
  - 特定のコンピューターおよびプールのログを構成します。
    
  - オプション**サイト**(そのサイトのコンピューターでログキャプチャを実行する場合) または**グローバル**(展開内のすべてのコンピューターでログキャプチャを実行する場合) のログセッションのスコープを定義します。
    
集中ログサービスは、根本原因の分析からパフォーマンスの問題まで、さまざまな問題のための強力なトラブルシューティングツールです。 すべての例は、Skype for Business Server 管理シェルを使用して表示されます。 ツール自体を使用して、コマンドラインツールのヘルプが提供されますが、コマンドラインから実行できる関数は限られています。 Skype for Business Server 管理シェルを使用すると、非常に多くの機能が構成されているので、常に最初に選択する必要があります。 
  
## <a name="logging-service-components"></a>ログサービスコンポーネント

 集中ログサービスは、展開内のすべてのサーバーで実行され、次のエージェントとサービスで構成されます。
  
- 集中ログサービスエージェント ClsAgent は、Skype for Business Server が展開されているすべてのコンピューターで実行されます。 このメソッドは、WCF 経由の ClsController からのコマンドに対して (ポート**TCP 50001-50003**で) リッスンし、応答をコントローラーに返します。 ログセッション (開始/停止/更新) を管理し、ログを検索します。 また、ログのアーカイブや削除のようなハウスキーピング操作も実行します。 
    
- 集中ログサービスコントローラーコマンドレット Skype for Business Server 管理シェルは、開始、停止、フラッシュ、および検索コマンドを ClsAgent に送信します。 検索コマンドが送信されると、結果のログが Clsコントローラーに返され、集約されます。 コントローラーは、エージェントにコマンドを送信し、そのステータスを受信し、検索範囲内の任意のコンピューター上のすべてのエージェントから返される検索ログファイルデータを管理し、ログデータを意味のある順序付きの出力セットに集約します。 以下のトピックの情報は、Skype for Business Server 管理シェルを使用することに重点を置いています。
    
**ClsController と Clscontroller との通信**

![CLSController と Clscontroller との関係。](../../media/Ops_CLS_Architecture.jpg)
  
コマンドを実行するには、Windows Server コマンドラインインターフェイスを使用するか、Skype for Business Server 管理シェルを使用します。 コマンドは、ログインしているコンピューター上で実行され、ローカルで、または展開内の他のコンピューターとプールに送信されます。
  
ClsAgent は、すべてののインデックスファイルを保持します。ローカルコンピューターにあるキャッシュファイル。 ClsAgent は、オプション CacheFileLocalFolders によって定義されたボリューム間で均等に分散されるように割り当て、各ボリュームの80% を消費しないようにします (つまり、ローカルキャッシュの場所とパーセンテージは、 **Set-CsClsConfiguration**コマンドレットを使用して構成できます)。 ClsAgent は、ローカルコンピューターからの古いキャッシュされたイベントトレースログ (.etl) ファイルのエージングも担います。 2週間後 (つまり、**設定-CsClsConfiguration**コマンドレットを使用してタイムラインを構成できます)、これらのファイルはファイル共有にコピーされ、ローカルコンピューターから削除されます。 詳細については、「 [Set-CsClsConfiguration](https://docs.microsoft.com/powershell/module/skype/set-csclsconfiguration?view=skype-ps)」を参照してください。 検索要求を受信すると、検索条件を使用して、キャッシュされた .etl ファイルのセットを選択し、エージェントが管理するインデックスの値に基づいて検索を実行します。
  
> [!NOTE]
> ローカルコンピューターからファイル共有に移動されたファイルは、ClsAgent で検索できます。 ClsAgent がファイルをファイル共有に移動すると、ファイルのエージングと削除は ClsAgent によって維持されません。 ファイル共有内のファイルのサイズを監視し、それらを削除またはアーカイブする管理タスクを定義する必要があります。 
  
生成されたログファイルは、 **Snooper**や、**メモ帳**などのテキストファイルを読み取ることができるツールなど、さまざまなツールを使用して読み取りおよび分析できます。 Snooper は、Skype for Business Server 2015 デバッグツールの一部であり、 [Web ダウンロード](https://go.microsoft.com/fwlink/p/?LinkId=285257)として使用できます。
  
OCSLogger と同様に、集中ログサービスには、追跡対象となるコンポーネントがいくつかあり、TF_COMPONENT や TF_DIAG などのフラグを選択するオプションが用意されています。 集中ログサービスでは、OCSLogger のログレベルのオプションも保持されます。
  
コマンドラインの ClsController で Skype for Business Server 管理シェルを使用する最も重要な利点は、選択されたプロバイダーを使用して、問題の領域、カスタムフラグ、およびログ出力レベルを対象とする新しいシナリオを構成および定義できることです。 ClsController で使用できるシナリオは、実行可能ファイルに対して定義されているものに限られます。
  
以前のバージョンでは、管理者とサポート担当者が展開内のコンピューターからトレースファイルを収集できるようにするために、OCSLogger が提供されていました。 OCSLogger には、すべての長所を使用した欠点がありました。 ログは、一度に1台のコンピューターでのみ収集できます。 OCSLogger の別のコピーを使用して複数のコンピューターにログオンすることはできますが、最終的には複数のログが作成され、結果を集約する簡単な方法はありません。
  
ユーザーがログ検索を要求すると、ClsController は (選択されたシナリオに基づいて) 要求を送信するコンピューターを決定します。 また、保存された .etl ファイルが配置されているファイル共有に検索を送信する必要があるかどうかを判断します。 検索結果が ClsController に返されると、コントローラーは結果を、ユーザーに提示される1つの時間を指定した結果セットに結合します。 ユーザーは、検索結果をローカルコンピューターに保存して、詳細な分析を行うことができます。
  
ログセッションを開始するときは、解決しようとしている問題に関連するシナリオを指定します。 いつでも2つのシナリオを実行できます。 これら2つのシナリオのいずれか1つは、AlwaysOn シナリオにする必要があります。 その名前が示すように、その名前が展開で常に実行されており、すべてのコンピューター、プール、およびコンポーネントに関する情報が収集されている必要があります。
  
> [!IMPORTANT]
> 既定では、AlwaysOn シナリオは展開で実行されていません。 シナリオを明示的に開始する必要があります。 開始すると、明示的に停止するまで実行が続行され、コンピューターの再起動によって実行状態が維持されます。 シナリオの開始および停止の詳細については、「 [Skype For Business Server 2015 での CLS ログキャプチャの開始または停止](start-or-stop-log-capture.md)」を参照してください。 
  
問題が発生した場合は、報告された問題に関連する2番目のシナリオを開始します。 問題を再現し、2番目のシナリオのログ記録を停止します。 報告された問題に対して、ログの検索を開始します。 集約されたログのコレクションによって、展開のサイト内またはグローバルスコープ内のすべてのコンピューターからのトレースメッセージを含むログファイルが生成されます。 検索によってより多くのデータが返された場合は、可能 analyze (通常は、雑音が多すぎるという信号対雑音比) では、パラメーターを狭くしてもう一度検索を実行します。 この時点で、表示されているパターンを開始することができ、問題により明確に焦点を当てるのに役立ちます。 最終的には、いくつかの改良された検索を実行した後、問題に関連するデータを見つけて、根本原因を特定することができます。
  
> [!TIP]
> Skype for Business Server で問題のシナリオが表示されたら、「問題について既に知っていることは何ですか」という質問をして始めます。 問題の境界を定量化すれば、Skype for Business Server の運用エンティティの大部分をなくすことができます。 
  
ユーザーが連絡先を検索するときに現在の結果を取得していないことがわかっているシナリオ例を考えてみます。 メディアコンポーネント、エンタープライズ Voip、会議、その他の多くのコンポーネントの問題を探すポイントはありません。 実際に問題が発生しているのは、クライアントで、またはサーバー側の問題であることが不明な場合があります。 連絡先は、ユーザーレプリケーターによって Active Directory から収集され、アドレス帳サーバー (ABServer) を介してクライアントに配信されます。 ABServer は、(ユーザーレプリケーターが書き込んだ) RTC データベースから更新を取得し、アドレス帳ファイルに収集します (既定では、1:30 AM)。 Skype for Business Server クライアントは、ランダムなスケジュールで新しいアドレス帳を取得します。 プロセスがどのように機能するかがわかっているので、ユーザーレプリケーターによって Active Directory から収集されたデータに関連する問題、またはアドレス帳ファイルを取得したり作成したりしていない、またはアドレス帳ファイルをダウンロードしていないクライアントで、発生する可能性のある検索を減らすことができます。
  
## <a name="current-configuration"></a>現在の構成

集中ログサービスは、ログサービスが収集する目的、収集方法、収集される場所、およびログ設定について定義するように構成されています。 これらの設定は、グローバルに (つまり、展開全体で)、またはサイト (展開内の名前付きサイト) で定義します。 定義するすべてのログで、ログを開始、停止、更新、および検索するコマンドに対して使用する ID に適した設定が使用されます。
  
### <a name="to-display-the-current-centralized-logging-service-configuration"></a>現在の集中ログサービスの構成を表示するには

1. Skype for Business Server 管理シェルを起動します。 [**スタート**]、[**すべてのプログラム**]、[ **skype for business 2015**] の順にクリックし、[ **skype for business server 管理シェル**] をクリックします。
    
2. コマンド ライン プロンプトで、次のように入力します。
    
   ```PowerShell
   Get-CsClsConfiguration
   ```

    > [!TIP]
    > 定義によって返される構成設定の範囲を絞り込んだり展開したり `-Identity` 、"site: redmond" のようにスコープを展開して、サイト Redmond の CsClsConfiguration のみを取得したりすることができます。 構成の特定の部分に関する詳細が必要な場合は、出力を別の Windows PowerShell コマンドレットにパイプ処理できます。 たとえば、"Redmond" サイトの構成で定義されているシナリオの詳細を取得するには、次のように入力します。`Get-CsClsConfiguration -Identity "site:Redmond" | Select-Object -ExpandProperty Scenarios`
  
     ![Get-CsClsConfiguration からの出力例。](../../media/Ops_Get-CsClsConfiguration_Basic.jpg)
  
    コマンドレットの結果によって、集中ログサービスの現在の構成が表示されます。
    
|**構成設定**|**説明**|
|:-----|:-----|
|**Identity** <br/> |この構成のスコープと名前を識別します。存在するグローバル構成は 1 つのみで、サイトごとに 1 つの構成があります。  <br/> |
|**Scenarios** <br/> |この構成に対して定義されたシナリオの一覧。  <br/> |
|**SearchTerms** <br/> |構成の定義済み検索用語。 Microsoft 365 または Office 365 (社内展開ではない)。  <br/> |
|**Securitygroups まとめる** <br/> |コンピューターを確認できるユーザー (つまり、セキュリティ グループのメンバー) を、そのユーザーのサイトに基づいて制御する定義済みセキュリティ グループ。 このコンテキストのサイトは、トポロジビルダーで定義されているサイトです。  <br/> |
|**地域** <br/> |SecurityGroups を地域にまとめる際に定義済み地域が使用されます。  <br/> |
|**Etlfilerolloversizembe** <br/> |パラメーターは、新しいイベント トレース ログ (.etl) ファイルが作成される前のログ ファイルの最大サイズを示します。定義したサイズに達すると、EtlFileRolloverMinutes で設定された最大時間に達していなくても、新しいログ ファイルが作成されます。  <br/> |
|**EtlFileRolloverMinutes** <br/> |新しい .etl ファイルが作成されるまでのログの定義済み最大経過時間 (分単位)。指定した時間が過ぎると、EtlFileRolloverSizeMBE で設定された最大サイズに達していなくても、新しいログ ファイルが作成されます。  <br/> |
|**TmfFileSearchPath** <br/> |トレース メッセージ形式のファイルを検索する場所。  <br/> |
|**よる cachefilelocalfolders** <br/> |キャッシュ ファイルが書き込まれるコンピューター上の場所への定義済みパス。CLSAgent はキャッシュ ファイルを書き込み、ネットワーク サービスとの関連で実行されます。この場合は、%TEMP% が %WINDIR%\ServiceProfiles\NetworkService\AppData\Local に展開されます。既定では、キャッシュ ファイルとログ ファイルは同じディレクトリに書き込まれます。  <br/> |
|**CacheFileNetworkFolder** <br/> |汎用名前付け規則 (UNC) パスを定義すると、ログ操作中にキャッシュ ファイルを受け取ることができます。  <br/> |
|**CacheFileLocalRetentionPeriod** <br/> |キャッシュ ファイルが保持される最大時間 (日単位) として定義されます。  <br/> |
|**CacheFileMaxDiskUsage** <br/> |キャッシュ ファイルで使用できるディスク容量の割合として定義されます。  <br/> |
|**ComponentThrottleLimit** <br/> |自動調整制限がトリガーされるまでの、コンポーネントが生成できる秒あたりの最大トレース数として定義されます。  <br/> |
|**ComponentThrottleSample** <br/> |ComponentThrottleLimit を超えることができる 60 秒単位の回数。  <br/> |
|**MinimumClsAgentServiceVersion** <br/> |実行が許可されている CLSAgent の最小バージョン。 この要素は、Microsoft 365 または Office 365 を対象としています。  <br/> |
   

